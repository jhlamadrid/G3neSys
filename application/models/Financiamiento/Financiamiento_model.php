<?php
class Financiamiento_model extends CI_MODEL {

    var $oracle;
    function __construct() {
        parent::__construct();
        $this->oracle = $this->load->database('oracle', TRUE);
    }

    public function get_permiso($usuario,$hijo){
        $query = $this->oracle->query("SELECT  DISTINCT ACT.ID_ACTIV,ACT.ACTIVINOMB,ACT.ACTIVIHJO,GRP.MENUGENPDR FROM PRDDBFCOMERCIAL.USER_ROL NR
                                    JOIN PRDDBFCOMERCIAL.ROLES RO ON NR.ID_ROL = RO.ID_ROL
                                    JOIN PRDDBFCOMERCIAL.ROL_ACT ACR ON RO.ID_ROL = ACR.ID_ROL
                                    JOIN PRDDBFCOMERCIAL.ACTIVIDADES ACT ON ACR.ID_ACTIV = ACT.ID_ACTIV
                                    JOIN PRDDBFCOMERCIAL.MENUGEN_ACT ACTG ON ACT.ID_ACTIV = ACTG.ID_ACTIV
                                    JOIN PRDDBFCOMERCIAL.MENUGEN GRP ON ACTG.ID_MENUGEN = GRP.ID_MENUGEN
                                    WHERE NR.NCODIGO = ? AND NR.ESTADO = 1 AND ACR.ESTADO = 1 AND ACTG.ESTADO = 1 AND ACT.ACTIVIHJO = ?",array($usuario,$hijo));
        return $query->row_array();
    }


    public function  obtengo_dato_nombre_tam7($codigo_suministro){
        $grupo = substr($codigo_suministro, 0,3);
        $subGrupo = substr($codigo_suministro, 3,strlen($codigo_suministro));
        $ConsPro = "";
        $ConsPro = $ConsPro . "SELECT CLINOMBRE ";
        $ConsPro = $ConsPro . "FROM PRDCOMCATMEDLEC.PROPIE ";
        $ConsPro = $ConsPro . "WHERE CLICODFAC = '" . $grupo . "0000". $subGrupo . "'";
        $query = $this->oracle->query($ConsPro);
        return $query->result_array();
    }
    public function sum_relacionados($codigo_suministro){
        $grupo = substr($codigo_suministro, 0,3);
        $subGrupo = substr($codigo_suministro, 3,strlen($codigo_suministro));
        $consulta = "SELECT CLICODFAC, CLIGRUCOD, CLIGRUSUB
        FROM PRDCOMCATMEDLEC.CLIENT  
        WHERE CLIGRUCOD = ".$grupo." AND CLIGRUSUB =".$subGrupo;
        $query = $this->oracle->query($consulta);
        return $query->result_array();

    }

    public function get_entidad_publica($codigo_suministro){
        $consulta = "SELECT DEP.*,
        EP.codpoder, EP.CODSECTOR,
        PRDDBFCOMERCIAL.BUSCAR_ENT_PUB(NVL(EP.codpoder,0),  NVL(EP.CODSECTOR,0) ) as EP_EXON_INTCOMP
        FROM PRDDBFCOMERCIAL.detalle_entpub DEP 
            INNER JOIN PRDDBFCOMERCIAL.ENTIDADES_PUBLICAS EP ON DEP.CODENTPUB = EP.CODENTPUB 
        WHERE DEP.SUMINISTRO = '".$codigo_suministro."'";
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }

    public function obtengo_dato_tam7($codigo_suministro){
        $grupo = substr($codigo_suministro, 0,3);
        $subGrupo = substr($codigo_suministro, 3,strlen($codigo_suministro));
        $ConsCat = '';
        $ConsCat = $ConsCat . "SELECT CLIENT.CLICODFAC, TRIM(PROPIE.CLINOMBRE) AS NOMBRE, ";
        $ConsCat = $ConsCat . " TRIM(TRIM(SUBSTR(LOCALI.LOCDES,6,60)) || ' - ' || TRIM(RLURBA.URBDES) || ' ' || TRIM(RLCALL.CALDES) || ' ' || TRIM(PREDIO.PREMUNI)) AS DIRECCION, ";
        $ConsCat = $ConsCat . " NVL(PROPIE.CLIELECT,' ') AS DNI, NVL(PROPIE.CLIRUC,' ') AS RUC, PROPIE.CONTRA AS CONTRATO, PROPIE.TARIFA, PROPIE.CODCATTAR, TARIFA.DESCATTAR AS CATEGTARIF, REGLOC.REGDES, PREDIO.PREREGION,";
        $ConsCat = $ConsCat . " PREDIO.PREZONA, PREDIO.PRESECTOR, PREDIO.PREMZN, PREDIO.PRELOTE, CLIENT.CLICODID, CLIENT.CLICODIGO, PREDIO.MANZANAOK, PREDIO.LOTEOK, ";
        $ConsCat = $ConsCat . " PREDIO.SECCEN, PREDIO.MANZCEN, LOCALI.AMBCOD,PREDIO.LOTECEN, PREDIO.PRELOCALI, LOCALI.LOCDES AS LOCALIDAD, PREDIO.PREURBA, RLURBA.URBDES AS URBANIZACION, PREDIO.PRECALLE, ";
        $ConsCat = $ConsCat . " RLCALL.CALDES AS CALLE, PREDIO.PREMUNI AS NUMMUNICIPAL, PREDIO.FACCICCOD AS CICLO, PREDIO.PREFRONT AS FRONTERA, PREDIO.PREINMPIS AS NROPISOS, PREDIO.PRECLINRO AS NROCLIE, ";
        $ConsCat = $ConsCat . " CLIENT.CLIPERSNO AS NROPERSON, PREDIO.CODESTPRE, ESTPRE.DESESTPRE AS ESTADOPREDIO, PREDIO.CODTIPINM, TIPINM.DESTIPINM AS TIPOINMUEBLE, PREDIO.CODTIPRES, ";
        $ConsCat = $ConsCat . " RESEVO.DESTIPRES AS TIPOALMAC, PREDIO.CODMATCON, MATCON.DESMATCON AS MATCONSTRUC, PREDIO.PISCINCOD, PISCIN.PISCONDES AS PISCINA, PREDIO.CLLPAVCOD, TPAVIM.PAVDESC AS TIPOPAVIM, ";
        $ConsCat = $ConsCat . " PREDIO.VDAMATCOD, MATVER.DESMATVER AS MATERVEREDA, PREDIO.PREREDAGU AS PASAAGUA, PREDIO.PREREDDES AS PASADESG, PREDIO.PRECONAGU AS NROCNXAG, ";
        $ConsCat = $ConsCat . " PREDIO.PRECONDES AS NROCNXDSG, COAGUA.CONESTADO, ESTCON.CONESTDES AS ESTADOCONXAG, CLIENT.INMUSOCOD, USOINM.INMUSODES AS USOINMUEB, CLIENT.CLIGRUCOD AS GRUPO, ";
        $ConsCat = $ConsCat . " CLIENT.CLIGRUSUB AS SUBGRUPO, CLIENT.CODSCATTA AS SUBCATEGORIA, CLIENT.CIRPROY AS CIRCUITPROY, CLIENT.CEMVOLCONA AS CLASE, CLIENT.FECCEN, CLIENT.CODESCLTE , ESCLTE.DESESCLTE AS ESTADOCLI, ";
        $ConsCat = $ConsCat . " CLIENT.CODTIPSER, TIPSER.DESTIPSER AS TIPOSERVICIO, CLIENT.CODTIPTEN, TIPTEN.DESTIPTEN AS TIPOTENENCIA, CLIENT.CODABASAG, TABSAG.DESABASAG AS ABASTECAGUA, CLIENT.CODABASDE, ";
        $ConsCat = $ConsCat . " TABSDE.DESABASDE AS ABASTECDSG, NVL(COAGUA.CONCAJA,0) AS CONCAJA, COAGUA.CONCODTIP, COAGUA.CONCODIGO, COAGUA.NIVPRES, COAGUA.CONDIACOD, DICOAG.CONDIADES AS DIAMCNXAGUA, ";
        $ConsCat = $ConsCat . " COAGUA.CNAMATCOD, TMCXAG.CNAMATDES AS MATERCONXAGUA, COAGUA.AGUTABCOD, TBPCJA.AGUTABDES AS MATERTAPAAGUA, COAGUA.ESTTAPCOD, TBTPST.ESTTAPDES AS ESTADOTAPAGUA, COAGUA.CONUBICAJ, ";
        $ConsCat = $ConsCat . " UBIMED.UBICAJDES AS UBICAJAAGUA, COAGUA.CONCAJMAT, MATCJA.CONCAJDES AS MATERCAJAAGUA, COAGUA.CAJESTCOD AS CODESTCAJAG, ESCJAG.CAJESTDES AS ESTCAJAG, COAGUA.CONENTEJX, EJECCNXAGUA.ENTEEJEAGUDES, ";
        $ConsCat = $ConsCat . " COAGUA.CONCIRCUI, COAGUA.ACONTRATO, COAGUA.MEDCODIGO AS CORRMEDIDOR, MEDIDO.MEDCODYGO AS MEDIDOR, MEDIDO.MEDFECINS, MEDIDO.DIAMEDCOD, ";
        $ConsCat = $ConsCat . " TRIM(DICOAGMED.DIAMEDDES) || ' " . '"' . "' AS DIAMEDIDOR, MEDIDO.MEDESTCOD, ESMEDI.MESESTDES, MEDIDO.MEDTIPCODX, TIPMED.MEDTIPDES, MEDIDO.MEDMARCODX, ";
        $ConsCat = $ConsCat . " TMARMED.MAMDES, MEDIDO.MEDMODCODX, TMARMEDLEVEL1.MOMDES, MEDIDO.MEDFECFAC, MEDIDO.MEDFECRET, MEDIDO.MEDFECREG, MEDIDO.MEDLLACOD, ";
        $ConsCat = $ConsCat . " MEDIDO.MEDCONCOD, TMEDCONDICION.MEDCONDES, NVL(CODESA.CONDCAJA,0) AS CONDCAJA, CODESA.CONDESTAD, ESTCONDE.CONDESDES, CODESA.CONDIDCOD, ";
        $ConsCat = $ConsCat . " DICODE.CONDIDDES, CODESA.DCONTRATO, CODESA.CONCODTDE, CODESA.CONCODDES, CODESA.CONDENTEJX, CODESA.CAJESTCOD AS CODESTCAJDSG, ESCJAG.CAJESTDES AS ESTCAJDSG, ";
        $ConsCat = $ConsCat . " CODESA.CAJMATCOD, MATCJADE.CAJMATDES, CODESA.CONDUBICA, UBIMEDDES.CONDUBIDES, CODESA.DESTAPCOD, TBPCJAD.DESTAPDES, ";
        $ConsCat = $ConsCat . " CODESA.STDTAPCOD, TBTPSTDES.STDTAPDES, CLIENT.PORTARIFA, CLIENT.ORDENRL, CLIENT.CARGARL, PROPIE.CARGARD, PROPIE.ORDENRD, ";
        $ConsCat = $ConsCat . " CODESA.DCONFECFIR, CODESA.CODFECING, ENTEJE.ENTEJEDES, PROVIN.PROVINDES, ZONASEC.ZONASECSRV, ";
        $ConsCat = $ConsCat . " TO_CHAR(SYSDATE, 'DD/MM/YYYY') AS FECHAPROCESO, TO_CHAR(SYSDATE, 'HH24:MI:SS') AS HORAPROCESO ";
        $ConsCat = $ConsCat . "FROM PRDCOMCATMEDLEC.PREDIO " ;
        $ConsCat = $ConsCat . " INNER JOIN PRDCOMCATMEDLEC.CLIENT ON (PREDIO.PREREGION = CLIENT.PREREGION) AND (PREDIO.PREZONA = CLIENT.PREZONA) AND (PREDIO.PRESECTOR = CLIENT.PRESECTOR) AND (PREDIO.PREMZN = CLIENT.PREMZN) AND (PREDIO.PRELOTE = CLIENT.PRELOTE) ";
        $ConsCat = $ConsCat . " AND CLIENT.CLIGRUCOD = " . $grupo . "AND CLIENT.CLIGRUSUB = " . $subGrupo. " ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.COAGUA ON (PREDIO.PREREGION = COAGUA.PREREGION) AND (PREDIO.PREZONA = COAGUA.PREZONA) AND (PREDIO.PRESECTOR = COAGUA.PRESECTOR) AND (PREDIO.PREMZN = COAGUA.PREMZN) AND (PREDIO.PRELOTE = COAGUA.PRELOTE) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.ZONASEC ON (ZONASEC.PREREGION = PREDIO.PREREGION) AND (ZONASEC.PREZONA = PREDIO.PREZONA) AND (ZONASEC.PRESECTOR = PREDIO.PRESECTOR) AND (ZONASEC.PRELOCALI = PREDIO.PRELOCALI) ";
        $ConsCat = $ConsCat . " INNER JOIN PRDCOMCATMEDLEC.RLURBA ON (RLURBA.PREREGION = PREDIO.PREREGION) AND (RLURBA.PRELOCALI = PREDIO.PRELOCALI) AND (RLURBA.PREURBA = PREDIO.PREURBA) ";
        $ConsCat = $ConsCat . " INNER JOIN PRDCOMCATMEDLEC.RLCALL ON (RLCALL.PREREGION = PREDIO.PREREGION) AND (RLCALL.PRELOCALI = PREDIO.PRELOCALI) AND (RLCALL.PRECALLE = PREDIO.PRECALLE) ";
        $ConsCat = $ConsCat . " INNER JOIN PRDCOMCATMEDLEC.LOCALI ON (LOCALI.PREREGION = PREDIO.PREREGION) AND (LOCALI.PRELOCALI = PREDIO.PRELOCALI) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.CODESA ON (PREDIO.PREREGION = CODESA.PREREGION) AND (PREDIO.PREZONA = CODESA.PREZONA) AND (PREDIO.PRESECTOR = CODESA.PRESECTOR) AND (PREDIO.PREMZN = CODESA.PREMZN) AND (PREDIO.PRELOTE = CODESA.PRELOTE) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.ESTPRE ON (ESTPRE.CODESTPRE = PREDIO.CODESTPRE) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.MATCON ON (MATCON.CODMATCON = PREDIO.CODMATCON) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.MATVER ON (CODMATVER = VDAMATCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.PISCIN ON (PISCIN.PISCINCOD = PREDIO.PISCINCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.PROVIN ON (PROVINCOD = PREPROVIN) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.RESEVO ON (RESEVO.CODTIPRES = PREDIO.CODTIPRES) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TIPINM ON (TIPINM.CODTIPINM = PREDIO.CODTIPINM) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TPAVIM ON (PAVICOD = CLLPAVCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.ENTEJE ON (ENTEJE.CONDENTEJX = CODESA.CONDENTEJX) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.ESCJAG ON (ESCJAG.CAJESTCOD = CODESA.CAJESTCOD) AND (ESCJAG.CAJESTCOD = COAGUA.CAJESTCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.MEDIDO ON (MEDIDO.MEDCODIGO = COAGUA.MEDCODIGO) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.DICOAGMED ON (DICOAGMED.DIAMEDCOD = MEDIDO.DIAMEDCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.ESMEDI ON (ESMEDI.MEDESTCOD = MEDIDO.MEDESTCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TIPMED ON (TIPMED.MEDTIPCODX = MEDIDO.MEDTIPCODX) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TMEDCONDICION ON (TMEDCONDICION.MEDCONCOD = MEDIDO.MEDCONCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.MMEDIDORFAB ON (MMEDIDORFAB.MEDCODYGO = MEDIDO.MEDCODYGO) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TMARMED ON (TMARMED.MAMCOD = MMEDIDORFAB.MAMCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TMARMEDLEVEL1 ON (TMARMEDLEVEL1.MAMCOD = MMEDIDORFAB.MAMCOD) AND (TMARMEDLEVEL1.MOMCOD = MMEDIDORFAB.MOMCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.DICOAG ON (DICOAG.CONDIACOD = COAGUA.CONDIACOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.EJECCNXAGUA ON (EJECCNXAGUA.CONENTEJX = COAGUA.CONENTEJX) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.ESTCON ON (ESTCON.CONESTADO = COAGUA.CONESTADO) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.MATCJA ON (MATCJA.CONCAJMAT = COAGUA.CONCAJMAT) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TBPCJA ON (TBPCJA.AGUTABCOD = COAGUA.AGUTABCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TBTPST ON (TBTPST.ESTTAPCOD = COAGUA.ESTTAPCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TMCXAG ON (TMCXAG.CNAMATCOD = COAGUA.CNAMATCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.UBIMED ON (UBIMED.CONUBICAJ = COAGUA.CONUBICAJ) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.ESTCONDE ON (ESTCONDE.CONDESTAD = CODESA.CONDESTAD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.MATCJADE ON (MATCJADE.CAJMATCOD = CODESA.CAJMATCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TBPCJAD ON (TBPCJAD.DESTAPCOD = CODESA.DESTAPCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TBTPSTDES ON (TBTPSTDES.STDTAPCOD = CODESA.STDTAPCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.UBIMEDDES ON (UBIMEDDES.CONDUBICA = CODESA.CONDUBICA) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.DICODE ON (DICODE.CONDIDCOD = CODESA.CONDIDCOD) ";
        $ConsCat = $ConsCat . " INNER JOIN PRDCOMCATMEDLEC.PROPIE ON (CLIENT.CLICODFAC = PROPIE.CLICODFAC) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.REGLOC ON (REGLOC.PREREGION = PROPIE.PREREGION) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TARIFA ON (TARIFA.CODCATTAR = PROPIE.CODCATTAR) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.ESCLTE ON (ESCLTE.CODESCLTE = CLIENT.CODESCLTE) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TABSAG ON (TABSAG.CODABASAG = CLIENT.CODABASAG) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TABSDE ON (TABSDE.CODABASDE = CLIENT.CODABASDE) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TIPSER ON (TIPSER.CODTIPSER = CLIENT.CODTIPSER) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TIPTEN ON (TIPTEN.CODTIPTEN = CLIENT.CODTIPTEN) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.USOINM ON (USOINM.INMUSOCOD = CLIENT.INMUSOCOD) ";
        $ConsCat = $ConsCat . "ORDER BY PREDIO.PREREGION, PREDIO.PREZONA, PREDIO.PRESECTOR, PREDIO.PREMZN, PREDIO.PRELOTE, CLIENT.CLICODID, CLIENT.CLICODIGO ";
        $query = $this->oracle->query($ConsCat);
        return $query->result_array();
    }

    public function obtengo_dato_tam11($codigo_suministro){
        /*
        $ConsCat = '';
        $ConsCat = $ConsCat . "SELECT CLIENT.CLICODFAC, TRIM(PROPIE.CLINOMBRE) AS NOMBRE, ";
        $ConsCat = $ConsCat . " TRIM(TRIM(SUBSTR(LOCALI.LOCDES,6,60)) || ' - ' || TRIM(RLURBA.URBDES) || ' ' || TRIM(RLCALL.CALDES) || ' ' || TRIM(PREDIO.PREMUNI)) AS DIRECCION, ";
        $ConsCat = $ConsCat . " NVL(PROPIE.CLIELECT,' ') AS DNI, NVL(PROPIE.CLIRUC,' ') AS RUC, PROPIE.CONTRA AS CONTRATO, PROPIE.TARIFA, PROPIE.CODCATTAR, TARIFA.DESCATTAR AS CATEGTARIF, REGLOC.REGDES, PREDIO.PREREGION, ";
        $ConsCat = $ConsCat . " PREDIO.PREZONA, PREDIO.PRESECTOR, PREDIO.PREMZN, PREDIO.PRELOTE, CLIENT.CLICODID, CLIENT.CLICODIGO, PREDIO.MANZANAOK, PREDIO.LOTEOK, ";
        $ConsCat = $ConsCat . " PREDIO.SECCEN, PREDIO.MANZCEN,LOCALI.AMBCOD, PREDIO.LOTECEN, PREDIO.PRELOCALI, LOCALI.LOCDES AS LOCALIDAD, PREDIO.PREURBA, RLURBA.URBDES AS URBANIZACION, PREDIO.PRECALLE, ";
        $ConsCat = $ConsCat . " RLCALL.CALDES AS CALLE, PREDIO.PREMUNI AS NUMMUNICIPAL, PREDIO.FACCICCOD AS CICLO, PREDIO.PREFRONT AS FRONTERA, PREDIO.PREINMPIS AS NROPISOS, PREDIO.PRECLINRO AS NROCLIE, ";
        $ConsCat = $ConsCat . " CLIENT.CLIPERSNO AS NROPERSON, PREDIO.CODESTPRE, ESTPRE.DESESTPRE AS ESTADOPREDIO, PREDIO.CODTIPINM, TIPINM.DESTIPINM AS TIPOINMUEBLE, PREDIO.CODTIPRES, ";
        $ConsCat = $ConsCat . " RESEVO.DESTIPRES AS TIPOALMAC, PREDIO.CODMATCON, MATCON.DESMATCON AS MATCONSTRUC, PREDIO.PISCINCOD, PISCIN.PISCONDES AS PISCINA, PREDIO.CLLPAVCOD, TPAVIM.PAVDESC AS TIPOPAVIM, ";
        $ConsCat = $ConsCat . " PREDIO.VDAMATCOD, MATVER.DESMATVER AS MATERVEREDA, PREDIO.PREREDAGU AS PASAAGUA, PREDIO.PREREDDES AS PASADESG, PREDIO.PRECONAGU AS NROCNXAG, ";
        $ConsCat = $ConsCat . " PREDIO.PRECONDES AS NROCNXDSG, COAGUA.CONESTADO, ESTCON.CONESTDES AS ESTADOCONXAG, CLIENT.INMUSOCOD, USOINM.INMUSODES AS USOINMUEB, CLIENT.CLIGRUCOD AS GRUPO, ";
        $ConsCat = $ConsCat . " CLIENT.CLIGRUSUB AS SUBGRUPO, CLIENT.CODSCATTA AS SUBCATEGORIA, CLIENT.CIRPROY AS CIRCUITPROY, CLIENT.CEMVOLCONA AS CLASE, CLIENT.FECCEN, CLIENT.CODESCLTE , ESCLTE.DESESCLTE AS ESTADOCLI, ";
        $ConsCat = $ConsCat . " CLIENT.CODTIPSER, TIPSER.DESTIPSER AS TIPOSERVICIO, CLIENT.CODTIPTEN, TIPTEN.DESTIPTEN AS TIPOTENENCIA, CLIENT.CODABASAG, TABSAG.DESABASAG AS ABASTECAGUA, CLIENT.CODABASDE, ";
        $ConsCat = $ConsCat . " TABSDE.DESABASDE AS ABASTECDSG, NVL(COAGUA.CONCAJA,0) AS CONCAJA, COAGUA.CONCODTIP, COAGUA.CONCODIGO, COAGUA.NIVPRES, COAGUA.CONDIACOD, DICOAG.CONDIADES AS DIAMCNXAGUA, ";
        $ConsCat = $ConsCat . " COAGUA.CNAMATCOD, TMCXAG.CNAMATDES AS MATERCONXAGUA, COAGUA.AGUTABCOD, TBPCJA.AGUTABDES AS MATERTAPAAGUA, COAGUA.ESTTAPCOD, TBTPST.ESTTAPDES AS ESTADOTAPAGUA, COAGUA.CONUBICAJ, ";
        $ConsCat = $ConsCat . " UBIMED.UBICAJDES AS UBICAJAAGUA, COAGUA.CONCAJMAT, MATCJA.CONCAJDES AS MATERCAJAAGUA, COAGUA.CAJESTCOD AS CODESTCAJAG, ESCJAG.CAJESTDES AS ESTCAJAG, COAGUA.CONENTEJX, EJECCNXAGUA.ENTEEJEAGUDES, ";
        $ConsCat = $ConsCat . " COAGUA.CONCIRCUI, COAGUA.ACONTRATO, COAGUA.MEDCODIGO AS CORRMEDIDOR, MEDIDO.MEDCODYGO AS MEDIDOR, MEDIDO.MEDFECINS, MEDIDO.DIAMEDCOD, ";
        $ConsCat = $ConsCat . " TRIM(DICOAGMED.DIAMEDDES) || ' " . '"' . "' AS DIAMEDIDOR, MEDIDO.MEDESTCOD, ESMEDI.MESESTDES, MEDIDO.MEDTIPCODX, TIPMED.MEDTIPDES, MEDIDO.MEDMARCODX, ";
        $ConsCat = $ConsCat . " TMARMED.MAMDES, MEDIDO.MEDMODCODX, TMARMEDLEVEL1.MOMDES, MEDIDO.MEDFECFAC, MEDIDO.MEDFECRET, MEDIDO.MEDFECREG, MEDIDO.MEDLLACOD, ";
        $ConsCat = $ConsCat . " MEDIDO.MEDCONCOD, TMEDCONDICION.MEDCONDES, NVL(CODESA.CONDCAJA,0) AS CONDCAJA, CODESA.CONDESTAD, ESTCONDE.CONDESDES, CODESA.CONDIDCOD, ";
        $ConsCat = $ConsCat . " DICODE.CONDIDDES, CODESA.DCONTRATO, CODESA.CONCODTDE, CODESA.CONCODDES, CODESA.CONDENTEJX, CODESA.CAJESTCOD AS CODESTCAJDSG, ESCJAG.CAJESTDES AS ESTCAJDSG, ";
        $ConsCat = $ConsCat . " CODESA.CAJMATCOD, MATCJADE.CAJMATDES, CODESA.CONDUBICA, UBIMEDDES.CONDUBIDES, CODESA.DESTAPCOD, TBPCJAD.DESTAPDES, ";
        $ConsCat = $ConsCat . " CODESA.STDTAPCOD, TBTPSTDES.STDTAPDES, CLIENT.PORTARIFA, CLIENT.ORDENRL, CLIENT.CARGARL, PROPIE.CARGARD, PROPIE.ORDENRD, ";
        $ConsCat = $ConsCat . " CODESA.DCONFECFIR, CODESA.CODFECING, ENTEJE.ENTEJEDES, PROVIN.PROVINDES, ZONASEC.ZONASECSRV, ";
        $ConsCat = $ConsCat . " TO_CHAR(SYSDATE, 'DD/MM/YYYY') AS FECHAPROCESO, TO_CHAR(SYSDATE, 'HH24:MI:SS') AS HORAPROCESO ";
        $ConsCat = $ConsCat . "FROM PRDCOMCATMEDLEC.PREDIO ";
        $ConsCat = $ConsCat . " INNER JOIN PRDCOMCATMEDLEC.CLIENT ON (PREDIO.PREREGION = CLIENT.PREREGION) AND (PREDIO.PREZONA = CLIENT.PREZONA) AND (PREDIO.PRESECTOR = CLIENT.PRESECTOR) AND (PREDIO.PREMZN = CLIENT.PREMZN) AND (PREDIO.PRELOTE = CLIENT.PRELOTE) ";
        $ConsCat = $ConsCat . " AND CLIENT.CLICODFAC = '" . $codigo_suministro. "' ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.COAGUA ON (PREDIO.PREREGION = COAGUA.PREREGION) AND (PREDIO.PREZONA = COAGUA.PREZONA) AND (PREDIO.PRESECTOR = COAGUA.PRESECTOR) AND (PREDIO.PREMZN = COAGUA.PREMZN) AND (PREDIO.PRELOTE = COAGUA.PRELOTE) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.ZONASEC ON (ZONASEC.PREREGION = PREDIO.PREREGION) AND (ZONASEC.PREZONA = PREDIO.PREZONA) AND (ZONASEC.PRESECTOR = PREDIO.PRESECTOR) AND (ZONASEC.PRELOCALI = PREDIO.PRELOCALI) ";
        $ConsCat = $ConsCat . " INNER JOIN PRDCOMCATMEDLEC.RLURBA ON (RLURBA.PREREGION = PREDIO.PREREGION) AND (RLURBA.PRELOCALI = PREDIO.PRELOCALI) AND (RLURBA.PREURBA = PREDIO.PREURBA) ";
        $ConsCat = $ConsCat . " INNER JOIN PRDCOMCATMEDLEC.RLCALL ON (RLCALL.PREREGION = PREDIO.PREREGION) AND (RLCALL.PRELOCALI = PREDIO.PRELOCALI) AND (RLCALL.PRECALLE = PREDIO.PRECALLE) ";
        $ConsCat = $ConsCat . " INNER JOIN PRDCOMCATMEDLEC.LOCALI ON (LOCALI.PREREGION = PREDIO.PREREGION) AND (LOCALI.PRELOCALI = PREDIO.PRELOCALI) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.CODESA ON (PREDIO.PREREGION = CODESA.PREREGION) AND (PREDIO.PREZONA = CODESA.PREZONA) AND (PREDIO.PRESECTOR = CODESA.PRESECTOR) AND (PREDIO.PREMZN = CODESA.PREMZN) AND (PREDIO.PRELOTE = CODESA.PRELOTE) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.ESTPRE ON (ESTPRE.CODESTPRE = PREDIO.CODESTPRE) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.MATCON ON (MATCON.CODMATCON = PREDIO.CODMATCON) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.MATVER ON (CODMATVER = VDAMATCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.PISCIN ON (PISCIN.PISCINCOD = PREDIO.PISCINCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.PROVIN ON (PROVINCOD = PREPROVIN) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.RESEVO ON (RESEVO.CODTIPRES = PREDIO.CODTIPRES) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TIPINM ON (TIPINM.CODTIPINM = PREDIO.CODTIPINM) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TPAVIM ON (PAVICOD = CLLPAVCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.ENTEJE ON (ENTEJE.CONDENTEJX = CODESA.CONDENTEJX) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.ESCJAG ON (ESCJAG.CAJESTCOD = CODESA.CAJESTCOD) AND (ESCJAG.CAJESTCOD = COAGUA.CAJESTCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.MEDIDO ON (MEDIDO.MEDCODIGO = COAGUA.MEDCODIGO) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.DICOAGMED ON (DICOAGMED.DIAMEDCOD = MEDIDO.DIAMEDCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.ESMEDI ON (ESMEDI.MEDESTCOD = MEDIDO.MEDESTCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TIPMED ON (TIPMED.MEDTIPCODX = MEDIDO.MEDTIPCODX) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TMEDCONDICION ON (TMEDCONDICION.MEDCONCOD = MEDIDO.MEDCONCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.MMEDIDORFAB ON (MMEDIDORFAB.MEDCODYGO = MEDIDO.MEDCODYGO) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TMARMED ON (TMARMED.MAMCOD = MMEDIDORFAB.MAMCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TMARMEDLEVEL1 ON (TMARMEDLEVEL1.MAMCOD = MMEDIDORFAB.MAMCOD) AND (TMARMEDLEVEL1.MOMCOD = MMEDIDORFAB.MOMCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.DICOAG ON (DICOAG.CONDIACOD = COAGUA.CONDIACOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.EJECCNXAGUA ON (EJECCNXAGUA.CONENTEJX = COAGUA.CONENTEJX) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.ESTCON ON (ESTCON.CONESTADO = COAGUA.CONESTADO) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.MATCJA ON (MATCJA.CONCAJMAT = COAGUA.CONCAJMAT) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TBPCJA ON (TBPCJA.AGUTABCOD = COAGUA.AGUTABCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TBTPST ON (TBTPST.ESTTAPCOD = COAGUA.ESTTAPCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TMCXAG ON (TMCXAG.CNAMATCOD = COAGUA.CNAMATCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.UBIMED ON (UBIMED.CONUBICAJ = COAGUA.CONUBICAJ) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.ESTCONDE ON (ESTCONDE.CONDESTAD = CODESA.CONDESTAD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.MATCJADE ON (MATCJADE.CAJMATCOD = CODESA.CAJMATCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TBPCJAD ON (TBPCJAD.DESTAPCOD = CODESA.DESTAPCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TBTPSTDES ON (TBTPSTDES.STDTAPCOD = CODESA.STDTAPCOD) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.UBIMEDDES ON (UBIMEDDES.CONDUBICA = CODESA.CONDUBICA) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.DICODE ON (DICODE.CONDIDCOD = CODESA.CONDIDCOD) ";
        $ConsCat = $ConsCat . " INNER JOIN PRDCOMCATMEDLEC.PROPIE ON (CLIENT.CLICODFAC = PROPIE.CLICODFAC) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.REGLOC ON (REGLOC.PREREGION = PROPIE.PREREGION) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TARIFA ON (TARIFA.CODCATTAR = PROPIE.CODCATTAR) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.ESCLTE ON (ESCLTE.CODESCLTE = CLIENT.CODESCLTE) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TABSAG ON (TABSAG.CODABASAG = CLIENT.CODABASAG) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TABSDE ON (TABSDE.CODABASDE = CLIENT.CODABASDE) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TIPSER ON (TIPSER.CODTIPSER = CLIENT.CODTIPSER) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.TIPTEN ON (TIPTEN.CODTIPTEN = CLIENT.CODTIPTEN) ";
        $ConsCat = $ConsCat . " LEFT OUTER JOIN PRDCOMCATMEDLEC.USOINM ON (USOINM.INMUSOCOD = CLIENT.INMUSOCOD) ";
        $ConsCat = $ConsCat . "ORDER BY PREDIO.PREREGION, PREDIO.PREZONA, PREDIO.PRESECTOR, PREDIO.PREMZN, PREDIO.PRELOTE, CLIENT.CLICODID, CLIENT.CLICODIGO ";
        */
        $ConsCat = "SELECT * FROM PRDCOMCATMEDLEC.EMERSON WHERE CLICODFAC =".$codigo_suministro;
        $query = $this->oracle->query($ConsCat);
        return $query->result_array();
    }
    public function obtengo_deuda($codigo_suministro){
        
        /*$consulta = "SELECT /*+ NO_CPU_COSTING */  /* FACSERNRO, 
                        FACNRO, 
                        FACEMIFEC, 
                        FACVENFEC, 
                        CASE WHEN FLOOR(SYSDATE - FACVENFEC) <= 0 THEN 0 
                        ELSE FLOOR(SYSDATE - FACVENFEC) END AS DIASVENCID, 
                        CLICODFAX, 
                        FACTOTSUB, 
                        FACIGV, 
                        FACTOTAL, 
                        NVL(NOTA.NC, 0000000000.00) AS NC, 
                        NVL(NOTA.ND, 0000000000.00) AS ND, 
                        CASE WHEN FACTOTAL + NVL(NOTA.NC, 0000000000.00) + NVL(NOTA.ND, 0000000000.00) <= 0 THEN 000000000000.00 
                        ELSE FACTOTAL + NVL(NOTA.NC, 0000000000.00) + NVL(NOTA.ND, 0000000000.00) END AS IMPREAL, 
                        TM1.TAMACU, 
                        TM2.TAMTASA AS TAMMESANT, 
                        ROUND(POWER(1 + NVL(TM2.TAMTASA, 0) / 100, 1 / 30) - 1, 5) AS FACTOINT, 
                        CASE WHEN FACTOTAL + NVL(NOTA.NC, 0000000000.00) + NVL(NOTA.ND, 0000000000.00) <= 0 THEN 000000000000.00 
                        ELSE ROUND((FACTOTAL + NVL(NOTA.NC, 0000000000.00) + NVL(NOTA.ND, 0000000000.00)) * NVL(TM1.TAMACU, 0), 2) END AS IntMora, 
                        CASE WHEN FACTOTAL + NVL(NOTA.NC, 0000000000.00) + NVL(NOTA.ND, 0000000000.00) <= 0 THEN 000000000000.00 
                        ELSE ROUND((FACTOTAL + NVL(NOTA.NC, 0000000000.00) + NVL(NOTA.ND, 0000000000.00)) * (SELECT TO_NUMBER(DATPAR, '99.99') 
                        FROM PRDDBFCOMERCIAL.MAEPAR 
                        WHERE CODPAR = 'IMPORTEGASTOCOB'), 
                        2) END AS GASTOCOBRANZA, 
                        FACESTADO, 
                        FIGVREF 
                        FROM PRDDBFCOMERCIAL.TOTFAC 
                        LEFT JOIN PRDDBFCOMERCIAL.TAMN TM1 
                        ON TOTFAC.FACVENFEC + 1 = TM1.TAMFEC 
                        LEFT JOIN PRDDBFCOMERCIAL.TAMN TM2 
                        ON ADD_MONTHS (TOTFAC.FACVENFEC, - 1) = TM2.TAMFEC 
                        LEFT JOIN (SELECT SERIEREC, 
                        NROREC, 
                        SUM(NC) AS NC, 
                        SUM(ND) AS ND 
                        FROM (SELECT NCA.TOTFAC_FACSERNRO AS SERIEREC, 
                        NCA.TOTFAC_FACNRO AS NROREC, 
                        CASE WHEN NCA.NCATIPO = 'A' THEN SUM(NCA.NCATOTDIF * -1) END AS NC, 
                        CASE WHEN NCA.NCATIPO = 'C' THEN SUM(NCA.NCATOTDIF) END AS ND, 
                        COUNT(*) AS CANTI 
                        FROM PRDDBFCOMERCIAL.NCA 
                        INNER JOIN PRDDBFCOMERCIAL.TOTFAC TT 
                        ON NCA.TOTFAC_FACSERNRO = TT.FACSERNRO 
                        AND NCA.TOTFAC_FACNRO = TT.FACNRO 
                        WHERE NCA.NCAFACESTA = 'I' 
                        AND NCA.NCATOTDIF <> 0 + UID * 0 
                        AND NCA.\"NCATIPO\" >= CHR(0) 
                        AND TT.CLICODFAX = '".$codigo_suministro."' || SUBSTR (UID, 1, 0) GROUP BY NCA.NCATIPO, NCA.TOTFAC_FACSERNRO, NCA.TOTFAC_FACNRO) GROUP BY SERIEREC, NROREC) NOTA 
                        ON TOTFAC.FACSERNRO = NOTA.SERIEREC 
                        AND TOTFAC.FACNRO = NOTA.NROREC 
                        WHERE TOTFAC.FACESTADO = 'I' 
                        AND TOTFAC.FACSERNRO NOT BETWEEN 90 AND 99 
                        AND TOTFAC.CLICODFAX = '".$codigo_suministro."' 
                        AND FACTOTAL > 0 - NVL(NOTA.NC, 0000000000.00) - NVL(NOTA.ND, 0000000000.00) 
                        ORDER BY TOTFAC.FACEMIFEC"; */

        $consulta = "SELECT DEUDA.facsernro, DEUDA.facnro, DEUDA.facemifec, DEUDA.facvenfec,
        DEUDA.diasvencid, DEUDA.clicodfax, DEUDA.factotsub, DEUDA.facigv, DEUDA.factotal,
        DEUDA.nc,DEUDA.nd, DEUDA.impreal, DEUDA.tamacu, DEUDA.tammesant,DEUDA.factoint,
        CASE
            WHEN DEUDA.EX_INT_MORATORIO = 1 THEN 0
            ELSE DEUDA.intmora
        END AS intmora,
        CASE
            WHEN DEUDA.EX_GCOBRANZA = 1 THEN 0
            ELSE DEUDA.gastocobranza
        END AS gastocobranza,
        DEUDA.facestado, DEUDA.figvref,
        DEUDA.codpoder, DEUDA.CODSECTOR
        FROM
        (
         SELECT /*+ NO_CPU_COSTING */  TOTFAC.facsernro, TOTFAC.facnro, TOTFAC.facemifec, TOTFAC.facvenfec,
                    CASE
                        WHEN floor(SYSDATE - TOTFAC.facvenfec) <= 0 THEN 0
                        ELSE floor(SYSDATE - TOTFAC.facvenfec)
                    END AS diasvencid,
                    TOTFAC.clicodfax, TOTFAC.factotsub, TOTFAC.facigv, TOTFAC.factotal,
                    nvl(nota.nc, 0000000000.00) AS nc,
                    nvl(nota.nd, 0000000000.00) AS nd,
                    CASE
                        WHEN TOTFAC.factotal + nvl(nota.nc, 0000000000.00) + nvl(nota.nd, 0000000000.00) <= 0 THEN 000000000000.00
                        ELSE TOTFAC.factotal + nvl(nota.nc, 0000000000.00) + nvl(nota.nd, 0000000000.00)
                    END AS impreal,
                    tm1.tamacu,
                    tm2.tamtasa AS tammesant,
                    round(power(1 + nvl(tm2.tamtasa, 0) / 100, 1 / 30) - 1, 5) AS factoint,
                    CASE
                        WHEN TOTFAC.factotal + nvl(nota.nc, 0000000000.00) + nvl(nota.nd, 0000000000.00) <= 0 THEN 000000000000.00
                        ELSE round((TOTFAC.factotal + nvl(nota.nc, 0000000000.00) + nvl(nota.nd, 0000000000.00)) * nvl(tm1.tamacu, 0), 2)
                    END AS intmora,
                    CASE
                        WHEN TOTFAC.factotal + nvl(nota.nc, 0000000000.00) + nvl(nota.nd, 0000000000.00) <= 0 THEN 000000000000.00
                        ELSE round((TOTFAC.factotal + nvl(nota.nc, 0000000000.00) + nvl(nota.nd, 0000000000.00)) *(
                                SELECT to_number(datpar, '99.99')
                                FROM prddbfcomercial.maepar
                                WHERE codpar = 'IMPORTEGASTOCOB'
                            ), 2)
                    END AS gastocobranza,
                    TOTFAC.facestado,
                    TOTFAC.figvref,
                    CASE 
                        WHEN RJ.FACSERNRO > 0 THEN 'SI'
                        ELSE 'NO'
                    END AS RECIBO_JUDIC,
                    NVL(ENTPUB.codpoder,0) AS codpoder, NVL(ENTPUB.CODSECTOR,0) AS CODSECTOR,
                   PRDDBFCOMERCIAL.EXON_IM_REC_FIN(TOTFAC.facemifec,NVL(ENTPUB.codpoder,0),  NVL(ENTPUB.CODSECTOR,0) ) as EX_INT_MORATORIO,
                   PRDDBFCOMERCIAL.EXON_IC_REC_FIN(TOTFAC.facemifec,NVL(ENTPUB.codpoder,0),  NVL(ENTPUB.CODSECTOR,0) ) as EX_INT_COMPENSATORIO,
                   PRDDBFCOMERCIAL.EXON_GC_REC_FIN(TOTFAC.facemifec,NVL(ENTPUB.codpoder,0),  NVL(ENTPUB.CODSECTOR,0) ) as EX_GCOBRANZA,
                   PRDDBFCOMERCIAL.EXON_RECI_JUD_FINANCI( CASE 
                        WHEN RJ.FACSERNRO > 0 THEN 'SI'
                            ELSE 'NO'
                        END ) as INCLUIR_REC_COB_JUD
                FROM prddbfcomercial.TOTFAC   
                    LEFT JOIN prddbfcomercial.RECIBOS_JUDICIALIZADOS RJ ON TOTFAC.facsernro = RJ.facsernro AND TOTFAC.facnro = RJ.facnro
                    LEFT JOIN prddbfcomercial.tamn  tm1 ON totfac.facvenfec + 1 = tm1.tamfec
                    LEFT JOIN prddbfcomercial.tamn  tm2 ON add_months(TOTFAC.facvenfec, - 1) = tm2.tamfec
                    LEFT JOIN ( SELECT DEP.SUMINISTRO, DEP.NOMBRE, EP.codpoder, EP.CODSECTOR
                                FROM PRDDBFCOMERCIAL.detalle_entpub DEP 
                                    INNER JOIN PRDDBFCOMERCIAL.ENTIDADES_PUBLICAS EP ON DEP.CODENTPUB = EP.CODENTPUB 
                                ORDER BY DEP.SUMINISTRO ) ENTPUB
                        ON TRIM(ENTPUB.SUMINISTRO) = TRIM(TOTFAC.clicodfax)
                    LEFT JOIN ( SELECT serierec, nrorec, SUM(nc) AS nc, SUM(nd) AS nd
                                FROM
                                    (   SELECT nca.totfac_facsernro   AS serierec, nca.totfac_facnro      AS nrorec,
                                            CASE
                                                WHEN nca.ncatipo = 'A' THEN SUM(nca.ncatotdif * - 1)
                                            END AS nc,
                                            CASE
                                                WHEN nca.ncatipo = 'C' THEN SUM(nca.ncatotdif)
                                            END AS nd,
                                            COUNT(*) AS canti
                                        FROM prddbfcomercial.nca
                                            INNER JOIN prddbfcomercial.TOTFAC tt ON nca.totfac_facsernro = tt.facsernro AND nca.totfac_facnro = tt.facnro
                                        WHERE nca.ncafacesta = 'I' AND nca.ncatotdif <> 0 + uid * 0
                                            AND nca.\"NCATIPO\" >= CHR(0)AND tt.clicodfax = '".$codigo_suministro."'  || substr(uid, 1, 0)
                                        GROUP BY nca.ncatipo, nca.totfac_facsernro, nca.totfac_facnro )
                        GROUP BY serierec, nrorec ) nota 
                     ON TOTFAC.facsernro = nota.serierec AND TOTFAC.facnro = nota.nrorec
                WHERE
                    TOTFAC.facestado = 'I'   AND TOTFAC.facsernro NOT BETWEEN 90 AND 99
                    AND TOTFAC.clicodfax = '".$codigo_suministro."'
                    AND TOTFAC.factotal > 0 - nvl(nota.nc, 0000000000.00) - nvl(nota.nd, 0000000000.00)
                ORDER BY TOTFAC.facemifec
                
                 ) DEUDA 
        WHERE INCLUIR_REC_COB_JUD = 1";
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }
    public function tipo_financimiento(){
        $consulta = "SELECT * FROM PRDDBFCOMERCIAL.MAEPAR WHERE CODPAR LIKE '%FINANPLANSEGMEN%'";
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }
    public function obtengo_planes_financiamiento($tarifa,$ambito,$num_deudas,$datpar){
        
        $consulta  = "SELECT PLANFINA.*, 
                        TARI.* 
                        FROM PRDDBFCOMERCIAL.PLANFINA 
                        INNER JOIN (SELECT /*+ FULL(TARIFA) */ EST_TAR.AMBITO, 
                        EST_TAR.CATEGORIA, 
                        EST_TAR.TARIFA, 
                        TO_CHAR(TARIFA.CODCATTAR) AS CODCATTA, 
                        TARIFA.DESCATTAR 
                        FROM PRDDBFCOMERCIAL.EST_TAR 
                        INNER JOIN PRDDBFCOMERCIAL.TARIFA 
                        ON EST_TAR.CATEGORIA = TARIFA.CODCATTAR 
                        WHERE EST_TAR.TARIFA = '".$tarifa."' 
                        AND EST_TAR.AMBITO = ".$ambito.") TARI 
                        ON PLANFINA.CADENATAR LIKE '%' || TARI.CODCATTA || '%' 
                        WHERE VALIDO = 1 
                        AND PLANFINA.VENCE >= SYSDATE
                        AND PLANFINA.ACTPRSCC = ".$datpar." 
                        AND ".$num_deudas." BETWEEN PLANFINA.MESESDEUDA AND PLANFINA.MDHASTA
                        ORDER BY PLANFINA.CORRELA";
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }
    public function obtengo_Observaciones(){
        $consulta = "SELECT VALPAR, DESPAR 
                     FROM PRDDBFCOMERCIAL.MAEPAR 
                     WHERE TRIM(CODPAR) = 'OBSFINANCIAMIEN' 
                     ORDER BY VALPAR";
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }
    public function Credit_prendiente($suministro){
        $consulta = "SELECT LETRAS.CREDIT_AGENCI_OFICIN_OFICOD AS OFIC_CREDITO, 
                        LETRAS.CREDIT_AGENCI_OFIAGECOD AS AGEN_CREDITO, 
                        LETRAS.CREDIT_CREDNRO AS NROCREDITO, 
                        CREDIT.CLIUNICOD, 
                        CREDIT.CREDFECHA, 
                        CREDIT.DEUDATOTAL, 
                        CREDIT.CTAINICIAL AS INICIAL, 
                        CREDIT.DEUDATOTAL - CREDIT.CTAINICIAL AS SALDOINICIAL, 
                        CREDIT.NROLTS, 
                        CREDIT.CREDSTATUS AS ESTADO, 
                        CREDIT.CREDSTFEC, 
                        CREDIT.CREDTIPO, 
                        CREDIT.CONCEP_FACCONCOD AS CONCEPTO, 
                        CONCEP.FACCONDES, 
                        CREDIT.CREDREFE, 
                        CREDIT.DIGCOD, 
                        SUM (LETRAS.LTCUOTA) AS TOTCUOTA, 
                        COUNT (*) AS NROCUOTAFALTA 
                        FROM PRDDBFCOMERCIAL.LETRAS 
                        INNER JOIN PRDDBFCOMERCIAL.CREDIT 
                        ON LETRAS.CREDIT_AGENCI_OFICIN_OFICOD = 
                        CREDIT.AGENCI_OFICIN_OFICOD 
                        AND LETRAS.CREDIT_AGENCI_OFIAGECOD = CREDIT.AGENCI_OFIAGECOD 
                        AND LETRAS.CREDIT_CREDNRO = CREDIT.CREDNRO 
                        AND CREDIT.CLIUNICOD = '".$suministro."' 
                        AND CREDIT.DEUDATOTAL - CREDIT.CTAINICIAL > 0 
                        AND CREDIT.CREDSTATUS = 'I' 
                        AND CREDIT.CONCEP_FACCONCOD = 700 
                        INNER JOIN PRDDBFCOMERCIAL.CONCEP ON CONCEP.FACCONCOD = CREDIT.CONCEP_FACCONCOD 
                        WHERE LETRAS.LTSTATUS = 'I' 
                        GROUP BY LETRAS.CREDIT_AGENCI_OFICIN_OFICOD, 
                        LETRAS.CREDIT_AGENCI_OFIAGECOD, 
                        LETRAS.CREDIT_CREDNRO, 
                        CREDIT.CLIUNICOD, 
                        CREDIT.CREDFECHA, 
                        CREDIT.DEUDATOTAL, 
                        CREDIT.CTAINICIAL, 
                        CREDIT.DEUDATOTAL - CREDIT.CTAINICIAL, 
                        CREDIT.NROLTS, 
                        CREDIT.CREDSTATUS, 
                        CREDIT.CREDSTFEC, 
                        CREDIT.CREDTIPO, 
                        CREDIT.CONCEP_FACCONCOD, 
                        CONCEP.FACCONDES, 
                        CREDIT.CREDREFE, 
                        CREDIT.DIGCOD 
                        ORDER BY CLIUNICOD, 
                        CREDIT.CREDFECHA, 
                        LETRAS.CREDIT_AGENCI_OFICIN_OFICOD, 
                        LETRAS.CREDIT_AGENCI_OFIAGECOD, 
                        LETRAS.CREDIT_CREDNRO";
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }
    public function obtengo_NumCuotas($oficina,$agencia,$CreditoNro){
        
        $consulta = "SELECT LETRAS.CREDIT_AGENCI_OFICIN_OFICOD AS OFIC_CREDITO, 
                        LETRAS.CREDIT_AGENCI_OFIAGECOD AS AGEN_CREDITO, 
                        LETRAS.CREDIT_CREDNRO AS NROCREDITO, 
                        LETRAS.LTNUM, 
                        LETRAS.LTSALDO,
                        LETRAS.LTVALOR,
                        LETRAS.LTINTER,
                        LETRAS.LTACCION,
                        LETRAS.LTGACOBZ,
                        LETRAS.LTIGV,
                        LETRAS.LTCUOTA, 
                        LETRAS.LTVENCIM, 
                        LETRAS.LTSTATUS, 
                        LETRAS.LTSTAFEC,
                        LETRAS.LTFECCANC,
                        NVL(LETRAS.FACSERNROX, 0) AS SERRECIBO,
                        NVL(LETRAS.FACNROX,0) AS NRORECIBO,
                        LETRAS.FACCUOLIX,
                        LETRAS.SERVIDOR
                        FROM PRDDBFCOMERCIAL.LETRAS 
                        WHERE LETRAS.LTSTATUS = 'I' 
                        AND LETRAS.CREDIT_AGENCI_OFICIN_OFICOD = ".$oficina." 
                        AND LETRAS.CREDIT_AGENCI_OFIAGECOD = ".$agencia." 
                        AND LETRAS.CREDIT_CREDNRO = ".$CreditoNro." 
                        ORDER BY LETRAS.CREDIT_AGENCI_OFICIN_OFICOD, LETRAS.CREDIT_AGENCI_OFIAGECOD, 
                        LETRAS.CREDIT_CREDNRO, LETRAS.LTNUM";
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }
    public function tasa_interes(){
     $consulta = "SELECT TAMFEC, TAMTASA 
                    FROM PRDDBFCOMERCIAL.TAMN 
                    WHERE TAMFEC LIKE (select ADD_MONTHS(SYSDATE, -1) from dual) 
                    AND ROWNUM = 1";
        $query = $this->oracle->query($consulta);
        return $query->result_array();   
    }
    private function max_credit($oficina,$agencia){
        //var_dump($oficina);
        //var_dump($agencia);
        $consulta = "SELECT MAX(CREDNRO) AS MAXIMO  FROM PRDDBFCOMERCIAL.CREDIT WHERE AGENCI_OFICIN_OFICOD = ".$oficina."AND AGENCI_OFIAGECOD =".$agencia;
        $query = $this->oracle->query($consulta);
        return $query->result_array();   
    }
    private function max_Amortiza($oficina,$agencia){
        $consulta = "SELECT MAX(AMONRO) AS MAXIMO  FROM PRDDBFCOMERCIAL.AMORTIZA WHERE CREDIT_AGENCI_OFICIN_OFICOD = ".$oficina." AND CREDIT_AGENCI_OFIAGECOD = ".$agencia;
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }
    
    private function max_DeudaRec($oficina, $agencia){
        $consulta = "SELECT MAX(RECONRO) AS MAXIMO  FROM PRDDBFCOMERCIAL.DEUDAREC WHERE OFICOD = '".$oficina."' AND OFIAGECOD = '".$agencia."'";
        $query = $this->oracle->query($consulta);
        return $query->result_array();   
    }

    private function max_Nca($serie_recibo){
        $consulta = "SELECT MAX(NCANRO) AS MAXIMO  FROM PRDDBFCOMERCIAL.NCA WHERE NCATIPO = 'C' AND NCASERNRO = ".$serie_recibo;
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }

    private function Busco_dato_recibo($serie, $numero){

        $consulta = "SELECT * FROM PRDDBFCOMERCIAL.TOTFAC WHERE FACSERNRO = ".$serie." AND FACNRO = ".$numero ;
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }

    private function Busco_dato_Faclin($serie, $numero){
        $consulta = "SELECT * FROM PRDDBFCOMERCIAL.FACLIN WHERE TOTFAC_FACSERNRO = ".$serie." AND TOTFAC_FACNRO = ".$numero ;
        $query = $this->oracle->query($consulta);
        return $query->result_array();   
    }

    private function Busco_dato_Letfac($serie, $numero){

        $consulta = "SELECT * FROM PRDDBFCOMERCIAL.LETFAC WHERE TOTFAC_FACSERNRO = ".$serie." AND TOTFAC_FACNRO = ".$numero ;
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }

    public function get_credit($oficina, $agencia, $numero){
        $consulta = "SELECT * FROM PRDDBFCOMERCIAL.CREDIT WHERE AGENCI_OFICIN_OFICOD = ".$oficina." AND AGENCI_OFIAGECOD = ".$agencia." AND CREDNRO = ".$numero;
        $query = $this->oracle->query($consulta);
        return $query->result_array(); 
    }

    public function buscar_nota_credito_debito($suministro){
        $consulta = "SELECT * 
                FROM  PRDDBFCOMERCIAL.NCA
                INNER JOIN (SELECT FACSERNRO,
                FACNRO,
                FACEMIFEC,
                FACVENFEC,
                CASE
                WHEN FLOOR (SYSDATE - FACVENFEC) <= 0 THEN 0
                ELSE FLOOR (SYSDATE - FACVENFEC)
                END
                AS DIASVENCID,
                CLICODFAX,
                FACTOTSUB,
                FACIGV,
                FACTOTAL,
                NVL (NOTA.NC, 0000000000.00) AS NC,
                NVL (NOTA.ND, 0000000000.00) AS ND,
                CASE
                WHEN FACTOTAL
                + NVL (NOTA.NC, 0000000000.00)
                + NVL (NOTA.ND, 0000000000.00) <= 0
                THEN
                000000000000.00
                ELSE
                FACTOTAL
                + NVL (NOTA.NC, 0000000000.00)
                + NVL (NOTA.ND, 0000000000.00)
                END
                AS IMPREAL,
                TM1.TAMACU, 
                TM2.TAMTASA AS TAMMESANT,
                ROUND((POWER(1+(NVL(TM2.TAMTASA,0)/100),1/30))-1,5) AS FACTOINT,
                CASE
                WHEN FACTOTAL
                + NVL (NOTA.NC, 0000000000.00)
                + NVL (NOTA.ND, 0000000000.00) <= 0
                THEN
                000000000000.00
                ELSE
                ROUND(( FACTOTAL
                + NVL (NOTA.NC, 0000000000.00)
                + NVL (NOTA.ND, 0000000000.00)) * NVL(TM1.TAMACU,0),2) 
                END
                AS IntMora ,
                CASE
                WHEN FACTOTAL
                + NVL (NOTA.NC, 0000000000.00)
                + NVL (NOTA.ND, 0000000000.00) <= 0
                THEN
                000000000000.00
                ELSE
                ROUND(( FACTOTAL
                + NVL (NOTA.NC, 0000000000.00)
                + NVL (NOTA.ND, 0000000000.00)) * (SELECT TO_NUMBER(DATPAR,'99.99') FROM PRDDBFCOMERCIAL.MAEPAR WHERE CODPAR = 'IMPORTEGASTOCOB'),2) 
                END
                AS GASTOCOBRANZA,
                FACESTADO,
                FIGVREF
                FROM PRDDBFCOMERCIAL.TOTFAC
                LEFT JOIN PRDDBFCOMERCIAL.TAMN TM1 ON TOTFAC.FACVENFEC+1 = TM1.TAMFEC
                LEFT JOIN PRDDBFCOMERCIAL.TAMN TM2 ON ADD_MONTHS(TOTFAC.FACVENFEC,-1) = TM2.TAMFEC
                LEFT JOIN
                ( SELECT SERIEREC,
                NROREC,
                SUM (NC) AS NC,
                SUM (ND) AS ND
                FROM ( SELECT /*+ ORDERED */
                NCA.TOTFAC_FACSERNRO AS SERIEREC,
                NCA.TOTFAC_FACNRO AS NROREC,
                CASE
                WHEN NCA.NCATIPO = 'A'
                THEN
                SUM (NCA.NCATOTDIF * -1)
                END
                AS NC,
                CASE
                WHEN NCA.NCATIPO = 'C' THEN SUM (NCA.NCATOTDIF)
                END
                AS ND,
                COUNT(*) AS CANTI
                FROM PRDDBFCOMERCIAL.NCA
                INNER JOIN PRDDBFCOMERCIAL.TOTFAC TT
                ON NCA.TOTFAC_FACSERNRO = TT.FACSERNRO
                AND NCA.TOTFAC_FACNRO = TT.FACNRO
                WHERE NCA.NCAFACESTA = 'I'
                AND NCA.NCATOTDIF <> 0 + UID * 0
                AND NCA.\"NCATIPO\" >= CHR (0)
                AND TT.CLICODFAX = '".$suministro."' || SUBSTR (UID, 1, 0)
                GROUP BY NCA.NCATIPO, NCA.TOTFAC_FACSERNRO, NCA.TOTFAC_FACNRO)
                GROUP BY SERIEREC, NROREC) NOTA
                ON TOTFAC.FACSERNRO = NOTA.SERIEREC AND TOTFAC.FACNRO = NOTA.NROREC
                WHERE TOTFAC.FACESTADO = 'I'
                AND TOTFAC.FACSERNRO NOT BETWEEN 90 AND 99
                AND TOTFAC.CLICODFAX = '".$suministro."'
                AND FACTOTAL > 0 - NVL (NOTA.NC, 0000000000.00) - NVL (NOTA.ND, 0000000000.00)
                ORDER BY TOTFAC.FACEMIFEC) NCND
                ON TOTFAC_FACSERNRO = NCND.FACSERNRO
                AND TOTFAC_FACNRO = NCND.FACNRO        
                WHERE NCAFACESTA = 'I' ";
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }


    public function Obtengo_credito_anterior($credito, $oficina, $agencia){
        $consulta = "SELECT * FROM PRDDBFCOMERCIAL.CREDIT WHERE AGENCI_OFICIN_OFICOD = ".$oficina." AND AGENCI_OFIAGECOD = ".$agencia." AND CREDNRO = ".$credito;
        $query = $this->oracle->query($consulta);
        return $query->result_array(); 
    }
    
    private function user_cobranza(){
        $consulta = "SELECT USRCOD FROM PRDRECAUDACIONORA12C.MUSUARIO WHERE USRLOG  LIKE '%".$_SESSION['login']."%'";
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }
    public  function Empre_pagos(){
        $resultado = $this->oracle->query("SELECT * FROM  PRDGESTIONCOMERCIAL.CCTOCOB1
                                    INNER JOIN PRDGESTIONCOMERCIAL.MEMPSER ON CCTOCOB1.EMSCOD = MEMPSER.EMSCOD AND MEMPSER.SEMCOD = 1
                                    WHERE USRCOD= ?" , array($_SESSION['user_comercial']));
        
        
        return  $resultado->result_array();
    }
    public function obtengo_cajera(){
        $resultado = $this->oracle->query("SELECT MUSUARIO.USRCOD, COPECAJ.ECOCOD, PTCCOD, USRLOG, USRNOM, SUSCOD, TUSCOD, 
                                     EMPCOD, OFICOD, ARECOD, CJACOD, STECOCOD, ECODES, SECCOD 
                                     FROM PRDRECAUDACIONORA12C.COPECAJ 
                                     INNER JOIN PRDRECAUDACIONORA12C.MEMPCOB ON (COPECAJ.ECOCOD = MEMPCOB.ECOCOD) 
                                     INNER JOIN PRDRECAUDACIONORA12C.MUSUARIO ON (MUSUARIO.USRCOD = COPECAJ.USRCOD) 
                                     WHERE SECCOD = 1  
                                     AND TRIM(USRLOG) = ?
                                     ORDER BY COPECAJ.ECOCOD", array( $_SESSION['login'] ));
         return $resultado->result_array();
    }
    public function maximo_de_pagos( $mdccod, $mdgserdoc, $mdgnrodoc){
        $resultado = $this->oracle->query("SELECT MAX(OPGNROOPE) NRO FROM PRDRECAUDACIONORA12C.OPAGOS WHERE ESECOD=1 AND MDCCOD= ? AND MDGSERDOC= ?  AND MDGNRODOC= ? " , array( $mdccod, $mdgserdoc, $mdgnrodoc ));
        return $resultado->result_array();
    }

    public function get_amortiza($oficina, $agencia, $numero){
        $resultado = $this->oracle->query("SELECT  CREDIT_AGENCI_OFICIN_OFICOD, CREDIT_AGENCI_OFIAGECOD, CREDIT_CREDNRO,
                                            AMONRO, AMOFECHA, CLIUNICOD
                                        FROM  PRDDBFCOMERCIAL.AMORTIZA
                                        WHERE  CREDIT_AGENCI_OFICIN_OFICOD = ".$oficina."  AND  
                                        CREDIT_AGENCI_OFIAGECOD = ".$agencia." AND  
                                        CREDIT_CREDNRO = ".$numero);
        $Datos_Amort_conv = $resultado->result_array();
        return $Datos_Amort_conv;
    }
    public function maximo_autoriza_financia( $oficina, $agencia){
        $resultado = $this->oracle->query("SELECT MAX(AUT_NRO) NRO FROM PRDDBFCOMERCIAL.FINANGX_LETS WHERE  OFICOD= ? AND OFIAGECOD= ?" , array( $oficina, $agencia ));
        return $resultado->result_array();
    }
    public function grabar_autorizacion($oficina, $agencia, $numero_credito, $observacion, $operador){
        $credito = $this -> get_credit($oficina, $agencia, $numero_credito );
        $maximo_de_pagos  = $this -> maximo_autoriza_financia( $oficina, $agencia);
        if( count($maximo_de_pagos) > 0 ){
            $maximo_de_pagos1 = $maximo_de_pagos[0]["NRO"] + 1 ;
        }else{
            $maximo_de_pagos1=1;
        }
        $reg_autoriza[0] = (int)$credito[0]['AGENCI_OFICIN_OFICOD'];
        $reg_autoriza[1] = (int)$credito[0]['AGENCI_OFIAGECOD'];
        $reg_autoriza[2] = (int)$maximo_de_pagos1;
        $reg_autoriza[3] = (int)$_SESSION['user_comercial'];
        $reg_autoriza[4] = $observacion;
        $reg_autoriza[5] = (int)$operador;
        $reg_autoriza[6] = (int)($credito[0]['AGENCI_OFICIN_OFICOD'].$credito[0]['AGENCI_OFIAGECOD']);
        $reg_autoriza[7] = (int)$credito[0]['CREDNRO'];
        $reg_autoriza[8] = 0;
        $this->oracle->trans_begin();
        $consulta = "INSERT INTO PRDDBFCOMERCIAL.FINANGX_LETS ( 
                                    OFICOD, OFIAGECOD, AUT_NRO, AUT_FEC,
                                    AUT_HRA, AUT_VIG, NCODIGO, AUT_GLO,
                                    AUT_OPE, AUT_NCASER, AUT_NCANRO, AUT_EST
                                    )
                        VALUES ( ?, ?, ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                 TO_CHAR(SYSDATE,'HH24:MI:SS'), TO_CHAR(SYSDATE,'DD-MON-YYYY'), ?, ?,
                                 ?, ?, ?, ?
                        )";
        $this->oracle->query($consulta, $reg_autoriza);

        if( $this->oracle->trans_status() === FALSE ){
            $this->oracle->trans_rollback();
            $respuesta[0] = false;
            $respuesta[1] = "OCURRIO UN ERROR AL GRABAR EN EL CREDIT DEL CONVENIO";
            $respuesta[2] = $this->oracle->error();
            return $respuesta;
        }
        $this->oracle->trans_commit();
        $respuesta[0] = true;
        return $respuesta;
    }

    public function extorno_pago_inicial($oficina,$agencia,$nro_credito){
            
            $this->oracle->trans_begin();
            $resultado = $this->oracle->query("SELECT * FROM  PRDDBFCOMERCIAL.CREDIT 
                                                    WHERE AGENCI_OFIAGECOD = ".$agencia." AND
                                                    AGENCI_OFICIN_OFICOD = ".$oficina." AND
                                                    CREDNRO =".$nro_credito);
            $Datos_credito = $resultado->result_array();
            // CREO UN REGISTRO EN EL CREANUL 
            $numero_credit = $this->max_creanul();
            if(count($numero_credit)>0){
                $maximo_operacion = (int)$numero_credit[0]["MAXIMO"]+ 1;
            }else{
                $maximo_operacion = 1;
            }
            // INSERTO EN EL CREANUL
            $creanul[0] = $Datos_credito[0]['AGENCI_OFICIN_OFICOD']; // oficina 
            $creanul[1] = $Datos_credito[0]['AGENCI_OFIAGECOD'];
            $creanul[2] = $Datos_credito[0]['CREDNRO'];
            $creanul[3] = $Datos_credito[0]['CLIUNICOD'];
            $creanul[4] = $Datos_credito[0]['CREDFECHA'];
            $creanul[5] = $Datos_credito[0]['DEUDATOTAL'];
            $creanul[6] = $Datos_credito[0]['CTAINICIAL'];
            $creanul[7] = $Datos_credito[0]['NROLTS'];
            $creanul[8] = $Datos_credito[0]['CREDTIPO'];
            $creanul[9] = $Datos_credito[0]['CONCEP_FACCONCOD'];
            $creanul[10] = $_SESSION['user_comercial'];
            $creanul[11] = $_SESSION['user_comercial'];
            $creanul[12] = $_SESSION['user_nom'];
            $creanul[13] = 1;
            $creanul[14] = $_SESSION['OFICOD'];
            $creanul[15] = $_SESSION['OFIAGECOD'];
            $creanul[16] = "INGRESANDO REFERENCIA";//$referencia;// SOLO ES TEXTO DE EJEMPLO 
            $creanul[17] = $Datos_credito[0]['SERVIDOR'];
            $creanul[18] = $maximo_operacion;

            $consulta = "INSERT INTO PRDDBFCOMERCIAL.CREANUL (
                                OFICOD, OFIAGECOD, CREDNRO, CLIUNICOD, 
                                CREDFECHA, DEUDATOTAL, CTAINICIAL, NROLTS,
                                CREDTIPO, CRECONCOD, DIGCOD, USUARIO, 
                                NEMOUSU, MOTIVOANUL, FECHANUL, OFIANUL, 
                                OFIAGEANUL, REFEREANUL, SERVIDOR,
                                CREDHRA, NROOPE
                                )
                            VALUES ( 
                                     ?, ?, ?, ?,
                                     ?, ?, ?, ?,
                                     ?, ?, ?, ?,
                                     ?, ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'), ?,
                                     ?, ?, ?,
                                     TO_CHAR(SYSDATE,'HH:MI:SS'), ?
                                    )";

            $this->oracle->query($consulta , $creanul );
            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                return false;
            }
            // ACTUALIZO EL CREDITO
            $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT 
                                    SET 
                                        CREDSTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                        CREDSTATUS= 'A'
                                    WHERE AGENCI_OFIAGECOD = ".$agencia." AND
                                        AGENCI_OFICIN_OFICOD = ".$oficina." AND
                                        CREDSTATUS= 'I' AND
                                        CREDNRO =".$nro_credito);
            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL CREDIT DE CONVENIO CUANDO TIENE DEUDAS PENDIENTES ";
                return $respuesta;
            }
            // ACTUALIZO LAS LETRAS 
            $this->oracle->query("UPDATE PRDDBFCOMERCIAL.LETRAS 
                                    SET 
                                    LTSTAFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                    LTSTATUS= 'A' 
                                WHERE   CREDIT_AGENCI_OFICIN_OFICOD = ".$oficina." AND 
                                        CREDIT_AGENCI_OFIAGECOD =".$agencia." AND  
                                        CREDIT_CREDNRO = ".$nro_credito." AND
                                        LTSTATUS = 'I' ");

            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                return $respuesta;
            }
            // ACTUALIZO EL CONVILINK
            $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CONVLINK 
                                    SET 
                                    CREDSTATUS= 'A',
                                    ICREDSTATU= 'A' 
                                WHERE  CREDIT_AGENCI_OFICIN_OFICOD = ".$oficina."  AND  
                                    CREDIT_AGENCI_OFIAGECOD = ".$agencia." AND  
                                    CREDIT_CREDNRO = ".$nro_credito);

            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                return $respuesta;
            }
            //EXTRAIGO DATOS DE CONVILINK  
            $resultado = $this->oracle->query("SELECT IOFICOD, IOFIAGECOD, ICREDNRO FROM  PRDDBFCOMERCIAL.CONVLINK
                                                    WHERE  CREDIT_AGENCI_OFICIN_OFICOD = ".$oficina."  AND  
                                                    CREDIT_AGENCI_OFIAGECOD = ".$agencia." AND  
                                                    CREDIT_CREDNRO = ".$nro_credito);
            $Datos_convilink = $resultado->result_array();

            // PARA LOS INTERESES 
            if($Datos_convilink[0]['IOFIAGECOD'] != 0 && $Datos_convilink[0]['IOFICOD'] != 0 && $Datos_convilink[0]['ICREDNRO'] != 0){
                // ACTUALIZO EL INTERES DEL CREDITO
                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT 
                                    SET 
                                        CREDSTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                        CREDSTATUS= 'A'
                                    WHERE AGENCI_OFIAGECOD = ".$Datos_convilink[0]['IOFIAGECOD']." AND
                                        AGENCI_OFICIN_OFICOD = ".$Datos_convilink[0]['IOFICOD']." AND
                                        CREDSTATUS= 'I' AND
                                        CREDNRO =".$Datos_convilink[0]['ICREDNRO']);
                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL CREDIT DE CONVENIO CUANDO TIENE DEUDAS PENDIENTES ";
                    return $respuesta;
                }
                
                // ACTUALIZO LAS LETRAS  DEL INTERES 
                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.LETRAS 
                        SET 
                        LTSTAFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                        LTSTATUS= 'A' 
                    WHERE   CREDIT_AGENCI_OFICIN_OFICOD = ".$Datos_convilink[0]['IOFICOD']." AND 
                            CREDIT_AGENCI_OFIAGECOD =".$Datos_convilink[0]['IOFIAGECOD']." AND  
                            CREDIT_CREDNRO = ".$Datos_convilink[0]['ICREDNRO']." AND
                            LTSTATUS = 'I' ");

                if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                return $respuesta;
                }
            }
            // PARA CUANDO TIENE DEUDAS PENDIENTES 
            $resultado = $this->oracle->query("SELECT CREDNRO, CLIUNICOD, CREDFECHA, OFICOD , OFIAGECOD, CRECONCOD FROM  PRDDBFCOMERCIAL.CREDCONV
                                                    WHERE  NOFICOD = ".$oficina."  AND  
                                                    NOFIAGECO = ".$agencia." AND  
                                                    NCREDNRO = ".$nro_credito);
            $Datos_Credconv = $resultado->result_array();
            $i=0;
            while($i< count($Datos_Credconv)){
                // ACTUALIZO AL CREDITO PENDIENTE 
                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT 
                                    SET 
                                        CREDSTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                        CREDSTATUS= 'I'
                                    WHERE AGENCI_OFIAGECOD = ".$Datos_Credconv[$i]['OFIAGECOD']." AND
                                        AGENCI_OFICIN_OFICOD = ".$Datos_Credconv[$i]['OFICOD']." AND
                                        CREDSTATUS= 'Z' AND
                                        CREDNRO =".$Datos_Credconv[$i]['CREDNRO']);

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL CREDIT DE CONVENIO CUANDO TIENE DEUDAS PENDIENTES ";
                    return $respuesta;
                }
                //BUSCO SI ES QUE TIENE INTERESES EL CREDITO 
                $resultado = $this->oracle->query("SELECT  CREDSTATUS,  IOFICOD, IOFIAGECOD, ICREDNRO FROM  PRDDBFCOMERCIAL.CONVLINK  WHERE
                                        CREDIT_AGENCI_OFICIN_OFICOD = ".$Datos_Credconv[$i]['OFICOD']." AND 
                                        CREDIT_AGENCI_OFIAGECOD = ".$Datos_Credconv[$i]['OFIAGECOD']." AND 
                                        CREDIT_CREDNRO =".$Datos_Credconv[$i]['CREDNRO']);
                $Modi_interes = $resultado->result_array(); 
                if(count($Modi_interes) > 0){        
                    $inte_ofi = (int)$Modi_interes[0]['IOFICOD'] ;
                    $inte_age = (int)$Modi_interes[0]['IOFIAGECOD'] ;
                    $inte_numero = (int)$Modi_interes[0]['ICREDNRO'] ;
                    if($inte_ofi != 0 || $inte_age != 0 || $inte_numero != 0 ){
                        // ACTUALIZO EL INTERES DEL CREDITO PENDIENTE 
                        $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT 
                                                    SET 
                                                        CREDSTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                                        CREDSTATUS= 'I'
                                                    WHERE AGENCI_OFIAGECOD = ".$Modi_interes[0]["IOFIAGECOD"]." AND
                                                        AGENCI_OFICIN_OFICOD = ".$Modi_interes[0]["IOFICOD"]." AND
                                                        CREDSTATUS= 'A' AND
                                                        CREDNRO =".$Modi_interes[0]["ICREDNRO"]);

                        if($this->oracle->trans_status() === FALSE){
                            $this->oracle->trans_rollback();
                            $respuesta[0] = false;
                            $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL CREDIT DEL INTERES CUANDO TIENE DEUDAS PENDIENTES ";
                            return $respuesta;
                        }
                        // ACTUALIZO LA LETRA DEL CREDITO PENDIENTE 
                        $this->oracle->query("UPDATE PRDDBFCOMERCIAL.LETRAS 
                                            SET 
                                            LTSTAFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                            LTSTATUS= 'I' 
                                            WHERE   CREDIT_AGENCI_OFICIN_OFICOD = ".$Modi_interes[0]["IOFICOD"]." AND 
                                                    CREDIT_AGENCI_OFIAGECOD =".$Modi_interes[0]["IOFIAGECOD"]." AND  
                                                    CREDIT_CREDNRO = ".$Modi_interes[0]["ICREDNRO"]." AND
                                                    LTSTATUS = 'A' ");

                        if($this->oracle->trans_status() === FALSE){
                            $this->oracle->trans_rollback();
                            $respuesta[0] = false;
                            $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                            return $respuesta;
                        }
                    }
                }
                //ACTUALIZO LAS LETRAS DEL CREDITO PENDIENTE 
                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.LETRAS 
                    SET 
                    LTSTAFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                    LTSTATUS= 'I' 
                    WHERE   CREDIT_AGENCI_OFICIN_OFICOD = ".$Datos_Credconv[$i]['OFICOD']." AND 
                            CREDIT_AGENCI_OFIAGECOD =".$Datos_Credconv[$i]['OFIAGECOD']." AND  
                            CREDIT_CREDNRO = ".$Datos_Credconv[$i]['CREDNRO']." AND
                            LTSTATUS = 'Z' ");

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EL LETRAS CUANDO TIENE DEUDAS PENDIENTES ";
                    return $respuesta;
                }
                $i++;
            }
            // EXTORNAMOS EL AMORTIZA     
            $this->oracle->query("UPDATE PRDDBFCOMERCIAL.AMORTIZA  
                                    SET 
                                    AMOEST= 'A',
                                    AMOFLAG = 'A',
                                    AMOESTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                    DIGPAG = ".$_SESSION['user_comercial'].",
                                    OFIPAG = ".$_SESSION['OFICOD'] .", 
                                    OFAPAG = ".$_SESSION['OFIAGECOD']."
                                WHERE  CREDIT_AGENCI_OFICIN_OFICOD = ".$oficina."  AND  
                                    CREDIT_AGENCI_OFIAGECOD = ".$agencia." AND  
                                    CREDIT_CREDNRO = ".$nro_credito);

            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                return $respuesta;
            }
            // EXTORNAMOS  LOS RECIBOS A FINANCIAR

            $resultado = $this->oracle->query("SELECT CLICODFAX, FACSERNRO, FACNRO,
                                                    FACESTFECH, FLAGNOTA, OFICOD, 
                                                    OFIAGECOD, CREDNRO FROM  PRDDBFCOMERCIAL.TOTFCONV
                                                    WHERE  OFICOD = ".$oficina."  AND  
                                                    OFIAGECOD= ".$agencia." AND  
                                                    CREDNRO = ".$nro_credito);
            $Datos_ReciboConv = $resultado->result_array();
            $i = 0;
            while( $i<count($Datos_ReciboConv)){
                $consulta = "UPDATE PRDDBFCOMERCIAL.TOTFAC SET FACESTADO='I' , FACESTFECH = TO_CHAR(SYSDATE,'DD-MON-YYYY')  
                                WHERE FACSERNRO = ".$Datos_ReciboConv[$i]['FACSERNRO']." AND FACNRO = ".$Datos_ReciboConv[$i]['FACNRO']." ";
                    
                $this->oracle->query($consulta);
                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL TOTFAC ";
                    return $respuesta;
                }
                if( ($i+1) == count($Datos_ReciboConv) ){
                    $consulta = "UPDATE PRDDBFCOMERCIAL.NCA SET NCAFACESTA='A'   
                     WHERE TOTFAC_FACSERNRO = ".$Datos_ReciboConv[$i]['FACSERNRO']." AND TOTFAC_FACNRO = ".$Datos_ReciboConv[$i]['FACNRO']." AND NCAFACESTA = 'C'";
                    $this->oracle->query($consulta);
                    if($this->oracle->trans_status() === FALSE){
                        $this->oracle->trans_rollback();
                        return false;
                    }
                }
                $i++;
            }

            // EXTORNAMOS LAS NOTAS DE CREDITO SI ES QUE TIENEN LOS RECIBOS 

            $resultado = $this->oracle->query("SELECT  NCATIPO, NCASERNRO, NCANRO, NCAFACSERN, NCAFACNRO,
                                                    NOFICOD, NOFIAGECO, NCREDNRO
                                                    FROM  PRDDBFCOMERCIAL.NCACONV
                                                    WHERE  NOFICOD = ".$oficina."  AND  
                                                    NOFIAGECO = ".$agencia." AND  
                                                    NCREDNRO = ".$nro_credito);
            $Datos_NcaConv = $resultado->result_array();
            $i=0;
            while($i < count($Datos_NcaConv)){
                $consulta = "UPDATE PRDDBFCOMERCIAL.NCA SET NCAFACESTA='I' , NCAFACESTF = TO_CHAR(SYSDATE,'DD-MON-YYYY')  
                            WHERE TOTFAC_FACSERNRO = ".$Datos_NcaConv[$i]['NCAFACSERN']." AND TOTFAC_FACNRO = ".$Datos_NcaConv[$i]['NCAFACNRO']." ";
                    
                $this->oracle->query($consulta);
                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL  NCA ";
                    return $respuesta;
                }
                $i++;
            }


            // ACTUALIZO EL REGISTRO DE PAGO 
            $resultado = $this->oracle->query("SELECT  CREDIT_AGENCI_OFICIN_OFICOD, CREDIT_AGENCI_OFIAGECOD, CREDIT_CREDNRO,
                                                        AMONRO, AMOFECHA, CLIUNICOD
                                                    FROM  PRDDBFCOMERCIAL.AMORTIZA
                                                    WHERE  CREDIT_AGENCI_OFICIN_OFICOD = ".$oficina."  AND  
                                                    CREDIT_AGENCI_OFIAGECOD = ".$agencia." AND  
                                                    CREDIT_CREDNRO = ".$nro_credito);
            $Datos_Amort_conv = $resultado->result_array();
            if(count($Datos_Amort_conv)>0){
                $this->oracle->query("UPDATE PRDRECAUDACIONORA12C.MDOCGLB 
                                    SET 
                                    SDGCOD= 4,
                                    MDGDNIFREG = TO_CHAR(SYSDATE,'DD-MON-YYYY'), 
                                    MDGDNIHREG = TO_CHAR(SYSDATE,'HH24:MI:SS'),
                                    MDGFCHLSTUPD = TO_CHAR(SYSDATE,'DD-MON-YYYY'), 
                                    MDGHRALSTUPD = TO_CHAR(SYSDATE,'HH24:MI:SS')
                                WHERE ESECOD = 1  AND  
                                    MDCCOD = 6 AND  
                                    MDGSERDOC = ".$oficina.$agencia." AND 
                                    MDGNRODOC = ".$Datos_Amort_conv[0]['AMONRO']);

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                    return $respuesta;
                }
            }
            $tip_doc = 6; 
            $ser_doc = $oficina.$agencia ;
            $nro_doc = $Datos_Amort_conv[0]['AMONRO'];
            $maximo_de_pagos = $this -> maximo_de_pagos($tip_doc, $ser_doc, $nro_doc);
            if( count($maximo_de_pagos) > 0 ){
                $maximo_de_pagos1 = $maximo_de_pagos[0]["NRO"] + 1 ;
            }else{
                $maximo_de_pagos1=1;
            }

            //  EXTRAIGO EL PAGO ANTERIOR 

            $resultado = $this->oracle->query("SELECT  * 
                                                    FROM  PRDRECAUDACIONORA12C.OPAGOS
                                                    WHERE  ESECOD = 1  AND  
                                                    MDCCOD = 6  AND  
                                                    MDGSERDOC = ".$ser_doc." AND
                                                    MDGNRODOC = ".$nro_doc);
            $Datos_pago_ante = $resultado->result_array();
            if(count($Datos_pago_ante)>0){
                // REGISTRO PARA EXTORNO DEL PAGO 

                $this->oracle->query("INSERT INTO  PRDRECAUDACIONORA12C.OPAGOS
                ( ESECOD, MDCCOD, MDGSERDOC, MDGNRODOC, OPGNROOPE, OPGFCHREG, OPGHRAREG, OPGFCHPAG,
                    OPGHRAPAG, OPGFCHPEF, OPGHRAPEF, OPGIMPPAG, OPCCOD, ECOCOD, PTCCOD, CJACOD,
                    STECOCOD, VOEITEM, USRCOD, OPCJITM, TPGCOD, SPGCOD, OPGIMPCAR, OPGIMPINT, 
                    OPGIMPENT, OPGEMPVUE, OPGREFBO, OPGPAGINTSW, OPGPAGCARSW, OPGUSRAUX, OPGFCHAUX, OPGHRAAUX,
                    OPGADDIP) VALUES
                    ( ?, ?, ?, ?, ?,TO_CHAR(SYSDATE,'DD-MON-YYYY') ,TO_CHAR(SYSDATE,'HH:MI:SS'),TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                    TO_CHAR(SYSDATE,'HH:MI:SS'), TO_CHAR(SYSDATE,'DD-MON-YYYY'),TO_CHAR(SYSDATE,'HH:MI:SS'), ?, ?, ?, ?, ?,
                    ?, ?, ?, ?, ?, ?, ?, ?,
                    ?, ?, ?, ?, ?, ?, ?, ?,
                    ? )" ,
                array($Datos_pago_ante[0]['ESECOD'], $Datos_pago_ante[0]['MDCCOD'],$Datos_pago_ante[0]['MDGSERDOC'], $Datos_pago_ante[0]['MDGNRODOC'],
                    $maximo_de_pagos1, $Datos_pago_ante[0]['OPGIMPPAG'],$Datos_pago_ante[0]['OPCCOD'], $Datos_pago_ante[0]['ECOCOD'], $Datos_pago_ante[0]['PTCCOD'], $Datos_pago_ante[0]['CJACOD'],
                    $Datos_pago_ante[0]['STECOCOD'], 1, $Datos_pago_ante[0]['USRCOD'],0 ,1 ,2, 0, 0,
                    0, 0, 0, 0, 0, 0, NULL, NULL,
                    NULL ));
                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                    return $respuesta;
                }
            }
            

            // CAMBIO EL ESTADO DEL REGISTRO 
            $this->oracle->query("UPDATE PRDDBFCOMERCIAL.DEUDAREC 
                                    SET
                                    EST_PAGO  = 0,
                                    ESTADOACTA = 'R'
                                    WHERE OFICOD = ".$oficina."  AND  
                                        OFIAGECOD = ".$agencia." AND  
                                        CREDNRO = ".$nro_credito);

            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                return $respuesta;
            }
            // CAMBIO EL ESTADO AL PERMISO 
            $this->oracle->query("UPDATE PRDDBFCOMERCIAL.FINANGX_LETS 
                                    SET
                                    AUT_EST  = 1
                                    WHERE OFICOD = ".$oficina."  AND  
                                        OFIAGECOD = ".$agencia." AND  
                                        AUT_NCANRO = ".$nro_credito);

            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                return $respuesta;
            }
            $this->oracle->trans_commit();
            $respuesta[0] = true;
            return $respuesta;
        
    }

    public function realizar_pago_inicial($oficina,$agencia,$nro_credito){
        $relacion_empre= $this -> Empre_pagos();
        $dato_cajera = $this -> obtengo_cajera();
        if( count($relacion_empre) > 0  && count($dato_cajera) > 0 ){
            $this->oracle->trans_begin();
            $resultado = $this->oracle->query("SELECT * FROM  PRDDBFCOMERCIAL.CREDIT 
                                                    WHERE AGENCI_OFIAGECOD = ".$agencia." AND
                                                    AGENCI_OFICIN_OFICOD = ".$oficina." AND
                                                    CREDNRO =".$nro_credito);
            $Datos_credito = $resultado->result_array();
            // ACTUALIZO EL CREDITO
            $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT 
                                    SET 
                                        CREDSTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                        CREDSTATUS= 'I'
                                    WHERE AGENCI_OFIAGECOD = ".$agencia." AND
                                        AGENCI_OFICIN_OFICOD = ".$oficina." AND
                                        CREDSTATUS= 'A' AND
                                        CREDNRO =".$nro_credito);
            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL CREDIT DE CONVENIO CUANDO TIENE DEUDAS PENDIENTES ";
                return $respuesta;
            }
            // ACTUALIZO LAS LETRAS 
            $this->oracle->query("UPDATE PRDDBFCOMERCIAL.LETRAS 
                                    SET 
                                    LTSTAFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                    LTSTATUS= 'I' 
                                WHERE   CREDIT_AGENCI_OFICIN_OFICOD = ".$oficina." AND 
                                        CREDIT_AGENCI_OFIAGECOD =".$agencia." AND  
                                        CREDIT_CREDNRO = ".$nro_credito." AND
                                        LTSTATUS = 'A' ");

            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                return $respuesta;
            }
            // ACTUALIZO EL CONVILINK
            $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CONVLINK 
                                    SET 
                                    CREDSTATUS= 'I',
                                    ICREDSTATU= 'I' 
                                WHERE  CREDIT_AGENCI_OFICIN_OFICOD = ".$oficina."  AND  
                                    CREDIT_AGENCI_OFIAGECOD = ".$agencia." AND  
                                    CREDIT_CREDNRO = ".$nro_credito);

            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                return $respuesta;
            }
            //EXTRAIGO DATOS DE CONVILINK  
            $resultado = $this->oracle->query("SELECT IOFICOD, IOFIAGECOD, ICREDNRO FROM  PRDDBFCOMERCIAL.CONVLINK
                                                    WHERE  CREDIT_AGENCI_OFICIN_OFICOD = ".$oficina."  AND  
                                                    CREDIT_AGENCI_OFIAGECOD = ".$agencia." AND  
                                                    CREDIT_CREDNRO = ".$nro_credito);
            $Datos_convilink = $resultado->result_array();
            // PARA LOS INTERESES 
            if($Datos_convilink[0]['IOFIAGECOD'] != 0 && $Datos_convilink[0]['IOFICOD'] != 0 && $Datos_convilink[0]['ICREDNRO'] != 0){
                // ACTUALIZO EL INTERES DEL CREDITO
                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT 
                                    SET 
                                        CREDSTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                        CREDSTATUS= 'I'
                                    WHERE AGENCI_OFIAGECOD = ".$Datos_convilink[0]['IOFIAGECOD']." AND
                                        AGENCI_OFICIN_OFICOD = ".$Datos_convilink[0]['IOFICOD']." AND
                                        CREDSTATUS= 'A' AND
                                        CREDNRO =".$Datos_convilink[0]['ICREDNRO']);
                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL CREDIT DE CONVENIO CUANDO TIENE DEUDAS PENDIENTES ";
                    return $respuesta;
                }
                
                // ACTUALIZO LAS LETRAS  DEL INTERES 
                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.LETRAS 
                        SET 
                        LTSTAFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                        LTSTATUS= 'I' 
                    WHERE   CREDIT_AGENCI_OFICIN_OFICOD = ".$Datos_convilink[0]['IOFICOD']." AND 
                            CREDIT_AGENCI_OFIAGECOD =".$Datos_convilink[0]['IOFIAGECOD']." AND  
                            CREDIT_CREDNRO = ".$Datos_convilink[0]['ICREDNRO']." AND
                            LTSTATUS = 'A' ");

                if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                return $respuesta;
                }
            }
            // PARA CUANDO TIENE DEUDAS PENDIENTES 
            
            $resultado = $this->oracle->query("SELECT CREDNRO, CLIUNICOD, CREDFECHA, OFICOD , OFIAGECOD, CRECONCOD FROM  PRDDBFCOMERCIAL.CREDCONV
                                                    WHERE  NOFICOD = ".$oficina."  AND  
                                                    NOFIAGECO = ".$agencia." AND  
                                                    NCREDNRO = ".$nro_credito);
            $Datos_Credconv = $resultado->result_array();
            $i=0;
            while($i< count($Datos_Credconv)){
                // ACTUALIZO AL CREDITO PENDIENTE 
                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT 
                                    SET 
                                        CREDSTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                        CREDSTATUS= 'Z'
                                    WHERE AGENCI_OFIAGECOD = ".$Datos_Credconv[$i]['OFIAGECOD']." AND
                                        AGENCI_OFICIN_OFICOD = ".$Datos_Credconv[$i]['OFICOD']." AND
                                        CREDSTATUS= 'I' AND
                                        CREDNRO =".$Datos_Credconv[$i]['CREDNRO']);

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL CREDIT DE CONVENIO CUANDO TIENE DEUDAS PENDIENTES ";
                    return $respuesta;
                }
                //BUSCO SI ES QUE TIENE INTERESES EL CREDITO 
                $resultado = $this->oracle->query("SELECT  CREDSTATUS,  IOFICOD, IOFIAGECOD, ICREDNRO FROM  PRDDBFCOMERCIAL.CONVLINK  WHERE
                                        CREDIT_AGENCI_OFICIN_OFICOD = ".$Datos_Credconv[$i]['OFICOD']." AND 
                                        CREDIT_AGENCI_OFIAGECOD = ".$Datos_Credconv[$i]['OFIAGECOD']." AND 
                                        CREDIT_CREDNRO =".$Datos_Credconv[$i]['CREDNRO']);
                $Modi_interes = $resultado->result_array(); 
                if(count($Modi_interes) > 0){        
                    $inte_ofi = (int)$Modi_interes[0]['IOFICOD'] ;
                    $inte_age = (int)$Modi_interes[0]['IOFIAGECOD'] ;
                    $inte_numero = (int)$Modi_interes[0]['ICREDNRO'] ;
                    if($inte_ofi != 0 || $inte_age != 0 || $inte_numero != 0 ){
                        // ACTUALIZO EL INTERES DEL CREDITO PENDIENTE 
                        $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT 
                                                    SET 
                                                        CREDSTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                                        CREDSTATUS= 'A'
                                                    WHERE AGENCI_OFIAGECOD = ".$Modi_interes[0]["IOFIAGECOD"]." AND
                                                        AGENCI_OFICIN_OFICOD = ".$Modi_interes[0]["IOFICOD"]." AND
                                                        CREDSTATUS= 'I' AND
                                                        CREDNRO =".$Modi_interes[0]["ICREDNRO"]);

                        if($this->oracle->trans_status() === FALSE){
                            $this->oracle->trans_rollback();
                            $respuesta[0] = false;
                            $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL CREDIT DEL INTERES CUANDO TIENE DEUDAS PENDIENTES ";
                            return $respuesta;
                        }
                        // ACTUALIZO LA LETRA DEL CREDITO PENDIENTE 
                        $this->oracle->query("UPDATE PRDDBFCOMERCIAL.LETRAS 
                                            SET 
                                            LTSTAFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                            LTSTATUS= 'A' 
                                            WHERE   CREDIT_AGENCI_OFICIN_OFICOD = ".$Modi_interes[0]["IOFICOD"]." AND 
                                                    CREDIT_AGENCI_OFIAGECOD =".$Modi_interes[0]["IOFIAGECOD"]." AND  
                                                    CREDIT_CREDNRO = ".$Modi_interes[0]["ICREDNRO"]." AND
                                                    LTSTATUS = 'I' ");

                        if($this->oracle->trans_status() === FALSE){
                            $this->oracle->trans_rollback();
                            $respuesta[0] = false;
                            $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                            return $respuesta;
                        }
                    }
                }
                //ACTUALIZO LAS LETRAS DEL CREDITO PENDIENTE 
                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.LETRAS 
                    SET 
                    LTSTAFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                    LTSTATUS= 'Z' 
                    WHERE   CREDIT_AGENCI_OFICIN_OFICOD = ".$Datos_Credconv[$i]['OFICOD']." AND 
                            CREDIT_AGENCI_OFIAGECOD =".$Datos_Credconv[$i]['OFIAGECOD']." AND  
                            CREDIT_CREDNRO = ".$Datos_Credconv[$i]['CREDNRO']." AND
                            LTSTATUS = 'I' ");

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EL LETRAS CUANDO TIENE DEUDAS PENDIENTES ";
                    return $respuesta;
                }
                $i++;
            }
            // ACTUALIZAMOS EL AMORTIZA     
            $this->oracle->query("UPDATE PRDDBFCOMERCIAL.AMORTIZA  
                                    SET 
                                    AMOEST= 'P',
                                    AMOFLAG = 'P',
                                    AMOESTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                    DIGPAG = ".$_SESSION['user_id'].",
                                    OFIPAG = ".$_SESSION['OFICOD'] .", 
                                    OFAPAG = ".$_SESSION['OFIAGECOD']."
                                WHERE  CREDIT_AGENCI_OFICIN_OFICOD = ".$oficina."  AND  
                                    CREDIT_AGENCI_OFIAGECOD = ".$agencia." AND  
                                    CREDIT_CREDNRO = ".$nro_credito);

            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                return $respuesta;
            }

            //ACTUALIZAMOS LOS RECIBOS A FINANCIAR

            $resultado = $this->oracle->query("SELECT CLICODFAX, FACSERNRO, FACNRO,
                                                    FACESTFECH, FLAGNOTA, OFICOD, 
                                                    OFIAGECOD, CREDNRO FROM  PRDDBFCOMERCIAL.TOTFCONV
                                                    WHERE  OFICOD = ".$oficina."  AND  
                                                    OFIAGECOD= ".$agencia." AND  
                                                    CREDNRO = ".$nro_credito);
            $Datos_ReciboConv = $resultado->result_array();
            $i = 0;
            while( $i < count($Datos_ReciboConv)){
                $consulta = "UPDATE PRDDBFCOMERCIAL.TOTFAC SET FACESTADO='C' , FACESTFECH = TO_CHAR(SYSDATE,'DD-MON-YYYY')  
                                WHERE FACSERNRO = ".$Datos_ReciboConv[$i]['FACSERNRO']." AND FACNRO = ".$Datos_ReciboConv[$i]['FACNRO']." ";
                    
                $this->oracle->query($consulta);
                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL TOTFAC ";
                    return $respuesta;
                }
                $this->oracle->query("UPDATE PRDRECAUDACIONORA12C.MDOCGLB 
                        SET 
                        SDGCOD= 3,
                        MDGDNIFREG = TO_CHAR(SYSDATE,'DD-MON-YYYY'), 
                        MDGDNIHREG = TO_CHAR(SYSDATE,'HH24:MI:SS'),
                        MDGFCHLSTUPD = TO_CHAR(SYSDATE,'DD-MON-YYYY'), 
                        MDGHRALSTUPD = TO_CHAR(SYSDATE,'HH24:MI:SS')
                    WHERE ESECOD = 1  AND  
                        MDCCOD = 1  AND  
                        SDGCOD = 1   AND
                        MDGSERDOC = ".$Datos_ReciboConv[$i]['FACSERNRO']." AND 
                        MDGNRODOC = ".$Datos_ReciboConv[$i]['FACNRO']);

                if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR MDOCGLB RECIBOS ";
                return $respuesta;
                }
                $i++;
            }
            // ACTUALIZAMOS LAS NOTAS DE CREDITO SI ES QUE TIENEN LOS RECIBOS 

            $resultado = $this->oracle->query("SELECT  NCATIPO, NCASERNRO, NCANRO, NCAFACSERN, NCAFACNRO,
                                                    NOFICOD, NOFIAGECO, NCREDNRO
                                                    FROM  PRDDBFCOMERCIAL.NCACONV
                                                    WHERE  NOFICOD = ".$oficina."  AND  
                                                    NOFIAGECO = ".$agencia." AND  
                                                    NCREDNRO = ".$nro_credito);
            $Datos_NcaConv = $resultado->result_array();
            $i=0;
            while($i < count($Datos_NcaConv)){
                $consulta = "UPDATE PRDDBFCOMERCIAL.NCA SET NCAFACESTA='C' , NCAFACESTF = TO_CHAR(SYSDATE,'DD-MON-YYYY')  
                            WHERE TOTFAC_FACSERNRO = ".$Datos_NcaConv[$i]['NCAFACSERN']." AND TOTFAC_FACNRO = ".$Datos_NcaConv[$i]['NCAFACNRO']." ";
                    
                $this->oracle->query($consulta);
                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL  NCA ";
                    return $respuesta;
                }
                // SI NCATIPO = 'A'  
                if($Datos_NcaConv[$i]['NCATIPO'] =='A'){
                    $this->oracle->query("UPDATE PRDRECAUDACIONORA12C.MDOCGLB 
                                    SET 
                                    SDGCOD= 3,
                                    MDGDNIFREG = TO_CHAR(SYSDATE,'DD-MON-YYYY'), 
                                    MDGDNIHREG = TO_CHAR(SYSDATE,'HH24:MI:SS'),
                                    MDGFCHLSTUPD = TO_CHAR(SYSDATE,'DD-MON-YYYY'), 
                                    MDGHRALSTUPD = TO_CHAR(SYSDATE,'HH24:MI:SS')
                                WHERE ESECOD = 1  AND  
                                      MDCCOD = 2  AND  
                                      SDGCOD = 1   AND
                                      MDGSERDOC = ".$Datos_NcaConv[$i]['NCAFACSERN']." AND 
                                      MDGNRODOC = ".$Datos_NcaConv[$i]['NCAFACNRO']);

                }else{
                    $this->oracle->query("UPDATE PRDRECAUDACIONORA12C.MDOCGLB 
                                    SET 
                                    SDGCOD= 3,
                                    MDGDNIFREG = TO_CHAR(SYSDATE,'DD-MON-YYYY'), 
                                    MDGDNIHREG = TO_CHAR(SYSDATE,'HH24:MI:SS'),
                                    MDGFCHLSTUPD = TO_CHAR(SYSDATE,'DD-MON-YYYY'), 
                                    MDGHRALSTUPD = TO_CHAR(SYSDATE,'HH24:MI:SS')
                                WHERE ESECOD = 1  AND  
                                      MDCCOD = 3  AND  
                                      SDGCOD = 1   AND
                                      MDGSERDOC = ".$Datos_NcaConv[$i]['NCAFACSERN']." AND 
                                      MDGNRODOC = ".$Datos_NcaConv[$i]['NCAFACNRO']);     
                }
                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR MDOCGLB RECIBOS ";
                    return $respuesta;
                }
                $i++;
            }

            // PARA INGRESAR LA NOTA DE DEBITO 
            $serie_rec_nota = 0;
            $nro_rec_nota = 0;
            $serie_nota_deb = 0;
            $nro_nota_deb = 0;
            if((float)$Datos_credito[0]['CLIINTER'] > 0  && count($Datos_ReciboConv) > 0 ){
                $tam_recibos = count($Datos_ReciboConv) - 1;
                $Max_nca = $this->max_Nca($Datos_ReciboConv[$tam_recibos]['FACSERNRO']);
                //BUSCO AL RECIBO  DEACUERDO A LA SERIE Y NUMERO 
                $DATO_RECIBO = $this->Busco_dato_recibo($Datos_ReciboConv[$tam_recibos]['FACSERNRO'], $Datos_ReciboConv[$tam_recibos]['FACNRO']); 
                if (count($DATO_RECIBO) > 0) {
                    $serie_rec_nota = (int)$Datos_ReciboConv[$tam_recibos]['FACSERNRO'];
                    $nro_rec_nota = (int)$Datos_ReciboConv[$tam_recibos]['FACNRO'];
                    $serie_nota_deb = (int)$Datos_ReciboConv[$tam_recibos]['FACSERNRO'];
                    $nro_nota_deb = (int)$Max_nca[0]['MAXIMO'] + 1;
                    $dato_Nca[0] = 'C'; // TIPO NOTA CREDITO 
                    $dato_Nca[1] = $Datos_ReciboConv[$tam_recibos]['FACSERNRO']; //(int)$oficina.$agencia; // SERIE DE RECIBO 
                    $dato_Nca[2] = (int)$Max_nca[0]['MAXIMO'] + 1; // NUMERO DE LA NOTA DE CREDITO 
                    $dato_Nca[3] = (int)$DATO_RECIBO[0]['FACSERNRO'];  
                    $dato_Nca[4] = (int)$DATO_RECIBO[0]['FACNRO'];
                    $dato_Nca[5] = $DATO_RECIBO[0]['FACEMIFEC'];
                    $dato_Nca[6] = $DATO_RECIBO[0]['FACVENFEC'];
                    $dato_Nca[7] = (int)$DATO_RECIBO[0]['PREMZN'];
                    $dato_Nca[8] = (int)$DATO_RECIBO[0]['PRELOTE'];
                    $dato_Nca[9] = (int)$DATO_RECIBO[0]['PREREGIOX'];
                    $dato_Nca[10] = (int)$DATO_RECIBO[0]['PRESECTOX'];
                    $dato_Nca[11] = (int)$DATO_RECIBO[0]['PRELOCALX'];
                    $dato_Nca[12] = (int)$DATO_RECIBO[0]['CLICODID'];
                    $dato_Nca[13] = (int)$DATO_RECIBO[0]['CLICODIGO'];  
                    $dato_Nca[14] = $DATO_RECIBO[0]['CLICODFAX'];
                    $dato_Nca[15] = $DATO_RECIBO[0]['FACCHEDIG'];
                    $dato_Nca[16] = $DATO_RECIBO[0]['FACTARIFA'];
                    $dato_Nca[17] = $DATO_RECIBO[0]['FSETIPCOD'];
                    $dato_Nca[18] = (int)$DATO_RECIBO[0]['FAMBITO'];
                    $dato_Nca[19] = (int)$DATO_RECIBO[0]['FCATEGO'];
                    $dato_Nca[20] = (int)$DATO_RECIBO[0]['FSUBCATE'];
                    $dato_Nca[21] = (int)$DATO_RECIBO[0]['FAGABSCOD'];
                    $dato_Nca[22] = (int)$DATO_RECIBO[0]['FDEABSCOD'];
                    $dato_Nca[23] = (int)$DATO_RECIBO[0]['FGRUCOD'];
                    $dato_Nca[24] = (int)$DATO_RECIBO[0]['FGRUSUB'];
                    $dato_Nca[25] = (int)$DATO_RECIBO[0]['FGRUPRNMOD'];
                    $dato_Nca[26] = $DATO_RECIBO[0]['FFLAGIGV'];
                    $dato_Nca[27] = (float)$DATO_RECIBO[0]['FACTOTSUB'];
                    $dato_Nca[28] = (float)$DATO_RECIBO[0]['FACIGV'];
                    $dato_Nca[29] = (float)$DATO_RECIBO[0]['FACTOTAL'];
                    $dato_Nca[30] = "C";
                    $dato_Nca[31] = (int)$DATO_RECIBO[0]['FACOFICOD'];
                    $dato_Nca[32] = (int)$DATO_RECIBO[0]['FACOFIAGE'];
                    $dato_Nca[33] = (int)$DATO_RECIBO[0]['FRUTA'];
                    $dato_Nca[34] = (int)$DATO_RECIBO[0]['FCICLO'];
                    $dato_Nca[35] = (int)$DATO_RECIBO[0]['FMEDIDOR'];
                    $dato_Nca[36] = (float)$DATO_RECIBO[0]['FACSALDO'];
                    $dato_Nca[37] = trim($DATO_RECIBO[0]['FACINISAL']);
                    $dato_Nca[38] = trim($DATO_RECIBO[0]['FACFINSAL']);
                    $dato_Nca[39] = (int)$oficina;
                    $dato_Nca[40] = (int)$agencia;
                    $dato_Nca[41] = (int)$Datos_credito[0]['DIGCOD'];
                    $dato_Nca[42] = (float)$Datos_credito[0]['CLIINTER'];
                    $dato_Nca[43] = (float)$Datos_credito[0]['CLIINTER'] + $DATO_RECIBO[0]['FACTOTSUB'];
                    $dato_Nca[44] = 0;
                    $dato_Nca[45] = (float)$DATO_RECIBO[0]['FACIGV'];
                    $dato_Nca[46] = (float)$Datos_credito[0]['CLIINTER'];
                    $dato_Nca[47] = $dato_Nca[43] + $DATO_RECIBO[0]['FACIGV'];
                    $dato_Nca[48] = (int)$DATO_RECIBO[0]['PREZONX'];
                    $dato_Nca[49] = "Conv-".$oficina."-".$agencia."-".$nro_credito;
                    $dato_Nca[50] = (int)$DATO_RECIBO[0]['FIGVREF'];
                    $dato_Nca[51] = $DATO_RECIBO[0]['SERVIDOR'];

                    $consulta = "INSERT INTO PRDDBFCOMERCIAL.NCA (
                                    NCATIPO, NCASERNRO, NCANRO, TOTFAC_FACSERNRO, TOTFAC_FACNRO,
                                    NCAFECHA, NCAFACEMIF, NCAFACVENF, NCAPREMZN, NCAPRELOTE,
                                    NCAPREREG, NCAPRESEC, NCAPRELOC, NCACLICODI, NCACLICOD,
                                    NCACLICODF, NCAFACCHED, NCAFACTARI, NCAFSETIPC, NCAFAMBITO,
                                    NCAFCATEGO, NCAFSUBCAT, NCAFAGABSC, NCAFDEABSC, NCAFGRUCOD, 
                                    NCAFGRUSUB,NCAFGRUPRN, NCAFFLAGIG, NCAFACTOTS, NCAFACIGV, 
                                    NCAFACTOTA,NCAFACESTA,  NCAFACOFIC, NCAFACOFIA, NCAFRUTA,
                                    NCAFCICLO,NCAFMEDIDO, NCAFACSALD, NCAFACINIS, NCAFACFINS, 
                                    NCAFICOD,NCAFIAGECO, NCADIGCOD, NCASUBDIF, NCASUBOK, 
                                    NCAIGVDIF,NCAIGVOK, NCATOTDIF, NCATOTOK, NCAPREZONX, 
                                    NCAREFE,NCAIGVREF, SERVIDOR
                                )
                                VALUES (
                                    ?, ?, ?, ?, ?,
                                    TO_CHAR(SYSDATE,'DD-MON-YYYY') , ?, ?, ?, ?,
                                    ?, ?, ?, ?, ?,
                                    ?, ?, ?, ?, ?,
                                    ?, ?, ?, ?, ?,
                                    ?, ?, ?, ?, ?,
                                    ?, ?, ?, ?, ?,
                                    ?, ?, ?, ?, ?,
                                    ?, ?, ?, ?, ?,
                                    ?, ?, ?, ?, ?,
                                    ?, ? ,? 
                                )";
                    $this->oracle->query( $consulta, $dato_Nca );
                    if($this->oracle->trans_status() === FALSE){
                        $this->oracle->trans_rollback();
                        $respuesta[0] = false;
                        $respuesta[1] = "OCURRIO UN ERROR AL INSERTAR EN EL DEUDA REC  ";
                        return $respuesta;
                    }

                    //CONSULTA PARA EL FACLIN
                    $DATO_FACLIN = $this->Busco_dato_Faclin($dato_Nca[3], $dato_Nca[4] );

                    if (count($DATO_FACLIN) > 0 ) {
                        $x = 0;
                        while($x < count($DATO_FACLIN) ){
                            $dato_nca1[0] = 'C';
                            $dato_nca1[1] = (int)$dato_Nca[1];
                            $dato_nca1[2] = (int)$dato_Nca[2];
                            $dato_nca1[3] = $DATO_FACLIN[$x]['FACLINRO'];
                            $dato_nca1[4] = 0;
                            $dato_nca1[5] = $DATO_FACLIN[$x]['FACVOLUM'];
                            $dato_nca1[6] = $DATO_FACLIN[$x]['FACPRECI'];
                            $dato_nca1[7] = 0;
                            $dato_nca1[8] = $DATO_FACLIN[$x]['FACPRECI'];
                            $dato_nca1[9] = 0;
                            $dato_nca1[10] = $DATO_FACLIN[$x]['CONCEP_FACCONCOD'];
                            $dato_nca1[11] = $DATO_FACLIN[$x]['SERVIDOR'];
            
                            $consulta = "INSERT INTO PRDDBFCOMERCIAL.NCA1 (
                                        NCA_NCATIPO, NCA_NCASERNRO, NCA_NCANRO, NCAFACLINR,
                                        CTAN, NCAFACVOLU, NCAFACPREC, NCAPREDIF, 
                                        NCAPREOK, DRC, CONCEP_FACCONCOD, SERVIDOR 
                                    )
                                    VALUES (
                                        ?, ?, ?, ?,
                                        ?, ?, ?, ?,
                                        ?, ?, ?, ?
                                    )";
                            $this->oracle->query( $consulta, $dato_nca1 );
                            if($this->oracle->trans_status() === FALSE){
                                $this->oracle->trans_rollback();
                                $respuesta[0] = false;
                                $respuesta[1] = "OCURRIO UN ERROR AL INSERTAR EN EL NCA1  ";
                                return $respuesta;
                            }
                            $x++;
                        }
                    }    
            
                    $DATO_LETFAC = $this->Busco_dato_Letfac($dato_Nca[3], $dato_Nca[4] );
            
                    if (count($DATO_LETFAC) > 0 ) {
                        $x=0;
                        while($x < count($DATO_LETFAC) ){
                                $dato_Nca2[0] = 'C';
                                $dato_Nca2[1] = (int)$dato_Nca[1];
                                $dato_Nca2[2] = (int)$dato_Nca[2];
                                $dato_Nca2[3] = $DATO_LETFAC[$x]['FACCUOLIN'];
                                $dato_Nca2[4] = $DATO_LETFAC[$x]['OFICOD'];
                                $dato_Nca2[5] = $DATO_LETFAC[$x]['OFIAGECOD'];
                                $dato_Nca2[6] = $DATO_LETFAC[$x]['CREDNRO'];
                                $dato_Nca2[7] = $DATO_LETFAC[$x]['LTNUM'];
                                $dato_Nca2[8] = $DATO_LETFAC[$x]['CRECUOMON'];
                                $dato_Nca2[9] = $DATO_LETFAC[$x]['CREFUENTE'];
                                $dato_Nca2[10] = $DATO_LETFAC[$x]['CRECUOFLA'];
                                $dato_Nca2[11] = $DATO_LETFAC[$x]['CONCEP_FACCONCOD'];
                                $dato_Nca2[12] = $DATO_LETFAC[$x]['CRECUONRO'];
                                $dato_Nca2[13] = 0;
                                $dato_Nca2[14] = $DATO_LETFAC[$x]['CRECUOMON'];
                                $dato_Nca2[15] = $DATO_LETFAC[$x]['DRC'];
                                $dato_Nca2[16] = $DATO_LETFAC[$x]['SERVIDOR'];
            
                                $consulta = "INSERT INTO PRDDBFCOMERCIAL.NCA2 (
                                        NCA_NCATIPO, NCA_NCASERNRO, NCA_NCANRO, NCAFACCUOL,
                                        NCAOFICOD, NCAOFIAGEC, NCACREDN, NCALTNUM, 
                                        NCACRECUOM, NCACREFUEN, NCACRECUOF, CONCEP_FACCONCOD, 
                                        NCACRECUON, NCAMONDIF, NCAMONOK, DRC, SERVIDOR
                                    )
                                    VALUES (
                                        ?, ?, ?, ?,
                                        ?, ?, ?, ?,
                                        ?, ?, ?, ?,
                                        ?, ?, ?, ?,
                                        ?
                                    )";
                                $this->oracle->query( $consulta, $dato_Nca2 );
                                if($this->oracle->trans_status() === FALSE){
                                    $this->oracle->trans_rollback();
                                    $respuesta[0] = false;
                                    $respuesta[1] = "OCURRIO UN ERROR AL INSERTAR EN EL NCA3  ";
                                    return $respuesta;
                                }
                                $x++;
                        }
                    }    
                    //INSERTO EN EL NCA3
                            
                    $dato_Nca3[0] = 'C';
                    $dato_Nca3[2] = (int)$dato_Nca[1];
                    $dato_Nca3[3] = (int)$dato_Nca[2];
                    $dato_Nca3[4] = 1;
                    $dato_Nca3[5] = $oficina;
                    $dato_Nca3[6] = $agencia;
                    $dato_Nca3[7] = 0;
                    $dato_Nca3[8] = 'C';
                    $dato_Nca3[9] = 846 ;
                    $dato_Nca3[10] = 0;
                    $dato_Nca3[11] ='I';
                    $dato_Nca3[12] = $dato_Nca[42];//(float)$int_moratorio;
                    $dato_Nca3[13] = $dato_Nca[42];//(float)$int_moratorio;
                    $dato_Nca3[14] = $servidor;
            
                    $consulta = "INSERT INTO PRDDBFCOMERCIAL.NCA3 (
                            NCA_NCATIPO, NCA_NCASERNRO, NCA_NCANRO, NCANOTLIN,
                            NCANOFICOD, NCANOFIAGE, NCANOTNRO, NCAFACNOTT,
                            CONCEP_FACCONCOD, NCAFACNOTM, NCANOTESTN, NCANMONDIF,
                            NCANMONOK, SERVIDOR
                        )
                        VALUES (
                                ?, ?, ?, ?,
                                ?, ?, ?, ?,
                                ?, ?, ?, ?,
                                ?, ?
                            )";
                    $this->oracle->query( $consulta, $dato_Nca3 );
                    if($this->oracle->trans_status() === FALSE){
                        $this->oracle->trans_rollback();
                        $respuesta[0] = false;
                        $respuesta[1] = "OCURRIO UN ERROR AL INSERTAR EN EL NCA3  ";
                        return $respuesta;
                    }
                }
                
            }
            // EN EL CONVLINK ACTUALIZO LA NOTA DE DEBITO 
            $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CONVLINK 
                                    SET 
                                    NDFACSERNR = ".$serie_rec_nota.", 
                                    NDFACNRO = ".$nro_rec_nota.", 
                                    NDEBSERIE = ".$serie_nota_deb.", 
                                    NDEBNUMERO = ".$nro_nota_deb."
                                WHERE  CREDIT_AGENCI_OFICIN_OFICOD = ".$oficina."  AND  
                                    CREDIT_AGENCI_OFIAGECOD = ".$agencia." AND  
                                    CREDIT_CREDNRO = ".$nro_credito);

            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                return $respuesta;
            }
            // ACTUALIZO EL REGISTRO DE PAGO 
            $resultado = $this->oracle->query("SELECT  CREDIT_AGENCI_OFICIN_OFICOD, CREDIT_AGENCI_OFIAGECOD, CREDIT_CREDNRO,
                                                        AMONRO, AMOFECHA, CLIUNICOD
                                                    FROM  PRDDBFCOMERCIAL.AMORTIZA
                                                    WHERE  CREDIT_AGENCI_OFICIN_OFICOD = ".$oficina."  AND  
                                                    CREDIT_AGENCI_OFIAGECOD = ".$agencia." AND  
                                                    CREDIT_CREDNRO = ".$nro_credito);
            $Datos_Amort_conv = $resultado->result_array();
            if(count($Datos_Amort_conv)>0){
                $this->oracle->query("UPDATE PRDRECAUDACIONORA12C.MDOCGLB 
                                    SET 
                                    SDGCOD= 2,
                                    MDGDNIFREG = TO_CHAR(SYSDATE,'DD-MON-YYYY'), 
                                    MDGDNIHREG = TO_CHAR(SYSDATE,'HH24:MI:SS'),
                                    MDGFCHLSTUPD = TO_CHAR(SYSDATE,'DD-MON-YYYY'), 
                                    MDGHRALSTUPD = TO_CHAR(SYSDATE,'HH24:MI:SS')
                                WHERE ESECOD = 1  AND  
                                    MDCCOD = 6 AND  
                                    MDGSERDOC = ".$oficina.$agencia." AND 
                                    MDGNRODOC = ".$Datos_Amort_conv[0]['AMONRO']);

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                    return $respuesta;
                }
            }

            $tip_doc = 6; 
            $ser_doc = $oficina.$agencia ;
            $nro_doc = $Datos_Amort_conv[0]['AMONRO'];
            $maximo_de_pagos = $this -> maximo_de_pagos($tip_doc, $ser_doc, $nro_doc);
            if( count($maximo_de_pagos) > 0 ){
                $maximo_de_pagos1 = $maximo_de_pagos[0]["NRO"] + 1 ;
            }else{
                $maximo_de_pagos1=1;
            }
            // ACTUALIZO EL PAGO 
            $this->oracle->query("INSERT INTO  PRDRECAUDACIONORA12C.OPAGOS
                                                ( ESECOD, MDCCOD, MDGSERDOC, MDGNRODOC, OPGNROOPE, OPGFCHREG, OPGHRAREG, OPGFCHPAG,
                                                    OPGHRAPAG, OPGFCHPEF, OPGHRAPEF, OPGIMPPAG, OPCCOD, ECOCOD, PTCCOD, CJACOD,
                                                    STECOCOD, VOEITEM, USRCOD, OPCJITM, TPGCOD, SPGCOD, OPGIMPCAR, OPGIMPINT, 
                                                    OPGIMPENT, OPGEMPVUE, OPGREFBO, OPGPAGINTSW, OPGPAGCARSW, OPGUSRAUX, OPGFCHAUX, OPGHRAAUX,
                                                    OPGADDIP) VALUES
                                                    ( ?, ?, ?, ?, ?,TO_CHAR(SYSDATE,'DD-MON-YYYY') ,TO_CHAR(SYSDATE,'HH24:MI:SS'),TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                                    TO_CHAR(SYSDATE,'HH24:MI:SS'), TO_CHAR(SYSDATE,'DD-MON-YYYY'),TO_CHAR(SYSDATE,'HH24:MI:SS'), ?, ?, ?, ?, ?,
                                                    ?, ?, ?, ?, ?, ?, ?, ?,
                                                    ?, ?, ?, ?, ?, ?, ?, ?,
                                                    ? )" ,
                                                array(1, 6, $ser_doc, $nro_doc,$maximo_de_pagos1,
                                                    $Datos_credito[0]['CTAINICIAL'],0, $dato_cajera[0]['ECOCOD'], $dato_cajera[0]['PTCCOD'], $dato_cajera[0]['CJACOD'],
                                                    $dato_cajera[0]['STECOCOD'], 1, $dato_cajera[0]['USRCOD'],0 ,1 ,1, 0, 0,
                                                    0, 0, 0, 0, 0, 0, NULL, NULL,
                                                    NULL ));
            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                return $respuesta;
            }
            // CAMBIO EL ESTADO DEL REGISTRO 
            $this->oracle->query("UPDATE PRDDBFCOMERCIAL.DEUDAREC 
                                    SET
                                    EST_PAGO  = 1,
                                    ESTADOACTA = 'I'
                                    WHERE OFICOD = ".$oficina."  AND  
                                        OFIAGECOD = ".$agencia." AND  
                                        CREDNRO = ".$nro_credito);

            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                return $respuesta;
            }
            $this->oracle->trans_commit();
            $respuesta[0] = true;
            return $respuesta;
        }else{
            $respuesta[0] = false;
            $respuesta[1] = "NO TIENE ACCESO PARA REALIZAR EL PAGO ";
            return $respuesta;
        }
    }
    public function Grabar_Credit($oficina,$agencia,$suministro, $inicial, $nro_cuota, $saldo, $descri_plan, $int_moratorio, $gasto_cobranza, $codigo_usuario,$observacion, $tabla_simulacion, $tasa_interes, $tasa_frc, $fecha_vencimiento, $tabla_SolRepre, $tabla_recibo, $tabla_deuda_anterior, $SERVIDOR, $observaciones , $numero_financimiento, $gerente,  $saldo_financiamiento){
        
        $i= 0;
        $importe_recibo = 0;
        $importe_nota_credito = 0;
        $importe_nota_debito = 0;
        $importe_letra_emitir = $saldo_financiamiento;

        while ( $i < count($tabla_recibo) ) {
            $importe_recibo = $importe_recibo + $tabla_recibo[$i]['Real'];
            $importe_nota_credito = $importe_nota_credito + $tabla_recibo[$i]['Not_cred'];
            $importe_nota_debito = $importe_nota_debito + $tabla_recibo[$i]['Not_deb'];
            $i++;
        }

        $servidor = trim($SERVIDOR);
        $numero_credit = $this->max_credit($oficina,$agencia);
        $maximo = (int)$numero_credit[0]["MAXIMO"] + 1 ;
        $datos[0]= $maximo;
        $datos[1]= $suministro;
        $datos[2]= $oficina;
        $datos[3]= $agencia;
        $datos[4]= "700"; //CONCEPTO
        $datos[5]= "A"; //  STATUS
        $datos[6]= "Z"; //  TIPO DE CREDITO
        $datos[7]= $inicial + $saldo;  // DEUDA TOTAL
        $datos[8]= $inicial;  // CUOTA INICIAL
        $datos[9]= $nro_cuota;  // NUMERO DE LETRAS 
        $datos[10]= (count($tabla_simulacion) > 0) ?  "1" : "0";  // SIGUIENTE CUOTA
        $datos[11]= "0";  // CRECLICOD
        $datos[12]= "0";  // CRECLICOD
        $datos[13]= "0";  // CRECLICOD
        $datos[14]= "0";  // CRECLICOD
        $datos[15]= "0";  // CRECLICOD
        $datos[16]= "0";  // CRECLICOD
        $datos[17]= "0";  // CRECLICOD
        $datos[18]= "0";  // CRECLICOD
        $datos[19]= $descri_plan;  // CRECLICOD
        $datos[20]= $int_moratorio; // CRECLICOD
        $datos[21]= $gasto_cobranza; // CRECLICOD
        $datos[22]= "0"; // CRECLICOD
        $datos[23]= "0"; // CRECLICOD
        $datos[24]= $codigo_usuario; // CRECLICOD
        $datos[25]= "0"; // CRECLICOD
        $datos[26]= "0"; // CRECLICOD
        $datos[27]= substr($descri_plan,0,10); // CREDREFE
        $datos[28]= $servidor;
        $datos[29]= $importe_recibo;
        $datos[30]= $importe_nota_credito;
        $datos[31]= $importe_nota_debito;
        $datos[32]= $importe_letra_emitir;
        $this->oracle->trans_begin();
        $consulta = "INSERT INTO PRDDBFCOMERCIAL.CREDIT ( CREDNRO, CLIUNICOD, CREDFECHA, 
                                    AGENCI_OFICIN_OFICOD , AGENCI_OFIAGECOD, CONCEP_FACCONCOD, 
                                    CREDSTATUS, CREDTIPO, DEUDATOTAL,
                                    CTAINICIAL, NROLTS, CREDSTFEC,
                                    SGTECUOTA, CRECLICOD, CREFINFTE,
                                    CRECUOFAC, CREFACIMP, CREPAGULT,
                                    CREPAGOFI, CREPAGAGE, CREPAGTOT,
                                    CREFINSAL, CREREFDOC, CLIINTER,
                                    CLGCOBZA, CREACCION, CREIGV,
                                    DIGCOD, LETRAS, NROLETRAS,
                                    CREDREFE , SERVIDOR, IMPRECIBO,
                                    IMPNC, IMPND, IMPLETXEMI)
                        VALUES ( ? , ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                 ? , ?, ?,
                                 ? , ?, ?,
                                 ? , ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                 ? , ?, ?, 
                                 ? , ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                 ? , ?, ?, 
                                 ? , ?, ?,
                                 ? , ?, ?,
                                 ? , ?, ?,
                                 ? , ?, ?,
                                 ? , ?, ? )";
        $this->oracle->query($consulta , $datos);

        if( $this->oracle->trans_status() === FALSE ){
            $this->oracle->trans_rollback();
            $respuesta[0] = false;
            $respuesta[1] = "OCURRIO UN ERROR AL GRABAR EN EL CREDIT DEL CONVENIO";
            $respuesta[2] = $this->oracle->error();
            return $respuesta;
        }

        $i = 0;
        $suma_interes = 0; 
        while ($i< count($tabla_simulacion)) {
            $suma_interes = $suma_interes + $tabla_simulacion[$i]["Int_comp"];
            $i++;
        }

        if(count($tabla_simulacion) > 0 && $suma_interes > 0 ){
            $maximo_int = $maximo + 1;
            $datos_int[0]= $maximo_int;
            $datos_int[1]= $suministro;
            $datos_int[2]= $oficina;
            $datos_int[3]= $agencia;
            $datos_int[4]= "847"; // CONCEPTO
            $datos_int[5]= "A"; //  STATUS
            $datos_int[6]= "Y"; //  TIPO DE CREDITO
            $datos_int[7]= $suma_interes;  // DEUDA TOTAL
            $datos_int[8]= "0";  // CUOTA INICIAL
            $datos_int[9]= $nro_cuota;  // NUMERO DE LETRAS 
            $datos_int[10]= "1";  // SIGUIENTE CUOTA
            $datos_int[11]= "0";  // CRECLICOD
            $datos_int[12]= "0";  // CRECLICOD
            $datos_int[13]= "0";  // CRECLICOD
            $datos_int[14]= "0";  // CRECLICOD
            $datos_int[15]= "0";  // CRECLICOD
            $datos_int[16]= "0";  // CRECLICOD
            $datos_int[17]= "0";  // CRECLICOD
            $datos_int[18]= "0";  // CRECLICOD
            $datos_int[19]= $descri_plan;  // CRECLICOD
            $datos_int[20]= "0"; // CLIINTER
            $datos_int[21]= "0"; // CLGCOBZA
            $datos_int[22]= "0"; // CREACCION
            $datos_int[23]= "0"; // CREIGV
            $datos_int[24]= $codigo_usuario; // DIGCOD
            $datos_int[25]= "0"; // LETRAS
            $datos_int[26]= "0"; // NROLETRAS
            $datos_int[27]= "Int. de Conv.".$oficina.'-'.$agencia.'-'.$maximo; // CREDREFE
            $datos_int[28]= $servidor;
            $consulta = "INSERT INTO PRDDBFCOMERCIAL.CREDIT ( CREDNRO, CLIUNICOD, CREDFECHA, 
                                        AGENCI_OFICIN_OFICOD , AGENCI_OFIAGECOD, CONCEP_FACCONCOD, 
                                        CREDSTATUS, CREDTIPO, DEUDATOTAL,
                                        CTAINICIAL, NROLTS, CREDSTFEC,
                                        SGTECUOTA, CRECLICOD, CREFINFTE,
                                        CRECUOFAC, CREFACIMP, CREPAGULT,
                                        CREPAGOFI, CREPAGAGE, CREPAGTOT,
                                        CREFINSAL, CREREFDOC, CLIINTER,
                                        CLGCOBZA, CREACCION, CREIGV,
                                        DIGCOD, LETRAS, NROLETRAS,
                                        CREDREFE , SERVIDOR)
                            VALUES ( ? , ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                    ? , ?, ?,
                                    ? , ?, ?,
                                    ? , ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                    ? , ?, ?, 
                                    ? , ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                    ? , ?, ?, 
                                    ? , ?, ?,
                                    ? , ?, ?,
                                    ? , ?, ?,
                                    ? , ?)";
        
            $this->oracle->query($consulta , $datos_int);
            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL GRABAR EN EL CREDIT DEL INTERES";
                return $respuesta;
            }
        }
        
        

        /* INSERTAMOS EN LETRAS */
        $i = 0; 
        $consulta_tabla = "";
        $saldo_interes = $suma_interes;
        while ($i< count($tabla_simulacion)) {
            //LETRAS DEL CONVENIO
            $dato_tabla[0] = $oficina;
            $dato_tabla[1] = $agencia;
            $dato_tabla[2] = $maximo;
            $dato_tabla[3] = $tabla_simulacion[$i]["Num_cuota"];
            $dato_tabla[4] = $tabla_simulacion[$i]["Saldo"];
            $dato_tabla[5] = $tabla_simulacion[$i]["Amort_Cap"];
            $dato_tabla[7] = $tabla_simulacion[$i]["Int_comp"];
            $dato_tabla[8] = "0";
            $dato_tabla[9] = "0";
            $dato_tabla[10] = "0";
            $dato_tabla[11] = $tabla_simulacion[$i]["Amort_Cap"];
            $dato_tabla[12] = $tabla_simulacion[$i]["Vencimiento"];
            $dato_tabla[13] = "A";
            $dato_tabla[14] = "0";
            $dato_tabla[15] = "0";
            $dato_tabla[16] = "0";
            $dato_tabla[17] = $servidor;
            $consulta_tabla = "INSERT INTO PRDDBFCOMERCIAL.LETRAS ( 
                        CREDIT_AGENCI_OFICIN_OFICOD, CREDIT_AGENCI_OFIAGECOD, CREDIT_CREDNRO,
                        LTNUM, LTSALDO, LTVALOR,
                        LTINTER, LTACCION, LTGACOBZ,
                        LTIGV, LTCUOTA, LTVENCIM,
                        LTSTATUS, LTSTAFEC, LTFECCANC,
                        FACSERNROX, FACNROX, FACCUOLIX,
                        SERVIDOR )
                        VALUES ( ? , ?, ? ,
                                 ? , ?, ? ,
                                 ? , ?, ? ,
                                 ? , ?, ? ,
                                 ? , TO_CHAR(SYSDATE,'DD-MON-YYYY'), TO_CHAR(SYSDATE,'DD-MON-YYYY') , 
                                 ? , ?, ? ,
                                 ?)" ; 

            $this->oracle->query($consulta_tabla , $dato_tabla);
            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL GRABAR EN EL LETRA DEL CONVENIO";
                return $respuesta;
            }
            // ********* FIN DE CONVENIO *************
            //LETRAS DE INTERES DE CONVENIO 
            //LETRAS DEL CONVENIO
            if($suma_interes > 0){
                $dato_tabla_int[0] = $oficina;
                $dato_tabla_int[1] = $agencia;
                $dato_tabla_int[2] = $maximo_int;
                $dato_tabla_int[3] = $tabla_simulacion[$i]["Num_cuota"];
                $dato_tabla_int[4] = $saldo_interes;
                $dato_tabla_int[5] = $tabla_simulacion[$i]["Int_comp"];
                $dato_tabla_int[7] = "0";
                $dato_tabla_int[8] = "0";
                $dato_tabla_int[9] = "0";
                $dato_tabla_int[10] = "0";
                $dato_tabla_int[11] = $tabla_simulacion[$i]["Int_comp"];
                $dato_tabla_int[12] = $tabla_simulacion[$i]["Vencimiento"];
                $dato_tabla_int[13] = "A";
                $dato_tabla_int[14] = "0";
                $dato_tabla_int[15] = "0";
                $dato_tabla_int[16] = "0";
                $dato_tabla_int[17] = $servidor;
                $consulta_tabla = "INSERT INTO PRDDBFCOMERCIAL.LETRAS ( 
                            CREDIT_AGENCI_OFICIN_OFICOD, CREDIT_AGENCI_OFIAGECOD, CREDIT_CREDNRO,
                            LTNUM, LTSALDO, LTVALOR,
                            LTINTER, LTACCION, LTGACOBZ,
                            LTIGV, LTCUOTA, LTVENCIM,
                            LTSTATUS, LTSTAFEC, LTFECCANC,
                            FACSERNROX, FACNROX, FACCUOLIX,
                            SERVIDOR )
                            VALUES ( ? , ?, ? ,
                                    ? , ?, ? ,
                                    ? , ?, ? ,
                                    ? , ?, ? ,
                                    ? , TO_CHAR(SYSDATE,'DD-MON-YYYY'), TO_CHAR(SYSDATE,'DD-MON-YYYY') , 
                                    ? , ?, ? ,
                                    ?)" ; 

                $this->oracle->query($consulta_tabla , $dato_tabla_int);
                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL GRABAR EN EL LETRA DEL INTERES";
                    return $respuesta;
                }  
                $saldo_interes = $saldo_interes - $tabla_simulacion[$i]["Int_comp"];
            }

            $i++;
        }

        

        // ACTUALIZAMOS TABLAS SI ES QUE TIENE DEUDA ANTERIOR 
        if(count($tabla_deuda_anterior)>0){
            $i = 0;
            while ($i < count($tabla_deuda_anterior)) {
                $Credito_anterior = $this -> Obtengo_credito_anterior($tabla_deuda_anterior[$i]['Credito'], $tabla_deuda_anterior[$i]['Oficina'], $tabla_deuda_anterior[$i]['Agencia']);
                $datos[0]= $Credito_anterior[0]['CREDNRO'];
                $datos[1]= $Credito_anterior[0]['CLIUNICOD'];
                $datos[2]= $Credito_anterior[0]['CREDFECHA'];
                $datos[3]= $Credito_anterior[0]['AGENCI_OFICIN_OFICOD'];
                $datos[4]= $Credito_anterior[0]['AGENCI_OFIAGECOD'];
                $datos[5]= $Credito_anterior[0]['CONCEP_FACCONCOD']; //CONCEPTO
                $datos[6]= $Credito_anterior[0]['CREDSTATUS']; //  STATUS
                $datos[7]= $Credito_anterior[0]['CREDTIPO']; //  TIPO DE CREDITO
                $datos[8]= $Credito_anterior[0]['DEUDATOTAL'];  // DEUDA TOTAL
                $datos[9]= $Credito_anterior[0]['CTAINICIAL'];  // CUOTA INICIAL
                $datos[10]= $Credito_anterior[0]['NROLTS'];  // NUMERO DE LETRAS 
                $datos[11]= $Credito_anterior[0]['CREDSTFEC']; //FECHA ESTADO
                $datos[12]= $Credito_anterior[0]['SGTECUOTA'];  // SIGUIENTE CUOTA
                $datos[13]= $Credito_anterior[0]['CRECLICOD'];   // CRECLICOD
                $datos[14]= $Credito_anterior[0]['CREFINFTE'];  // CREFINFTE
                $datos[15]= $Credito_anterior[0]['CRECUOFAC'];  // CRECUOFAC
                $datos[16]= $Credito_anterior[0]['CREFACIMP'];  // CREFACIMP
                $datos[17]= $Credito_anterior[0]['CREPAGULT'];  // CREPAGULT
                $datos[18]= $Credito_anterior[0]['CREPAGOFI'];  // CREPAGOFI
                $datos[19]= $Credito_anterior[0]['CREPAGAGE'];  // CREPAGAGE
                $datos[20]= $Credito_anterior[0]['CREPAGTOT'];  // CREPAGTOT
                $datos[21]= $Credito_anterior[0]['CREFINSAL'];  // CREFINSAL
                $datos[22]= $Credito_anterior[0]['CREREFDOC']; // CREREFDOC
                $datos[23]= $Credito_anterior[0]['CLIINTER']; // CLIINTER
                $datos[24]= $Credito_anterior[0]['CLGCOBZA']; // CLGCOBZA
                $datos[25]= $Credito_anterior[0]['CREACCION']; // CREACCION
                $datos[26]= $Credito_anterior[0]['CREIGV']; // CRECLICOD
                $datos[27]= $Credito_anterior[0]['DIGCOD']; // DIGCOD
                $datos[28]= $Credito_anterior[0]['LETRAS']; // LETRAS
                $datos[29]= $Credito_anterior[0]['NROLETRAS']; // NROLETRAS
                $datos[30]= $Credito_anterior[0]['CREDREFE']; // CREDREFE
                $datos[31]= $oficina;
                $datos[32]= $agencia;
                $datos[33]=$maximo;
                $datos[34]=$servidor;
                $consulta = "INSERT INTO PRDDBFCOMERCIAL.CREDCONV ( 
                                    CREDNRO, CLIUNICOD, CREDFECHA, 
                                    OFICOD , OFIAGECOD, CRECONCOD, 
                                    CREDSTATUS, CREDTIPO, DEUDATOTAL,
                                    CTAINICIAL, NROLTS, CREDSTFEC,
                                    SGTECUOTA, CRECLICOD, CREFINFTE,
                                    CRECUOFAC, CREFACIMP, CREPAGULT,
                                    CREPAGOFI, CREPAGAGE, CREPAGTOT,
                                    CREFINSAL, CREREFDOC, CLIINTER,
                                    CLGCOBZA, CREACCION, CREIGV,
                                    DIGCOD, LETRAS, NROLETRAS,
                                    CREDREFE, NOFICOD, NOFIAGECO, 
                                    NCREDNRO, NCREDFECHA, SERVIDOR )
                        VALUES ( ? , ?, ?,
                                 ? , ?, ?,
                                 ? , ?, ?,
                                 ? , ?, ?,
                                 ? , ?, ?, 
                                 ? , ?, ?,
                                 ? , ?, ?, 
                                 ? , ?, ?,
                                 ? , ?, ?,
                                 ? , ?, ?,
                                 ? , ?, ?,
                                 ? , TO_CHAR(SYSDATE,'DD-MON-YYYY'), ?)";

                $query = $this->oracle->query($consulta , $datos);

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL GRABAR EN EL CREDCOV  CUANDO TIENE DEUDAS PENDIENTES ";
                    return $respuesta;
                }

                //CAMBIO DE ESTADO AL CREDIT
                /*$this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT 
                                SET 
                                    CREDSTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                    CREDSTATUS= 'Z'
                                WHERE AGENCI_OFIAGECOD = ".$datos[4]." AND
                                    AGENCI_OFICIN_OFICOD = ".$datos[3]." AND
                                    CREDSTATUS= 'I' AND
                                    CREDNRO =".$datos[0]);

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL CREDIT DE CONVENIO CUANDO TIENE DEUDAS PENDIENTES ";
                    return $respuesta;
                }*/
                //CAMBIO DE ESTADO AL INTERES DEL CREDITO 
                $resultado = $this->oracle->query("SELECT  CREDSTATUS,  IOFICOD, IOFIAGECOD, ICREDNRO FROM  PRDDBFCOMERCIAL.CONVLINK  WHERE
                                      CREDIT_AGENCI_OFICIN_OFICOD = ".$datos[3]." AND 
                                      CREDIT_AGENCI_OFIAGECOD = ".$datos[4]." AND 
                                      CREDIT_CREDNRO =".$datos[0]);
                $Modi_interes = $resultado->result_array(); 
                if(count($Modi_interes) > 0){
                    
                    $inte_ofi = (int)$Modi_interes[0]['IOFICOD'] ;
                    $inte_age = (int)$Modi_interes[0]['IOFIAGECOD'] ;
                    $inte_numero = (int)$Modi_interes[0]['ICREDNRO'] ;
                    if($inte_ofi != 0 || $inte_age != 0 || $inte_numero != 0 ){
                        $Credito_anterior = $this -> Obtengo_credito_anterior($Modi_interes[0]["ICREDNRO"], $Modi_interes[0]["IOFICOD"], $Modi_interes[0]["IOFIAGECOD"]);
                        $datos1[0]= $Credito_anterior[0]['CREDNRO'];
                        $datos1[1]= $Credito_anterior[0]['CLIUNICOD'];
                        $datos1[2]= $Credito_anterior[0]['CREDFECHA'];
                        $datos1[3]= $Credito_anterior[0]['AGENCI_OFICIN_OFICOD'];
                        $datos1[4]= $Credito_anterior[0]['AGENCI_OFIAGECOD'];
                        $datos1[5]= $Credito_anterior[0]['CONCEP_FACCONCOD']; //CONCEPTO
                        $datos1[6]= $Credito_anterior[0]['CREDSTATUS']; //  STATUS
                        $datos1[7]= $Credito_anterior[0]['CREDTIPO']; //  TIPO DE CREDITO
                        $datos1[8]= $Credito_anterior[0]['DEUDATOTAL'];  // DEUDA TOTAL
                        $datos1[9]= $Credito_anterior[0]['CTAINICIAL'];  // CUOTA INICIAL
                        $datos1[10]= $Credito_anterior[0]['NROLTS'];  // NUMERO DE LETRAS 
                        $datos1[11]= $Credito_anterior[0]['CREDSTFEC']; //FECHA ESTADO
                        $datos1[12]= $Credito_anterior[0]['SGTECUOTA'];  // SIGUIENTE CUOTA
                        $datos1[13]= $Credito_anterior[0]['CRECLICOD'];   // CRECLICOD
                        $datos1[14]= $Credito_anterior[0]['CREFINFTE'];  // CREFINFTE
                        $datos1[15]= $Credito_anterior[0]['CRECUOFAC'];  // CRECUOFAC
                        $datos1[16]= $Credito_anterior[0]['CREFACIMP'];  // CREFACIMP
                        $datos1[17]= $Credito_anterior[0]['CREPAGULT'];  // CREPAGULT
                        $datos1[18]= $Credito_anterior[0]['CREPAGOFI'];  // CREPAGOFI
                        $datos1[19]= $Credito_anterior[0]['CREPAGAGE'];  // CREPAGAGE
                        $datos1[20]= $Credito_anterior[0]['CREPAGTOT'];  // CREPAGTOT
                        $datos1[21]= $Credito_anterior[0]['CREFINSAL'];  // CREFINSAL
                        $datos1[22]= $Credito_anterior[0]['CREREFDOC']; // CREREFDOC
                        $datos1[23]= $Credito_anterior[0]['CLIINTER']; // CLIINTER
                        $datos1[24]= $Credito_anterior[0]['CLGCOBZA']; // CLGCOBZA
                        $datos1[25]= $Credito_anterior[0]['CREACCION']; // CREACCION
                        $datos1[26]= $Credito_anterior[0]['CREIGV']; // CRECLICOD
                        $datos1[27]= $Credito_anterior[0]['DIGCOD']; // DIGCOD
                        $datos1[28]= $Credito_anterior[0]['LETRAS']; // LETRAS
                        $datos1[29]= $Credito_anterior[0]['NROLETRAS']; // NROLETRAS
                        $datos1[30]= substr($Credito_anterior[0]['CREDREFE'],0,19); // CREDREFE
                        $datos1[31]= $oficina;
                        $datos1[32]= $agencia;
                        $datos1[33]= (count($tabla_simulacion) > 0 && $suma_interes > 0 ) ? $maximo_int : $maximo;
                        $datos1[34]=$servidor;
                        $consulta = "INSERT INTO PRDDBFCOMERCIAL.CREDCONV ( 
                                            CREDNRO, CLIUNICOD, CREDFECHA, 
                                            OFICOD , OFIAGECOD, CRECONCOD, 
                                            CREDSTATUS, CREDTIPO, DEUDATOTAL,
                                            CTAINICIAL, NROLTS, CREDSTFEC,
                                            SGTECUOTA, CRECLICOD, CREFINFTE,
                                            CRECUOFAC, CREFACIMP, CREPAGULT,
                                            CREPAGOFI, CREPAGAGE, CREPAGTOT,
                                            CREFINSAL, CREREFDOC, CLIINTER,
                                            CLGCOBZA, CREACCION, CREIGV,
                                            DIGCOD, LETRAS, NROLETRAS,
                                            CREDREFE, NOFICOD, NOFIAGECO, 
                                            NCREDNRO, NCREDFECHA, SERVIDOR )
                                VALUES ( ? , ?, ?,
                                        ? , ?, ?,
                                        ? , ?, ?,
                                        ? , ?, ?,
                                        ? , ?, ?, 
                                        ? , ?, ?,
                                        ? , ?, ?, 
                                        ? , ?, ?,
                                        ? , ?, ?,
                                        ? , ?, ?,
                                        ? , ?, ?,
                                        ? , TO_CHAR(SYSDATE,'DD-MON-YYYY'), ?)";

                        $query = $this->oracle->query($consulta , $datos1);

                        if($this->oracle->trans_status() === FALSE){
                            $this->oracle->trans_rollback();
                            $respuesta[0] = false;
                            $respuesta[1] = "OCURRIO UN ERROR AL GRABAR EN EL CREDCOV  CUANDO TIENE DEUDAS PENDIENTES ";
                            return $respuesta;
                        }
                         //CAMBIO DE ESTADO AL INTERES DEL CREDIT
                        /*$this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT 
                                                SET 
                                                    CREDSTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                                    CREDSTATUS= 'A'
                                                WHERE AGENCI_OFIAGECOD = ".$Modi_interes[0]["IOFIAGECOD"]." AND
                                                    AGENCI_OFICIN_OFICOD = ".$Modi_interes[0]["IOFICOD"]." AND
                                                    CREDSTATUS= 'I' AND
                                                    CREDNRO =".$Modi_interes[0]["ICREDNRO"]);

                        if($this->oracle->trans_status() === FALSE){
                            $this->oracle->trans_rollback();
                            $respuesta[0] = false;
                            $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL CREDIT DEL INTERES CUANDO TIENE DEUDAS PENDIENTES ";
                            return $respuesta;
                        }*/

                        // INGRESAMOS LAS LETRAS PENDIENTES DE CADA UNA DE LAS CUOTAS SI ES QUE HUBIERA
                        $Letra_pendiente_interes = $this -> obtengo_NumCuotas($Modi_interes[0]["IOFICOD"],$Modi_interes[0]["IOFIAGECOD"],$Modi_interes[0]["ICREDNRO"]);
                        $x = 0;
                        //var_dump($Letra_pendiente_interes);
                        while ( $x < count($Letra_pendiente_interes)){
                            $dato_tabla_pen1[0] = $Letra_pendiente_interes[$x]['OFIC_CREDITO'];//OFIC_CREDITO
                            $dato_tabla_pen1[1] = $Letra_pendiente_interes[$x]['AGEN_CREDITO']; //AGEN_CREDITO
                            $dato_tabla_pen1[2] = $Letra_pendiente_interes[$x]['NROCREDITO']; //NROCREDITO
                            $dato_tabla_pen1[3] = $Letra_pendiente_interes[$x]['LTNUM']; //LTNUM
                            $dato_tabla_pen1[4] = $Letra_pendiente_interes[$x]['LTSALDO']; //LTSALDO
                            $dato_tabla_pen1[5] = $Letra_pendiente_interes[$x]['LTVALOR'];//LTVALOR
                            $dato_tabla_pen1[7] = $Letra_pendiente_interes[$x]['LTINTER']; //LTINTER
                            $dato_tabla_pen1[8] = $Letra_pendiente_interes[$x]['LTACCION']; //LTACCION
                            $dato_tabla_pen1[9] = $Letra_pendiente_interes[$x]['LTGACOBZ']; //LTGACOBZ
                            $dato_tabla_pen1[10] = $Letra_pendiente_interes[$x]['LTIGV']; //LTIGV
                            $dato_tabla_pen1[11] = $Letra_pendiente_interes[$x]['LTCUOTA']; //LTCUOTA
                            $dato_tabla_pen1[12] = $Letra_pendiente_interes[$x]['LTVENCIM']; //LTVENCIM
                            $dato_tabla_pen1[13] = $Letra_pendiente_interes[$x]['LTSTATUS']; //LTSTATUS
                            $dato_tabla_pen1[14] = $Letra_pendiente_interes[$x]['LTSTAFEC']; //LTSTAFEC
                            $dato_tabla_pen1[15] = $Letra_pendiente_interes[$x]['LTFECCANC']; //LTFECCANC
                            $dato_tabla_pen1[16] = $Letra_pendiente_interes[$x]['SERRECIBO']; //SERRECIBO
                            $dato_tabla_pen1[17] = $Letra_pendiente_interes[$x]['NRORECIBO']; //SERRECIBO
                            $dato_tabla_pen1[18] = $Letra_pendiente_interes[$x]['FACCUOLIX']; //SERRECIBO
                            $dato_tabla_pen1[19] = $servidor; // SERVIDOR
                            $dato_tabla_pen1[20] = $oficina;
                            $dato_tabla_pen1[21] = $agencia;
                            $dato_tabla_pen1[22] = (count($tabla_simulacion) > 0 && $suma_interes > 0 ) ?$maximo_int : $maximo;
                            $dato_tabla_pen1[23] = ($x+1);
                            $consulta_tabla = "INSERT INTO PRDDBFCOMERCIAL.LETRCONV ( 
                                OFICOD, OFIAGECOD, CREDNRO,
                                LTNUM, LTSALDO, LTVALOR,
                                LTINTER, LTACCION, LTGACOBZ,
                                LTIGV, LTCUOTA, LTVENCIM,
                                LTSTATUS, LTSTAFEC, LTFECCANC,
                                FACSERNROX, FACNROX, FACCUOLIX,
                                SERVIDOR , NOFICOD, NOFIAGECO,
                                NCREDNRO , NCREDFECHA, NLTNUM )
                                VALUES ( ? , ?, ? ,
                                        ? , ?, ? ,
                                        ? , ?, ? ,
                                        ? , ?, ? ,
                                        ? , ?, ? , 
                                        ? , ?, ? ,
                                        ? , ?, ? , 
                                        ? , TO_CHAR(SYSDATE,'DD-MON-YYYY'), ?)" ; 

                            $this->oracle->query($consulta_tabla , $dato_tabla_pen1);
                            if($this->oracle->trans_status() === FALSE){
                                $this->oracle->trans_rollback();
                                $respuesta[0] = false;
                                $respuesta[1] = "OCURRIO UN ERROR AL INSERTAR EN EL LETRAS CONV ";
                                return $respuesta;
                            }
                            
                            
                            $x++;
                        }

                    
                        //CAMBIO ESTADO DE LAS LETRAS
                        /*$this->oracle->query("UPDATE PRDDBFCOMERCIAL.LETRAS 
                                        SET 
                                        LTSTAFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                        LTSTATUS= 'A' 
                                        WHERE   CREDIT_AGENCI_OFICIN_OFICOD = ".$Modi_interes[0]["IOFICOD"]." AND 
                                                CREDIT_AGENCI_OFIAGECOD =".$Modi_interes[0]["IOFIAGECOD"]." AND  
                                                CREDIT_CREDNRO = ".$Modi_interes[0]["ICREDNRO"]." AND
                                                LTSTATUS = 'I' ");

                        if($this->oracle->trans_status() === FALSE){
                                $this->oracle->trans_rollback();
                                $respuesta[0] = false;
                                $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL LETRAS ";
                                return $respuesta;
                        }*/
                    }
                    
                   
                    
                }

                // INGRESAMOS LAS LETRAS PENDIENTES DE CADA UNA DE LAS CUOTAS SI ES QUE HUBIERA
                $Letra_pendiente = $this -> obtengo_NumCuotas($datos[3],$datos[4],$datos[0]);
                $y = 0;
                while ( $y < count($Letra_pendiente)){

                    $dato_tabla_pen[0] = $Letra_pendiente[$y]['OFIC_CREDITO'];//OFIC_CREDITO
                    $dato_tabla_pen[1] = $Letra_pendiente[$y]['AGEN_CREDITO']; //AGEN_CREDITO
                    $dato_tabla_pen[2] = $Letra_pendiente[$y]['NROCREDITO']; //NROCREDITO
                    $dato_tabla_pen[3] = $Letra_pendiente[$y]['LTNUM']; //LTNUM
                    $dato_tabla_pen[4] = $Letra_pendiente[$y]['LTSALDO']; //LTSALDO
                    $dato_tabla_pen[5] = $Letra_pendiente[$y]['LTVALOR'];//LTVALOR
                    $dato_tabla_pen[7] = $Letra_pendiente[$y]['LTINTER']; //LTINTER
                    $dato_tabla_pen[8] = $Letra_pendiente[$y]['LTACCION']; //LTACCION
                    $dato_tabla_pen[9] = $Letra_pendiente[$y]['LTGACOBZ']; //LTGACOBZ
                    $dato_tabla_pen[10] = $Letra_pendiente[$y]['LTIGV']; //LTIGV
                    $dato_tabla_pen[11] = $Letra_pendiente[$y]['LTCUOTA']; //LTCUOTA
                    $dato_tabla_pen[12] = $Letra_pendiente[$y]['LTVENCIM']; //LTVENCIM
                    $dato_tabla_pen[13] = $Letra_pendiente[$y]['LTSTATUS']; //LTSTATUS
                    $dato_tabla_pen[14] = $Letra_pendiente[$y]['LTSTAFEC']; //LTSTAFEC
                    $dato_tabla_pen[15] = $Letra_pendiente[$y]['LTFECCANC']; //LTFECCANC
                    $dato_tabla_pen[16] = $Letra_pendiente[$y]['SERRECIBO']; //SERRECIBO
                    $dato_tabla_pen[17] = $Letra_pendiente[$y]['NRORECIBO']; //SERRECIBO
                    $dato_tabla_pen[18] = $Letra_pendiente[$y]['FACCUOLIX']; //SERRECIBO
                    $dato_tabla_pen[19] = $servidor; // SERVIDOR
                    $dato_tabla_pen[20] = $oficina;
                    $dato_tabla_pen[21] = $agencia;
                    $dato_tabla_pen[22] = $maximo;
                    $dato_tabla_pen[23] = "0";
                    $consulta_tabla = "INSERT INTO PRDDBFCOMERCIAL.LETRCONV ( 
                            OFICOD, OFIAGECOD, CREDNRO,
                            LTNUM, LTSALDO, LTVALOR,
                            LTINTER, LTACCION, LTGACOBZ,
                            LTIGV, LTCUOTA, LTVENCIM,
                            LTSTATUS, LTSTAFEC, LTFECCANC,
                            FACSERNROX, FACNROX, FACCUOLIX,
                            SERVIDOR , NOFICOD, NOFIAGECO,
                            NCREDNRO , NCREDFECHA, NLTNUM )
                            VALUES ( ? , ?, ? ,
                                    ? , ?, ? ,
                                    ? , ?, ? ,
                                    ? , ?, ? ,
                                    ? , ?, ? , 
                                    ? , ?, ? ,
                                    ? , ?, ? , 
                                    ? , TO_CHAR(SYSDATE,'DD-MON-YYYY'), ?)" ; 

                    $this->oracle->query($consulta_tabla , $dato_tabla_pen);
                    if($this->oracle->trans_status() === FALSE){
                        $this->oracle->trans_rollback();
                        $respuesta[0] = false;
                        $respuesta[1] = "OCURRIO UN ERROR AL INSERTAR EN EL LETRAS CONV ";
                        return $respuesta;
                    }

                    

                    $y++;
                }

                //CAMBIO ESTADO DE LAS LETRAS

                /*$this->oracle->query("UPDATE PRDDBFCOMERCIAL.LETRAS 
                SET 
                LTSTAFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                LTSTATUS= 'Z' 
                WHERE   CREDIT_AGENCI_OFICIN_OFICOD = ".$datos[3]." AND 
                        CREDIT_AGENCI_OFIAGECOD =".$datos[4]." AND  
                        CREDIT_CREDNRO = ".$datos[0]." AND
                        LTSTATUS = 'I' ");

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EL LETRAS CUANDO TIENE DEUDAS PENDIENTES ";
                    return $respuesta;
                }*/
                $i++;
            }
            
        }

        //******** FIN DEL CREDCONV ***************
        $numero_Amortiza = $this->max_Amortiza($oficina,$agencia);
        $max_Amortiza = (int)$numero_Amortiza[0]["MAXIMO"] + 1 ;
        $dato_amortiza[0] = (int)$oficina;
        $dato_amortiza[1] = (int)$agencia;
        $dato_amortiza[2] = (int)$maximo;
        $dato_amortiza[3] = (int)$max_Amortiza;
        //agrego fecha
        $dato_amortiza[4] = "'".$suministro."'";
        $dato_amortiza[5] = (float)$inicial;
        $dato_amortiza[6] = "'A'";
        $dato_amortiza[7] = "1";
        $dato_amortiza[8] = $codigo_usuario;
        $dato_amortiza[9] = (int)($oficina.$agencia);
        $dato_amortiza[10] = "'A'";
        //agrego fecha
        $dato_amortiza[11] = "'0'";
        $dato_amortiza[12] = "'0'";
        $dato_amortiza[13] = "'0'";
        $dato_amortiza[14] = "'0'";
        //$dato_amortiza[15] = "'".$_SESSION['OFICINA']."'";
        $dato_amortiza[15] = "'".$servidor."'";
        $consulta_amortiza = "INSERT INTO PRDDBFCOMERCIAL.AMORTIZA ( 
                       CREDIT_AGENCI_OFICIN_OFICOD, CREDIT_AGENCI_OFIAGECOD, CREDIT_CREDNRO,
                       AMONRO, AMOFECHA, CLIUNICOD,
                       AMOMONTO, AMOEST, OPETIPO,
                       DIGCOD, AMOSERIE, AMOFLAG,
                       AMOESTFEC, OFIPAG, OFAPAG,
                       DIGPAG, AMOTICKT, SERVIDOR
                    )
                        VALUES ( ".$dato_amortiza[0].", ".$dato_amortiza[1].", ".$dato_amortiza[2].",
                                 ".$dato_amortiza[3].", TO_CHAR(SYSDATE,'DD-MON-YYYY'), ".$dato_amortiza[4].",
                                 ".$dato_amortiza[5].", ".$dato_amortiza[6].", ".$dato_amortiza[7].",
                                 ".$dato_amortiza[8].", ".$dato_amortiza[9].", ".$dato_amortiza[10].",
                                 TO_CHAR(SYSDATE,'DD-MON-YYYY'), ".$dato_amortiza[11].", ".$dato_amortiza[12].",
                                 ".$dato_amortiza[13].", ".$dato_amortiza[14].", ".$dato_amortiza[15]." )" ; 
        $this->oracle->query($consulta_amortiza );
        if($this->oracle->trans_status() === FALSE){
            $this->oracle->trans_rollback();
            $respuesta[0] = false;
            $respuesta[1] = "OCURRIO UN ERROR AL INSERTAR EN EL AMORTIZA";
            return $respuesta;
        }

        

        // INSERSION EN EL TOTFCONV DE LOS RECIBOS 
        //extraigo las notas de credito o debito pendientes 
        $nota_credito_debito = $this->buscar_nota_credito_debito($suministro);
        
        $i= 0;
        while ($i < count($tabla_recibo)) {
            $result_tot = $this->oracle->query("SELECT  CLICODFAX, FACSERNRO, FACNRO, FACEMIFEC, FACTOTAL, FACESTADO, 
                                                        FACESTFECH, FLAGNOTA, FACTOTSUB, FACIGV, SERVIDOR 
                                                FROM  PRDDBFCOMERCIAL.TOTFAC  
                                                WHERE FACSERNRO = ".$tabla_recibo[$i]['Serie']." AND FACNRO = ".$tabla_recibo[$i]['Nro']);
            $result_totfac = $result_tot->result_array();
            if(count($result_totfac)>0){
                $dato_totfconv[0] = $result_totfac[0]['CLICODFAX'];
                $dato_totfconv[1] = $result_totfac[0]['FACSERNRO'];
                $dato_totfconv[2] = $result_totfac[0]['FACNRO'];
                $dato_totfconv[3] = $result_totfac[0]['FACEMIFEC'];
                $dato_totfconv[4] = $result_totfac[0]['FACTOTAL'];
                $dato_totfconv[5] = $result_totfac[0]['FACESTADO'];
                $dato_totfconv[6] = $result_totfac[0]['FACESTFECH'];
                $dato_totfconv[7] = $result_totfac[0]['FLAGNOTA'];
                $dato_totfconv[8] = $oficina;
                $dato_totfconv[9] = $agencia;
                $dato_totfconv[10] = $maximo;
                $dato_totfconv[11] = ( count($tabla_simulacion) > 0 && $suma_interes > 0 ) ? $maximo_int:0;
                $dato_totfconv[12] = $_SESSION['login'];
                $dato_totfconv[13] = $result_totfac[0]['FACTOTSUB'];
                $dato_totfconv[14] = $result_totfac[0]['FACIGV'];
                $dato_totfconv[15] = $result_totfac[0]['SERVIDOR'];
                $dato_totfconv[16] = $tabla_recibo[$i]['Int_moratorio'];
                $consulta = "INSERT INTO PRDDBFCOMERCIAL.TOTFCONV ( CLICODFAX, FACSERNRO, FACNRO,
                                                                        FACEMIFEC, FACTOTAL, FACESTADO, 
                                                                        FACESTFECH, FLAGNOTA, OFICOD, 
                                                                        OFIAGECOD, CREDNRO, CREDFECHA, 
                                                                        CREDNROINT, XUSUARIO, FACTOTSUB, 
                                                                        FACIGV, SERVIDOR, IMPINTMOR  )
                                VALUES ( ? , ?, ?,
                                        ? , ?, ?,
                                        ? , ?, ?,
                                        ? , ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                        ? , ?, ?, 
                                        ? , ?, ?)";
                $this->oracle->query($consulta , $dato_totfconv);

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL INSERTAR EN EL TOTAL CONV CUANDO TIENE RECIBOS PENDIENTES ";
                    return $respuesta;
                }
            }
            
            /* ***************** */
            
            if( count($nota_credito_debito) > 0 ){
                $j = 0 ;    
              // var_dump($nota_credito_debito);
                while($j < count($nota_credito_debito) ){
                    if($nota_credito_debito[$j]['FACNRO']== $tabla_recibo[$i]['Nro'] && $nota_credito_debito[$j]['FACSERNRO']== $tabla_recibo[$i]['Serie'] ){
                        
                        // HAGO EL INSERTADO 
                        $nca_cred_debito[0] = $nota_credito_debito[$j]['NCATIPO'];
                        $nca_cred_debito[1] = $nota_credito_debito[$j]['NCASERNRO'];
                        $nca_cred_debito[2] = $nota_credito_debito[$j]['NCANRO'];
                        $nca_cred_debito[3] = $nota_credito_debito[$j]['TOTFAC_FACSERNRO'];
                        $nca_cred_debito[4] = $nota_credito_debito[$j]['TOTFAC_FACNRO']; 
                        $nca_cred_debito[5] = $nota_credito_debito[$j]['NCAFECHA'];
                        $nca_cred_debito[6] = $nota_credito_debito[$j]['NCAFACEMIF'];
                        $nca_cred_debito[7] = $nota_credito_debito[$j]['NCAFACVENF'];
                        $nca_cred_debito[8] = $nota_credito_debito[$j]['NCAPREMZN'];
                        $nca_cred_debito[9] = $nota_credito_debito[$j]['NCAPRELOTE'];
                        //----
                        $nca_cred_debito[10] = $nota_credito_debito[$j]['NCAPREREG'];
                        $nca_cred_debito[11] = $nota_credito_debito[$j]['NCAPRESEC'];
                        $nca_cred_debito[12] = $nota_credito_debito[$j]['NCAPRELOC'];
                        $nca_cred_debito[13] = $nota_credito_debito[$j]['NCACLICODI'];
                        $nca_cred_debito[14] = $nota_credito_debito[$j]['NCACLICOD'];
                        $nca_cred_debito[15] = $nota_credito_debito[$j]['NCACLICODF'];
                        $nca_cred_debito[16] = $nota_credito_debito[$j]['NCAFACCHED'];
                        $nca_cred_debito[17] = $nota_credito_debito[$j]['NCAFACTARI'];
                        $nca_cred_debito[18] = $nota_credito_debito[$j]['NCAFSETIPC'];
                        $nca_cred_debito[19] = $nota_credito_debito[$j]['NCAFAMBITO'];
                        //--
                        $nca_cred_debito[20] = $nota_credito_debito[$j]['NCAFCATEGO'];
                        $nca_cred_debito[21] = $nota_credito_debito[$j]['NCAFSUBCAT'];
                        $nca_cred_debito[22] = $nota_credito_debito[$j]['NCAFAGABSC'];
                        $nca_cred_debito[23] = $nota_credito_debito[$j]['NCAFDEABSC'];
                        $nca_cred_debito[24] = $nota_credito_debito[$j]['NCAFGRUCOD']; 
                        $nca_cred_debito[25] = $nota_credito_debito[$j]['NCAFGRUSUB'];
                        $nca_cred_debito[26] = $nota_credito_debito[$j]['NCAFGRUPRN'];
                        $nca_cred_debito[27] = $nota_credito_debito[$j]['NCAFFLAGIG'];
                        $nca_cred_debito[28] = $nota_credito_debito[$j]['NCAFACTOTS'];
                        $nca_cred_debito[29] = $nota_credito_debito[$j]['NCAFACIGV'];
                        //----
                        $nca_cred_debito[30] = $nota_credito_debito[$j]['NCAFACTOTA'];
                        $nca_cred_debito[31] = $nota_credito_debito[$j]['NCAFACESTA'];
                        $nca_cred_debito[32] = $nota_credito_debito[$j]['NCAFACESTF'];
                        $nca_cred_debito[33] = $nota_credito_debito[$j]['NCAFACOFIC'];
                        $nca_cred_debito[34] = $nota_credito_debito[$j]['NCAFACOFIA']; 
                        $nca_cred_debito[35] = $nota_credito_debito[$j]['NCAFRUTA'];
                        $nca_cred_debito[36] = $nota_credito_debito[$j]['NCAFCICLO'];
                        $nca_cred_debito[37] = $nota_credito_debito[$j]['NCAFMEDIDO'];
                        $nca_cred_debito[38] = $nota_credito_debito[$j]['NCAFACSALD'];
                        $nca_cred_debito[39] = $nota_credito_debito[$j]['NCAFACINIS'];
                        // -----------
                        $nca_cred_debito[40] = $nota_credito_debito[$j]['NCAFACFINS'];
                        $nca_cred_debito[41] = $nota_credito_debito[$j]['NCAFICOD'];
                        $nca_cred_debito[42] = $nota_credito_debito[$j]['NCAFIAGECO'];
                        $nca_cred_debito[43] = $nota_credito_debito[$j]['NCADIGCOD'];
                        $nca_cred_debito[44] = $nota_credito_debito[$j]['NCASUBDIF']; 
                        $nca_cred_debito[45] = $nota_credito_debito[$j]['NCASUBOK'];
                        $nca_cred_debito[46] = $nota_credito_debito[$j]['NCAIGVDIF'];
                        $nca_cred_debito[47] = $nota_credito_debito[$j]['NCAIGVOK'];
                        $nca_cred_debito[48] = $nota_credito_debito[$j]['NCATOTDIF'];
                        $nca_cred_debito[49] = $nota_credito_debito[$j]['NCATOTOK'];
                        //-----------

                        $nca_cred_debito[50] = $nota_credito_debito[$j]['NCASALDIF'];
                        $nca_cred_debito[51] = $nota_credito_debito[$j]['NCASALOK'];
                        $nca_cred_debito[52] = $nota_credito_debito[$j]['NCAPREZONX'];
                        $nca_cred_debito[53] = $nota_credito_debito[$j]['NCAINTERES'];
                        $nca_cred_debito[54] = $nota_credito_debito[$j]['NCAGASTOS']; 
                        $nca_cred_debito[55] = substr($nota_credito_debito[$j]['NCAREFE'], 0, 58) ;
                        $nca_cred_debito[56] = $nota_credito_debito[$j]['NCA1'];
                        $nca_cred_debito[57] = $nota_credito_debito[$j]['NCA2'];
                        $nca_cred_debito[58] = $nota_credito_debito[$j]['NCA3'];
                        $nca_cred_debito[59] = $nota_credito_debito[$j]['DRC'];
                        //------
                        $nca_cred_debito[60] = $nota_credito_debito[$j]['REC_NRO'];
                        $nca_cred_debito[61] = $nota_credito_debito[$j]['REC_TIP'];
                        $nca_cred_debito[62] = $nota_credito_debito[$j]['AUT_OFI'];
                        $nca_cred_debito[63] = $nota_credito_debito[$j]['AUT_AGE'];
                        $nca_cred_debito[64] = $nota_credito_debito[$j]['AUT_NRO']; 
                        $nca_cred_debito[65] = $nota_credito_debito[$j]['MSV_TIP'];
                        $nca_cred_debito[66] = $nota_credito_debito[$j]['NCACREA'];
                        $nca_cred_debito[67] = $oficina;
                        $nca_cred_debito[68] = $agencia; 
                        $nca_cred_debito[69] = $maximo;
                        $nca_cred_debito[70] = $servidor;
                        
                        $consulta = "INSERT INTO PRDDBFCOMERCIAL.NCACONV ( 
                                                                    NCATIPO, NCASERNRO, NCANRO, NCAFACSERN, NCAFACNRO,
                                                                    NCAFECHA, NCAFACEMIF, NCAFACVENF, NCAPREMZN, NCAPRELOTE, 
                                                                    NCAPREREG, NCAPRESEC, NCAPRELOC, NCACLICODI, NCACLICOD, 
                                                                    NCACLICODF, NCAFACCHED, NCAFACTARI, NCAFSETIPC, NCAFAMBITO, 
                                                                    NCAFCATEGO, NCAFSUBCAT, NCAFAGABSC, NCAFDEABSC, NCAFGRUCOD,
                                                                    NCAFGRUSUB, NCAFGRUPRN, NCAFFLAGIG, NCAFACTOTS, NCAFACIGV,
                                                                    NCAFACTOTA, NCAFACESTA, NCAFACESTF, NCAFACOFIC, NCAFACOFIA,
                                                                    NCAFRUTA, NCAFCICLO, NCAFMEDIDO, NCAFACSALD, NCAFACINIS,
                                                                    NCAFACFINS, NCAFICOD, NCAFIAGECO, NCADIGCOD, NCASUBDIF,
                                                                    NCASUBOK, NCAIGVDIF, NCAIGVOK, NCATOTDIF, NCATOTOK,
                                                                    NCASALDIF, NCASALOK, NCAPREZONX, NCAINTERES, NCAGASTOS,
                                                                    NCAREFE, NCA1, NCA2, NCA3, DRC,
                                                                    REC_NRO, REC_TIP, AUT_OFI, AUT_AGE, AUT_NRO,
                                                                    MSV_TIP, NCACREA, NOFICOD, NOFIAGECO, NCREDNRO, 
                                                                    NCREDFECHA, SERVIDOR )
                            VALUES ( ?, ?, ?, ?, ?,
                                     ?, ?, ?, ?, ?,
                                     ?, ?, ?, ?, ?,
                                     ?, ?, ?, ?, ?,
                                     ?, ?, ?, ?, ?,
                                     ?, ?, ?, ?, ?,
                                     ?, ?, ?, ?, ?,
                                     ?, ?, ?, ?, ?,
                                     ?, ?, ?, ?, ?,
                                     ?, ?, ?, ?, ?,
                                     ?, ?, ?, ?, ?,
                                     ?, ?, ?, ?, ?,
                                     ?, ?, ?, ?, ?,
                                     ?, ?, ?, ?, ?,
                                     TO_CHAR(SYSDATE,'DD-MON-YYYY'), ?
                                    )";
                        $this->oracle->query($consulta , $nca_cred_debito);
                        if($this->oracle->trans_status() === FALSE){
                            $this->oracle->trans_rollback();
                            $respuesta[0] = false;
                            $respuesta[1] = "OCURRIO UN ERROR AL INSERTAR EN EL TOTAL CONV CUANDO TIENE RECIBOS PENDIENTES ";
                            return $respuesta;
                        } 
                        
                        

                        //break;
                    }
                    
                    $j++;
                }
            }

            $i++;
        }
        
        
        // Esta seccion es para el NCA 
        $serie_rec_nota = 0;
        $nro_rec_nota = 0;
        $serie_nota_deb = 0;
        $nro_nota_deb = 0;
        /*if((float)$int_moratorio > 0  && count($tabla_recibo) > 0 ){
            $Max_nca = $this->max_Nca($tabla_recibo[($i-1)]['Serie']);
            //var_dump( $tabla_recibo[($i-1)]['Serie'].$tabla_recibo[($i-1)]['Nro'] );
            //BUSCO AL RECIBO  DEACUERDO A LA SERIE Y NUMERO 
            $DATO_RECIBO = $this->Busco_dato_recibo($tabla_recibo[($i-1)]['Serie'], $tabla_recibo[($i-1)]['Nro']);
                

            //var_dump((int)$Max_nca[0]['MAXIMO']);
            if (count($DATO_RECIBO) > 0) {
                $serie_rec_nota = (int)$tabla_recibo[($i-1)]['Serie'];
                $nro_rec_nota = (int)$tabla_recibo[($i-1)]['Nro'];
                $serie_nota_deb = (int)$tabla_recibo[($i-1)]['Serie'];
                $nro_nota_deb = (int)$Max_nca[0]['MAXIMO'] + 1;
                $dato_Nca[0] = 'C'; // TIPO NOTA CREDITO 
                $dato_Nca[1] = $tabla_recibo[($i-1)]['Serie']; //(int)$oficina.$agencia; // SERIE DE RECIBO 
                $dato_Nca[2] = (int)$Max_nca[0]['MAXIMO'] + 1; // NUMERO DE LA NOTA DE CREDITO 
                $dato_Nca[3] = (int)$DATO_RECIBO[0]['FACSERNRO'];  
                $dato_Nca[4] = (int)$DATO_RECIBO[0]['FACNRO'];
                $dato_Nca[5] = $DATO_RECIBO[0]['FACEMIFEC'];
                $dato_Nca[6] = $DATO_RECIBO[0]['FACVENFEC'];
                $dato_Nca[7] = (int)$DATO_RECIBO[0]['PREMZN'];
                $dato_Nca[8] = (int)$DATO_RECIBO[0]['PRELOTE'];
                $dato_Nca[9] = (int)$DATO_RECIBO[0]['PREREGIOX'];
                $dato_Nca[10] = (int)$DATO_RECIBO[0]['PRESECTOX'];
                $dato_Nca[11] = (int)$DATO_RECIBO[0]['PRELOCALX'];
                $dato_Nca[12] = (int)$DATO_RECIBO[0]['CLICODID'];
                $dato_Nca[13] = (int)$DATO_RECIBO[0]['CLICODIGO'];  
                $dato_Nca[14] = $DATO_RECIBO[0]['CLICODFAX'];
                $dato_Nca[15] = $DATO_RECIBO[0]['FACCHEDIG'];
                $dato_Nca[16] = $DATO_RECIBO[0]['FACTARIFA'];
                $dato_Nca[17] = $DATO_RECIBO[0]['FSETIPCOD'];
                $dato_Nca[18] = (int)$DATO_RECIBO[0]['FAMBITO'];
                $dato_Nca[19] = (int)$DATO_RECIBO[0]['FCATEGO'];
                $dato_Nca[20] = (int)$DATO_RECIBO[0]['FSUBCATE'];
                $dato_Nca[21] = (int)$DATO_RECIBO[0]['FAGABSCOD'];
                $dato_Nca[22] = (int)$DATO_RECIBO[0]['FDEABSCOD'];
                $dato_Nca[23] = (int)$DATO_RECIBO[0]['FGRUCOD'];
                $dato_Nca[24] = (int)$DATO_RECIBO[0]['FGRUSUB'];
                $dato_Nca[25] = (int)$DATO_RECIBO[0]['FGRUPRNMOD'];
                $dato_Nca[26] = $DATO_RECIBO[0]['FFLAGIGV'];
                $dato_Nca[27] = (float)$DATO_RECIBO[0]['FACTOTSUB'];
                $dato_Nca[28] = (float)$DATO_RECIBO[0]['FACIGV'];
                $dato_Nca[29] = (float)$DATO_RECIBO[0]['FACTOTAL'];
                $dato_Nca[30] = "C";
                $dato_Nca[31] = (int)$DATO_RECIBO[0]['FACOFICOD'];
                $dato_Nca[32] = (int)$DATO_RECIBO[0]['FACOFIAGE'];
                $dato_Nca[33] = (int)$DATO_RECIBO[0]['FRUTA'];
                $dato_Nca[34] = (int)$DATO_RECIBO[0]['FCICLO'];
                $dato_Nca[35] = (int)$DATO_RECIBO[0]['FMEDIDOR'];
                $dato_Nca[36] = (float)$DATO_RECIBO[0]['FACSALDO'];
                $dato_Nca[37] = trim($DATO_RECIBO[0]['FACINISAL']);
                $dato_Nca[38] = trim($DATO_RECIBO[0]['FACFINSAL']);
                $dato_Nca[39] = (int)$oficina;
                $dato_Nca[40] = (int)$agencia;
                $dato_Nca[41] = (int)$_SESSION['user_comercial'];
                $dato_Nca[42] = (float)$int_moratorio;
                $dato_Nca[43] = (float)$int_moratorio + $DATO_RECIBO[0]['FACTOTSUB'];
                $dato_Nca[44] = 0;
                $dato_Nca[45] = (float)$DATO_RECIBO[0]['FACIGV'];
                $dato_Nca[46] = (float)$int_moratorio;
                $dato_Nca[47] = $dato_Nca[43] + $DATO_RECIBO[0]['FACIGV'];
                $dato_Nca[48] = (int)$DATO_RECIBO[0]['PREZONX'];
                $dato_Nca[49] = "Conv-".$oficina."-".$agencia."-".$maximo;
                $dato_Nca[50] = (int)$DATO_RECIBO[0]['FIGVREF'];
                $dato_Nca[51] = $DATO_RECIBO[0]['SERVIDOR'];

                $consulta = "INSERT INTO PRDDBFCOMERCIAL.NCA (
                                NCATIPO, NCASERNRO, NCANRO, TOTFAC_FACSERNRO, TOTFAC_FACNRO,
                                NCAFECHA, NCAFACEMIF, NCAFACVENF, NCAPREMZN, NCAPRELOTE,
                                NCAPREREG, NCAPRESEC, NCAPRELOC, NCACLICODI, NCACLICOD,
                                NCACLICODF, NCAFACCHED, NCAFACTARI, NCAFSETIPC, NCAFAMBITO,
                                NCAFCATEGO, NCAFSUBCAT, NCAFAGABSC, NCAFDEABSC, NCAFGRUCOD, 
                                NCAFGRUSUB,NCAFGRUPRN, NCAFFLAGIG, NCAFACTOTS, NCAFACIGV, 
                                NCAFACTOTA,NCAFACESTA,  NCAFACOFIC, NCAFACOFIA, NCAFRUTA,
                                NCAFCICLO,NCAFMEDIDO, NCAFACSALD, NCAFACINIS, NCAFACFINS, 
                                NCAFICOD,NCAFIAGECO, NCADIGCOD, NCASUBDIF, NCASUBOK, 
                                NCAIGVDIF,NCAIGVOK, NCATOTDIF, NCATOTOK, NCAPREZONX, 
                                NCAREFE,NCAIGVREF, SERVIDOR
                             )
                            VALUES (
                                ?, ?, ?, ?, ?,
                                TO_CHAR(SYSDATE,'DD-MON-YYYY') , ?, ?, ?, ?,
                                ?, ?, ?, ?, ?,
                                ?, ?, ?, ?, ?,
                                ?, ?, ?, ?, ?,
                                ?, ?, ?, ?, ?,
                                ?, ?, ?, ?, ?,
                                ?, ?, ?, ?, ?,
                                ?, ?, ?, ?, ?,
                                ?, ?, ?, ?, ?,
                                ?, ? ,? 
                             )";
                $this->oracle->query( $consulta, $dato_Nca );
                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL INSERTAR EN EL DEUDA REC  ";
                    return $respuesta;
                }

                //CONSULTA PARA EL FACLIN
                $DATO_FACLIN = $this->Busco_dato_Faclin($dato_Nca[3], $dato_Nca[4] );

                if (count($DATO_FACLIN) > 0 ) {
                    
                    $dato_nca1[0] = 'C';
                    $dato_nca1[1] = (int)$dato_Nca[1];
                    $dato_nca1[2] = (int)$dato_Nca[2];
                    $dato_nca1[3] = $DATO_FACLIN[0]['FACLINRO'];
                    $dato_nca1[4] = 0;
                    $dato_nca1[5] = $DATO_FACLIN[0]['FACVOLUM'];
                    $dato_nca1[6] = $DATO_FACLIN[0]['FACPRECI'];
                    $dato_nca1[7] = 0;
                    $dato_nca1[8] = $DATO_FACLIN[0]['FACPRECI'];
                    $dato_nca1[9] = 0;
                    $dato_nca1[10] = $DATO_FACLIN[0]['CONCEP_FACCONCOD'];
                    $dato_nca1[11] = $DATO_FACLIN[0]['SERVIDOR'];

                    $consulta = "INSERT INTO PRDDBFCOMERCIAL.NCA1 (
                                 NCA_NCATIPO, NCA_NCASERNRO, NCA_NCANRO, NCAFACLINR,
                                 CTAN, NCAFACVOLU, NCAFACPREC, NCAPREDIF, 
                                 NCAPREOK, DRC, CONCEP_FACCONCOD, SERVIDOR 
                             )
                            VALUES (
                                 ?, ?, ?, ?,
                                 ?, ?, ?, ?,
                                 ?, ?, ?, ?
                             )";
                    $this->oracle->query( $consulta, $dato_nca1 );
                    if($this->oracle->trans_status() === FALSE){
                        $this->oracle->trans_rollback();
                        $respuesta[0] = false;
                        $respuesta[1] = "OCURRIO UN ERROR AL INSERTAR EN EL NCA1  ";
                        return $respuesta;
                    }

                    $DATO_LETFAC = $this->Busco_dato_Letfac($dato_Nca[3], $dato_Nca[4] );

                    if (count($DATO_LETFAC) > 0 ) {
                        $dato_Nca2[0] = 'C';
                        $dato_Nca2[1] = (int)$dato_Nca[1];
                        $dato_Nca2[2] = (int)$dato_Nca[2];
                        $dato_Nca2[3] = $DATO_LETFAC[0]['FACCUOLIN'];
                        $dato_Nca2[4] = $DATO_LETFAC[0]['OFICOD'];
                        $dato_Nca2[5] = $DATO_LETFAC[0]['OFIAGECOD'];
                        $dato_Nca2[6] = $DATO_LETFAC[0]['CREDNRO'];
                        $dato_Nca2[7] = $DATO_LETFAC[0]['LTNUM'];
                        $dato_Nca2[8] = $DATO_LETFAC[0]['CRECUOMON'];
                        $dato_Nca2[9] = $DATO_LETFAC[0]['CREFUENTE'];
                        $dato_Nca2[10] = $DATO_LETFAC[0]['CRECUOFLA'];
                        $dato_Nca2[11] = $DATO_LETFAC[0]['CONCEP_FACCONCOD'];
                        $dato_Nca2[12] = $DATO_LETFAC[0]['CRECUONRO'];
                        $dato_Nca2[13] = 0;
                        $dato_Nca2[14] = $DATO_LETFAC[0]['CRECUOMON'];
                        $dato_Nca2[15] = $DATO_LETFAC[0]['DRC'];
                        $dato_Nca2[16] = $DATO_LETFAC[0]['SERVIDOR'];

                        $consulta = "INSERT INTO PRDDBFCOMERCIAL.NCA2 (
                                 NCA_NCATIPO, NCA_NCASERNRO, NCA_NCANRO, NCAFACCUOL,
                                 NCAOFICOD, NCAOFIAGEC, NCACREDN, NCALTNUM, 
                                 NCACRECUOM, NCACREFUEN, NCACRECUOF, CONCEP_FACCONCOD, 
                                 NCACRECUON, NCAMONDIF, NCAMONOK, DRC, SERVIDOR
                             )
                            VALUES (
                                 ?, ?, ?, ?,
                                 ?, ?, ?, ?,
                                 ?, ?, ?, ?,
                                 ?, ?, ?, ?,
                                 ?
                             )";
                        $this->oracle->query( $consulta, $dato_Nca2 );
                        if($this->oracle->trans_status() === FALSE){
                            $this->oracle->trans_rollback();
                            $respuesta[0] = false;
                            $respuesta[1] = "OCURRIO UN ERROR AL INSERTAR EN EL NCA3  ";
                            return $respuesta;
                        }
                        //INSERTO EN EL NCA3
                        
                        $dato_Nca3[0] = 'C';
                        $dato_Nca3[2] = (int)$dato_Nca[1];
                        $dato_Nca3[3] = (int)$dato_Nca[2];
                        $dato_Nca3[4] = 1 ;
                        $dato_Nca3[5] = $oficina;
                        $dato_Nca3[6] = $agencia;
                        $dato_Nca3[7] = 0;
                        $dato_Nca3[8] = 'C';
                        $dato_Nca3[9] = 846 ;
                        $dato_Nca3[10] = 0;
                        $dato_Nca3[11] ='I';
                        $dato_Nca3[12] = (float)$int_moratorio;
                        $dato_Nca3[13] = (float)$int_moratorio;
                        $dato_Nca3[14] = $servidor;

                        $consulta = "INSERT INTO PRDDBFCOMERCIAL.NCA3 (
                                 NCA_NCATIPO, NCA_NCASERNRO, NCA_NCANRO, NCANOTLIN,
                                 NCANOFICOD, NCANOFIAGE, NCANOTNRO, NCAFACNOTT,
                                 CONCEP_FACCONCOD, NCAFACNOTM, NCANOTESTN, NCANMONDIF,
                                 NCANMONOK, SERVIDOR
                             )
                            VALUES (
                                 ?, ?, ?, ?,
                                 ?, ?, ?, ?,
                                 ?, ?, ?, ?,
                                 ?, ?
                             )";
                        $this->oracle->query( $consulta, $dato_Nca3 );
                        if($this->oracle->trans_status() === FALSE){
                            $this->oracle->trans_rollback();
                            $respuesta[0] = false;
                            $respuesta[1] = "OCURRIO UN ERROR AL INSERTAR EN EL NCA3  ";
                            return $respuesta;
                        }
                    }


                }
            }
            
        }*/

        //CONVLINK
        $fecha = explode("/", $fecha_vencimiento);
        //--CREDITO
        $dato_convLink[0] = $oficina;
        $dato_convLink[1] = $agencia;
        $dato_convLink[2] = $maximo;
        $dato_convLink[3] = $suministro;
        $dato_convLink[4] = $inicial + $saldo;
        $dato_convLink[5] = $inicial;
        $dato_convLink[6] = $nro_cuota;
        $dato_convLink[7] = "A";
        $dato_convLink[8] = "700";
        $dato_convLink[9] = $codigo_usuario;
        //--INTERES
        $dato_convLink[10] = (count($tabla_simulacion) > 0) ? $oficina : 0;
        $dato_convLink[11] = (count($tabla_simulacion) > 0) ? $agencia : 0;
        $dato_convLink[12] =  (count($tabla_simulacion) > 0) ? ($maximo + 1) : 0;
        $dato_convLink[13] = $suma_interes;
        $dato_convLink[14] = 0;
        $dato_convLink[15] = $nro_cuota;
        $dato_convLink[16] = "A";
        $dato_convLink[17] = "847";
        $dato_convLink[18] = $tasa_interes;
        $dato_convLink[19] = $tasa_frc;
        $dato_convLink[20] = $saldo;// TOTSININT
        $dato_convLink[21] = $saldo + $suma_interes;// TOTCONINT
        $dato_convLink[22] = ($saldo != 0) ? $tabla_simulacion[0]["Imp_Cuota_fin"] : 0.00;
        $dato_convLink[23] = $numero_financimiento;
        $dato_convLink[24] = $fecha[2].$fecha[1];
        $dato_convLink[25] = $serie_rec_nota;  // serie de recibo nota de debito 
        $dato_convLink[26] = $nro_rec_nota;  // numero de recibo nota de debito
        $dato_convLink[27] = $serie_nota_deb;  // serie nota de debito 
        $dato_convLink[28] = $nro_nota_deb;  // numero nota de debito 
        $dato_convLink[29] = (count($tabla_deuda_anterior)>0) ? "S" : "N"; // SI ES QUE INCLUYE CUOTAS POR EMITIR 
        $dato_convLink[30] = $servidor;
        $consulta = "INSERT INTO PRDDBFCOMERCIAL.CONVLINK (CREDIT_AGENCI_OFICIN_OFICOD, CREDIT_AGENCI_OFIAGECOD, CREDIT_CREDNRO, 
                                CREDFECHA, CLIUNICOD, DEUDATOTAL, 
                                CTAINICIAL, NROLTS, CREDSTATUS, 
                                CRECONCOD, DIGCOD, IOFICOD, 
                                IOFIAGECOD, ICREDNRO, IDEUDATOTA, 
                                ICTAINICIA, INROLTS, ICREDSTATU, 
                                ICRECONCOD, TASAINT, FRC, 
                                TOTSININT, TOTCONINT, CUOTAFIJA,
                                PLAN, PRIMVENCI, NDFACSERNR, 
                                NDFACNRO, NDEBSERIE, NDEBNUMERO, 
                                INCLUCXEMI, SERVIDOR
                                )
                    VALUES ( ?, ?, ?,
                            TO_CHAR(SYSDATE,'DD-MON-YYYY'), ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?
                    )";
    
        $this->oracle->query($consulta , $dato_convLink);

        if($this->oracle->trans_status() === FALSE){
            $this->oracle->trans_rollback();
            $respuesta[0] = false;
            $respuesta[1] = "OCURRIO UN ERROR AL GRABAR EN EL CONVILINK";
            return $respuesta;
        }
        
        if($tabla_SolRepre[0]['DNI'] ==' '){
            $tabla_SolRepre[0]['DNI'] ='';
        }
           
        // DEUDAREC
        $dato_deuda = $this->max_DeudaRec($oficina, $agencia);
        $dato_DeudaRec[0] = $suministro; 
        $dato_DeudaRec[1] = $oficina;
        $dato_DeudaRec[2] = $agencia;
        $dato_DeudaRec[3] = (int)$dato_deuda[0]["MAXIMO"] + 1;
        $dato_DeudaRec[4] = $maximo;
        $dato_DeudaRec[5] = "R.G.G. ".trim($gerente[0]['EMPREPDNI'])." - ".trim($gerente[0]['EMPDES']);
        $dato_DeudaRec[6] = trim($gerente[0]['EMPREPNOM']).' '.trim($gerente[0]['EMPREPAPP']).' '.trim($gerente[0]['EMPREPAPM']);
        $dato_DeudaRec[7] = trim($gerente[0]['EMPREPDNI']);
        $dato_DeudaRec[8] = substr($tabla_SolRepre[0]['Nombre'], 0, 59);
        $dato_DeudaRec[9] = substr($tabla_SolRepre[0]['Direccion'], 0, 59);
        $dato_DeudaRec[10] = (isset($tabla_SolRepre[0]['DNI'])) ? $tabla_SolRepre[0]['DNI'] : 0;
        $dato_DeudaRec[11] = $tabla_SolRepre[0]['Correo'];
        $dato_DeudaRec[12] = $tabla_SolRepre[0]['Telefono'];
        $dato_DeudaRec[13] = (isset($tabla_SolRepre[1]['Nombre'])) ?  substr($tabla_SolRepre[1]['Nombre'], 0, 59) : "";
        $dato_DeudaRec[14] = (isset($tabla_SolRepre[1]['Direccion'])) ? substr($tabla_SolRepre[1]['Direccion'], 0, 59) : "";
        $dato_DeudaRec[15] = (isset($tabla_SolRepre[1]['DNI'])) ? $tabla_SolRepre[1]['DNI'] : "";
        $dato_DeudaRec[16] = (isset($tabla_SolRepre[1]['Correo'])) ? $tabla_SolRepre[1]['Correo'] : "";
        $dato_DeudaRec[17] = (isset($tabla_SolRepre[1]['Telefono'])) ? $tabla_SolRepre[1]['Telefono'] : "";
        $dato_DeudaRec[18] = "";
        $dato_DeudaRec[19] = "TRUJILLO";
        $dato_DeudaRec[20] = $inicial + $saldo;
        $dato_DeudaRec[21] = 0;
        $dato_DeudaRec[22] = 0;
        $dato_DeudaRec[23] = 0;
        $dato_DeudaRec[24] = 0;
        $dato_DeudaRec[25] = 0;
        $dato_DeudaRec[26] = 0;
        $dato_DeudaRec[27] = 0;
        $dato_DeudaRec[28] = 0;
        $dato_DeudaRec[29] = $inicial + $saldo;
        $dato_DeudaRec[30] = $inicial + $saldo;
        $dato_DeudaRec[31] = $inicial + $saldo;
        $dato_DeudaRec[32] = 0;
        $dato_DeudaRec[33] = 0;
        $dato_DeudaRec[34] = "";
        $dato_DeudaRec[35] = $codigo_usuario;
        //AVAL
        $dato_DeudaRec[36] = "";
        $dato_DeudaRec[37] = "";
        $dato_DeudaRec[38] = "";
        $dato_DeudaRec[39] = "";
        $dato_DeudaRec[40] = "";
        $dato_DeudaRec[41] = "";
        $dato_DeudaRec[42] = "";
        $dato_DeudaRec[43] = "";
        $dato_DeudaRec[44] = "";
        $dato_DeudaRec[45] = "";
        // DATOS DE DEUDA 
        $dato_DeudaRec[46] = $inicial;
        $dato_DeudaRec[47] = $nro_cuota;
        $dato_DeudaRec[48] = $inicial + $saldo;
        $dato_DeudaRec[49] = $saldo;
        $dato_DeudaRec[50] = $fecha[2].$fecha[1];
        $dato_DeudaRec[51] = 0;
        $dato_DeudaRec[52] = 0;
        $dato_DeudaRec[53] = 0;
        $dato_DeudaRec[54] = 0;
        $dato_DeudaRec[55] = 0;
        $dato_DeudaRec[56] = "I";
        $dato_DeudaRec[57] = $servidor;
        $dato_DeudaRec[58] = 0;
        $consulta = "INSERT INTO PRDDBFCOMERCIAL.DEUDAREC (
                            CLICODFAC, OFICOD, OFIAGECOD, RECONRO, CREDNRO, RGG, 
                            CREDFECHA, REPRENOM, REPREDNI, SOLICINOM, SOLICIDIRE, SOLICIDNI, 
                            SOLICIMAIL,  SOLICITELF, REPSOLNOM, REPSOLDIRE,  REPSOLDNI, REPSOLMAIL, 
                            REPSOLTELE, DOCFACUL, LOCALIDAD, FECHAREG, DEUDACAPIT, CARGOVAR, 
                            MONTOCONV, INTERESMOR, GCOBZA, IGVTOTAL, IGVCARGOS, IGVGCOBZA, 
                            IGVINTMOR, EXIGIBLE, DEUDAFINAL, DEURECONOC, GASTOVAREC, EXIGIRECON, 
                            OBSERVACIO, DIGCOD, AVAL1NOM, AVAL1DIREC, AVAL1DNI, AVAL1TELEF, 
                            AVAL1MAIL, AVAL2NOM, AVAL2DIREC, AVAL2DNI, AVAL2TELEF, AVAL2MAIL, 
                            INICIAL, NROCUOTAS, TOTALFINA, SALDOFINA, PRIMERMES, SALDOFINT, 
                            MONCUOCA, MONCUOIN, MONCUOTO, SALDOAMBO, ESTADOACTA, FECESTACTA, 
                            SERVIDOR, EST_PAGO  
                                )
                    VALUES ( ?, ?, ?, ?, ?, ?,
                             TO_CHAR(SYSDATE,'DD-MON-YYYY'), ?, ?, ?, ?, ?,
                             ?, ?, ?, ?, ?, ?,
                             ?, ?, ?,TO_CHAR(SYSDATE,'DD-MON-YYYY'), ?, ?,
                             ?, ?, ?, ?, ?, ?,
                             ?, ?, ?, ?, ?, ?,
                             ?, ?, ?, ?, ?, ?,
                             ?, ?, ?, ?, ?, ?,
                             ?, ?, ?, ?, ?, ?,
                             ?, ?, ?, ?, ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                             ?, ?   
                    )";

        $this->oracle->query($consulta, $dato_DeudaRec);

        if($this->oracle->trans_status() === FALSE){
            $this->oracle->trans_rollback();
            $respuesta[0] = false;
            $respuesta[1] = "OCURRIO UN ERROR AL INSERTAR EN EL DEUDA REC";
            return $respuesta;
        }
        /*if(count($tabla_recibo) !=0){
            $i = 0; 
            while ($i < count($tabla_recibo) ) {
                $consulta = "UPDATE PRDDBFCOMERCIAL.TOTFAC SET FACESTADO='C' , FACESTFECH = TO_CHAR(SYSDATE,'DD-MON-YYYY')  
                             WHERE FACSERNRO = ".$tabla_recibo[$i]['Serie']." AND FACNRO = ".$tabla_recibo[$i]['Nro']." ";
                
                $this->oracle->query($consulta);
                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL MODIFICAR EN EL TOTFAC ";
                    return $respuesta;
                }
                $i++;
            }
        }*/
        
        // PARA OBTENER LOS USUARIOS DE COBRANZA 
        //$usuario_cobranza = $this -> user_cobranza();
        $datos_mdocglb[0] = 1;
        $datos_mdocglb[1] = 6;
        $datos_mdocglb[2] = $oficina.$agencia;
        $datos_mdocglb[3] = $max_Amortiza;
        $datos_mdocglb[4] = "";
        $datos_mdocglb[5] = $suministro;
        $datos_mdocglb[6] = substr($tabla_SolRepre[0]['Nombre'], 0, 59);
        $datos_mdocglb[7] = $inicial;
        $datos_mdocglb[8] = '';//$usuario_cobranza[0]['USRCOD'];
        $datos_mdocglb[9] = 4;
        $datos_mdocglb[10] = "INICIAL CONV. ".$oficina.$agencia." - ".$maximo;
        $datos_mdocglb[11] = $tabla_SolRepre[0]['DNI'];
        $consulta = "INSERT INTO PRDRECAUDACIONORA12C.MDOCGLB (
                        ESECOD, MDCCOD, MDGSERDOC, MDGNRODOC, 
                        MDGCODACC1, MDGCODACC2, MDGCODACC3, MDGFCHEMIDOC, 
                        MDGFCHVTODOC, MDGFCHVTOCOB, MDGFCHREG, MDGHRAREG, 
                        MDGIMPTOT, OPSCOD, SDGCOD, MDGMSJFIN, 
                        MDGDNINUM, MDGDNIFREG , MDGDNIHREG
                        )
                    VALUES ( 
                             ?, ?, ?, ?,
                             ?, ?, ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                             TO_CHAR(SYSDATE,'DD-MON-YYYY'), TO_CHAR(SYSDATE,'DD-MON-YYYY'), TO_CHAR(SYSDATE,'DD-MON-YYYY'), TO_CHAR(SYSDATE,'HH24:MI:SS'),
                             ?, ?, ?, ?,
                             ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'), TO_CHAR(SYSDATE,'HH24:MI:SS')
                            )";

        $this->oracle->query($consulta , $datos_mdocglb);

        if($this->oracle->trans_status() === FALSE){
            $this->oracle->trans_rollback();
            $respuesta[0] = false;
            $respuesta[1] = "OCURRIO UN ERROR AL INSERTAR EN EL MDOC GLB ";
            return $respuesta;
        }

        if(strlen($observaciones)> 5 ){
            $consulta = "UPDATE PRDDBFCOMERCIAL.TEMP_CLIENT_CATAST
                                SET 
                                OBSERVACION =".$observaciones."
                                WHERE CLICODFAC = '".$suministro."'";    
             $this->oracle->query($consulta);
            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "NO SE MODIFICO EL UPDATE DEL TEMPORAL DE CATASTRO";
                return $respuesta;
            }
        }

        $this->oracle->trans_commit();
        if (isset($dato_Nca[2])) {
            $respuesta[3] =  $dato_Nca[1] ; 
            $respuesta[4] =  $dato_Nca[2] ;  
        }
       
        $respuesta[0] = true;
        $numero_credit[0]["MAXIMO"] = (int)$numero_credit[0]["MAXIMO"] + 1;
        $respuesta[1] = $numero_credit;
        $respuesta[2] = $max_Amortiza;
        return $respuesta; 
        
    }

    public function get_gerente(){
        $consulta = "SELECT EMPREPNOM, EMPREPAPP, EMPREPAPM, EMPDES, EMPREPDNI FROM PRDRECAUDACIONORA12C.CEMPRES";
        $query = $this->oracle->query($consulta);
        return $query->result_array(); 
    }

    public function Obtengo_bandera_colateral(){
        $consulta = "SELECT VALPAR FROM PRDDBFCOMERCIAL.MAEPAR WHERE CODPAR = 'FINANPLANSEGMEN'";
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }

    public function Grabar_Colateral($oficina, $agencia, $suministro, $nombre, $direccion, $monto, $numero_cuota, $mont_inicial, $capital_financiar, $concep, $tas_interes, $letras, $SERVIDOR, $referencia, $texto_concepto, $tasa_frc, $fecha){
        //var_dump($letras);
        //exit();
        $servidor = trim($SERVIDOR);
        $numero_credit = $this->max_credit($oficina,$agencia);
        $maximo = (int)$numero_credit[0]["MAXIMO"] + 1 ;
        $datos[0]= $maximo;
        $datos[1]= $suministro;
        $datos[2]= $oficina;
        $datos[3]= $agencia;
        $datos[4]= $concep; //CONCEPTO
        $datos[5]= "I"; //  STATUS
        $datos[6]= "Y"; //  TIPO DE CREDITO
        $datos[7]= $monto;  // DEUDA TOTAL
        $datos[8]= $mont_inicial;  // CUOTA INICIAL
        $datos[9]= $numero_cuota;  // NUMERO DE LETRAS 
        $datos[10]= "1";  // SIGUIENTE CUOTA
        $datos[11]= "0";  // CRECLICOD
        $datos[12]= "0";  // CRECLICOD
        $datos[13]= "0";  // CRECLICOD
        $datos[14]= "0";  // CRECLICOD
        $datos[15]= "0";  
        $datos[16]= "0";  
        $datos[17]= "0";  
        $datos[18]= "0";  
        $datos[19]= $referencia;  // CRECLICOD  -----------------------------
        $datos[20]= "0.00"; // CRECLICOD -----------------------------
        $datos[21]= "0.00"; // CRECLICOD ----------------------------
        $datos[22]= "0"; // CRECLICOD
        $datos[23]= "0"; // CRECLICOD
        $datos[24]= $_SESSION['user_id']; // CRECLICOD
        $datos[25]= "0"; // CRECLICOD
        $datos[26]= "0"; // CRECLICOD
        $datos[27]= substr($texto_concepto,0,10); // CREDREFE  ------------------
        $datos[28]= $servidor;
        $this->oracle->trans_begin();
        $consulta = "INSERT INTO PRDDBFCOMERCIAL.CREDIT ( CREDNRO, CLIUNICOD, CREDFECHA, 
                                    AGENCI_OFICIN_OFICOD , AGENCI_OFIAGECOD, CONCEP_FACCONCOD, 
                                    CREDSTATUS, CREDTIPO, DEUDATOTAL,
                                    CTAINICIAL, NROLTS, CREDSTFEC,
                                    SGTECUOTA, CRECLICOD, CREFINFTE,
                                    CRECUOFAC, CREFACIMP, CREPAGULT,
                                    CREPAGOFI, CREPAGAGE, CREPAGTOT,
                                    CREFINSAL, CREREFDOC, CLIINTER,
                                    CLGCOBZA, CREACCION, CREIGV,
                                    DIGCOD, LETRAS, NROLETRAS,
                                    CREDREFE , SERVIDOR)
                        VALUES ( ? , ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                 ? , ?, ?,
                                 ? , ?, ?,
                                 ? , ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                 ? , ?, ?, 
                                 ? , ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                 ? , ?, ?, 
                                 ? , ?, ?,
                                 ? , ?, ?,
                                 ? , ?, ?,
                                 ? , ?)";
        $this->oracle->query($consulta , $datos);

        if($this->oracle->trans_status() === FALSE){
            $this->oracle->trans_rollback();
            $respuesta[0] = false;
            $respuesta[1] = "OCURRIO UN ERROR AL GRABAR EN EL CREDIT DEL CONVENIO";
            return $respuesta;
        }

        $i = 0 ;
        $suma_interes = 0 ; 
        while ($i< count($letras)) {
            $suma_interes = $suma_interes + $letras[$i][2];
            $i++;
        }
        
        if($suma_interes > 0){
            $maximo_int = $maximo + 1;
            $datos_int[0]= $maximo_int;
            $datos_int[1]= $suministro;
            $datos_int[2]= $oficina;
            $datos_int[3]= $agencia;
            $datos_int[4]= "847"; // CONCEPTO
            $datos_int[5]= "I"; //  STATUS
            $datos_int[6]= "Y"; //  TIPO DE CREDITO
            $datos_int[7]= $suma_interes;  // DEUDA TOTAL
            $datos_int[8]= "0";  // CUOTA INICIAL
            $datos_int[9]= $numero_cuota;  // NUMERO DE LETRAS 
            $datos_int[10]= "1";  // SIGUIENTE CUOTA
            $datos_int[11]= "0";  // CRECLICOD
            $datos_int[12]= "0";  // CRECLICOD
            $datos_int[13]= "0";  // CRECLICOD
            $datos_int[14]= "0";  // CRECLICOD
            $datos_int[15]= "0";  // CRECLICOD
            $datos_int[16]= "0";  // CRECLICOD
            $datos_int[17]= "0";  // CRECLICOD
            $datos_int[18]= "0";  // CRECLICOD
            $datos_int[19]= $referencia;  // CRECLICOD
            $datos_int[20]= "0"; // CLIINTER
            $datos_int[21]= "0"; // CLGCOBZA
            $datos_int[22]= "0"; // CREACCION
            $datos_int[23]= "0"; // CREIGV
            $datos_int[24]= $_SESSION['user_id']; // DIGCOD
            $datos_int[25]= "0"; // LETRAS
            $datos_int[26]= "0"; // NROLETRAS
            $datos_int[27]= "Int. de Conv.".$oficina.'-'.$agencia.'-'.$maximo; // CREDREFE
            $datos_int[28]= $servidor;
            $consulta = "INSERT INTO PRDDBFCOMERCIAL.CREDIT ( CREDNRO, CLIUNICOD, CREDFECHA, 
                                        AGENCI_OFICIN_OFICOD , AGENCI_OFIAGECOD, CONCEP_FACCONCOD, 
                                        CREDSTATUS, CREDTIPO, DEUDATOTAL,
                                        CTAINICIAL, NROLTS, CREDSTFEC,
                                        SGTECUOTA, CRECLICOD, CREFINFTE,
                                        CRECUOFAC, CREFACIMP, CREPAGULT,
                                        CREPAGOFI, CREPAGAGE, CREPAGTOT,
                                        CREFINSAL, CREREFDOC, CLIINTER,
                                        CLGCOBZA, CREACCION, CREIGV,
                                        DIGCOD, LETRAS, NROLETRAS,
                                        CREDREFE , SERVIDOR)
                            VALUES ( ? , ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                    ? , ?, ?,
                                    ? , ?, ?,
                                    ? , ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                    ? , ?, ?, 
                                    ? , ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                    ? , ?, ?, 
                                    ? , ?, ?,
                                    ? , ?, ?,
                                    ? , ?, ?,
                                    ? , ?)";
        
            $this->oracle->query($consulta , $datos_int);
            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL GRABAR EN EL CREDIT DEL INTERES";
                return $respuesta;
            }
        }
        
        // INSERTAMOS EN EL CONVILINK -- fecha 
        $fecha_vencimiento = explode("-", $fecha);

        $dato_convLink[0] = $oficina;
        $dato_convLink[1] = $agencia;
        $dato_convLink[2] = $maximo;
        $dato_convLink[3] = $suministro;
        $dato_convLink[4] =  $monto;
        $dato_convLink[5] = 0.00;
        $dato_convLink[6] = $numero_cuota;
        $dato_convLink[7] = "I";
        $dato_convLink[8] = $concep;
        $dato_convLink[9] = "0";
        //--INTERES
        $dato_convLink[10] = $oficina;
        $dato_convLink[11] = $agencia;
        $dato_convLink[12] = $maximo + 1;
        $dato_convLink[13] = $suma_interes;
        $dato_convLink[14] = 0;
        $dato_convLink[15] = $numero_cuota;
        $dato_convLink[16] = "I";
        $dato_convLink[17] = $concep;
        $dato_convLink[18] = $tas_interes;
        $dato_convLink[19] = $tasa_frc ;//$tasa_frc;
        $dato_convLink[20] = $monto;// TOTSININT
        $dato_convLink[21] = $monto + $suma_interes;// TOTCONINT
        $dato_convLink[22] = $letras[0][4];
        $dato_convLink[23] =  99;  /// $numero_financimiento;
        $dato_convLink[24] = $fecha_vencimiento[0].$fecha_vencimiento[1] ; //$fecha[2].$fecha[1];
        $dato_convLink[25] = 0;
        $dato_convLink[26] = 0;
        $dato_convLink[27] = 0;
        $dato_convLink[28] = 0;
        $dato_convLink[29] = "S";
        $dato_convLink[30] = $servidor;
        $consulta = "INSERT INTO PRDDBFCOMERCIAL.CONVLINK (CREDIT_AGENCI_OFICIN_OFICOD, CREDIT_AGENCI_OFIAGECOD, CREDIT_CREDNRO, 
                                CREDFECHA, CLIUNICOD, DEUDATOTAL, 
                                CTAINICIAL, NROLTS, CREDSTATUS, 
                                CRECONCOD, DIGCOD, IOFICOD, 
                                IOFIAGECOD, ICREDNRO, IDEUDATOTA, 
                                ICTAINICIA, INROLTS, ICREDSTATU, 
                                ICRECONCOD, TASAINT, FRC, 
                                TOTSININT, TOTCONINT, CUOTAFIJA,
                                PLAN, PRIMVENCI, NDFACSERNR, 
                                NDFACNRO, NDEBSERIE, NDEBNUMERO, 
                                INCLUCXEMI, SERVIDOR
                                )
                    VALUES ( ?, ?, ?,
                            TO_CHAR(SYSDATE,'DD-MON-YYYY'), ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?
                    )";
    
        $this->oracle->query($consulta , $dato_convLink);

        if($this->oracle->trans_status() === FALSE){
            $this->oracle->trans_rollback();
            $respuesta[0] = false;
            $respuesta[1] = "OCURRIO UN ERROR EN EL CONVILINK";
            return $respuesta;
        }
        /* INSERTAMOS EN LETRAS */
        $i = 0; 
        $consulta_tabla = "";
        $saldo_interes = $suma_interes ;
        while ($i< count($letras)) {
            //LETRAS DEL CONVENIO
            $dato_tabla[0] = $oficina;
            $dato_tabla[1] = $agencia;
            $dato_tabla[2] = $maximo;
            $dato_tabla[3] = (float)$letras[$i][0];
            $dato_tabla[4] = (float)$letras[$i][1]; ///---------------------------------
            $dato_tabla[5] = (float)$letras[$i][3];
            $dato_tabla[7] = (float)$letras[$i][2];
            $dato_tabla[8] = 0;
            $dato_tabla[9] = 0;
            $dato_tabla[10] = 0;
            $dato_tabla[11] = $letras[$i][3];
            $dato_tabla[12] = $letras[$i][5];
            $dato_tabla[13] = "I";
            $dato_tabla[14] = 0;
            $dato_tabla[15] = 0;
            $dato_tabla[16] = 0;
            $dato_tabla[17] = $servidor;
            $consulta_tabla = "INSERT INTO PRDDBFCOMERCIAL.LETRAS ( 
                        CREDIT_AGENCI_OFICIN_OFICOD, CREDIT_AGENCI_OFIAGECOD, CREDIT_CREDNRO,
                        LTNUM, LTSALDO, LTVALOR,
                        LTINTER, LTACCION, LTGACOBZ,
                        LTIGV, LTCUOTA, LTVENCIM,
                        LTSTATUS, LTSTAFEC, LTFECCANC,
                        FACSERNROX, FACNROX, FACCUOLIX,
                        SERVIDOR )
                        VALUES ( ? , ?, ?,
                                 ? , ?, ?,
                                 ? , ?, ?,
                                 ? , ?, ?,
                                 ? , TO_CHAR(SYSDATE,'DD-MON-YYYY'), TO_CHAR(SYSDATE,'DD-MON-YYYY'), 
                                 ? , ?, ?,
                                 ?)"; 

            $this->oracle->query($consulta_tabla , $dato_tabla);
            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL GRABAR EN EL LETRA DEL CONVENIO";
                return $respuesta;
            }
            //LETRAS DEL CONVENIO
            if($suma_interes>0){
                $dato_tabla_int[0] = $oficina;
                $dato_tabla_int[1] = $agencia;
                $dato_tabla_int[2] = $maximo_int;
                $dato_tabla_int[3] = (float)$letras[$i][0];
                $dato_tabla_int[4] = (float)$saldo_interes;
                $dato_tabla_int[5] = $letras[$i][2];
                $dato_tabla_int[7] = "0";
                $dato_tabla_int[8] = "0";
                $dato_tabla_int[9] = "0";
                $dato_tabla_int[10] = "0";
                $dato_tabla_int[11] = $letras[$i][2];
                $dato_tabla_int[12] = $letras[$i][5];
                $dato_tabla_int[13] = "I";
                $dato_tabla_int[14] = "0";
                $dato_tabla_int[15] = "0";
                $dato_tabla_int[16] = "0";
                $dato_tabla_int[17] = $servidor;
                $consulta_tabla = "INSERT INTO PRDDBFCOMERCIAL.LETRAS ( 
                            CREDIT_AGENCI_OFICIN_OFICOD, CREDIT_AGENCI_OFIAGECOD, CREDIT_CREDNRO,
                            LTNUM, LTSALDO, LTVALOR,
                            LTINTER, LTACCION, LTGACOBZ,
                            LTIGV, LTCUOTA, LTVENCIM,
                            LTSTATUS, LTSTAFEC, LTFECCANC,
                            FACSERNROX, FACNROX, FACCUOLIX,
                            SERVIDOR )
                            VALUES ( ? , ?, ? ,
                                    ? , ?, ? ,
                                    ? , ?, ? ,
                                    ? , ?, ? ,
                                    ? , TO_CHAR(SYSDATE,'DD-MON-YYYY'), TO_CHAR(SYSDATE,'DD-MON-YYYY') , 
                                    ? , ?, ? ,
                                    ?)" ; 

                $this->oracle->query($consulta_tabla , $dato_tabla_int);
                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    $respuesta[0] = false;
                    $respuesta[1] = "OCURRIO UN ERROR AL GRABAR EN EL LETRA DEL INTERES";
                    return $respuesta;
                }  
                $saldo_interes = $saldo_interes - $letras[$i][2];
            }
            
            $i++;
        }
        if((float)$mont_inicial > 0){
            $numero_Amortiza = $this->max_Amortiza($oficina,$agencia);
            $max_Amortiza = (int)$numero_Amortiza[0]["MAXIMO"] + 1 ;
            $dato_amortiza[0] = (int)$oficina;
            $dato_amortiza[1] = (int)$agencia;
            $dato_amortiza[2] = (int)$maximo;
            $dato_amortiza[3] = (int)$max_Amortiza;
            //agrego fecha
            $dato_amortiza[4] = "'".$suministro."'";
            $dato_amortiza[5] = (float)$mont_inicial;
            $dato_amortiza[6] = "'I'";
            $dato_amortiza[7] = "1";
            $dato_amortiza[8] = $_SESSION['user_comercial'];
            $dato_amortiza[9] = (int)($oficina.$agencia);
            $dato_amortiza[10] = "'I'";
            //agrego fecha
            $dato_amortiza[11] = "'0'";
            $dato_amortiza[12] = "'0'";
            $dato_amortiza[13] = "'0'";
            $dato_amortiza[14] = "'0'";
            //$dato_amortiza[15] = "'".$_SESSION['OFICINA']."'";
            $dato_amortiza[15] = "'".$servidor."'";
            $consulta_amortiza = "INSERT INTO PRDDBFCOMERCIAL.AMORTIZA ( 
                        CREDIT_AGENCI_OFICIN_OFICOD, CREDIT_AGENCI_OFIAGECOD, CREDIT_CREDNRO,
                        AMONRO, AMOFECHA, CLIUNICOD,
                        AMOMONTO, AMOEST, OPETIPO,
                        DIGCOD, AMOSERIE, AMOFLAG,
                        AMOESTFEC, OFIPAG, OFAPAG,
                        DIGPAG, AMOTICKT, SERVIDOR
                        )
                            VALUES ( ".$dato_amortiza[0].", ".$dato_amortiza[1].", ".$dato_amortiza[2].",
                                    ".$dato_amortiza[3].", TO_CHAR(SYSDATE,'DD-MON-YYYY'), ".$dato_amortiza[4].",
                                    ".$dato_amortiza[5].", ".$dato_amortiza[6].", ".$dato_amortiza[7].",
                                    ".$dato_amortiza[8].", ".$dato_amortiza[9].", ".$dato_amortiza[10].",
                                    TO_CHAR(SYSDATE,'DD-MON-YYYY'), ".$dato_amortiza[11].", ".$dato_amortiza[12].",
                                    ".$dato_amortiza[13].", ".$dato_amortiza[14].", ".$dato_amortiza[15]." )" ; 
            $this->oracle->query($consulta_amortiza );
            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                $respuesta[0] = false;
                $respuesta[1] = "OCURRIO UN ERROR AL INSERTAR EN EL AMORTIZA";
                return $respuesta;
            }
        }
        
        $this->oracle->trans_commit();
        $respuesta[0] = true;
        $respuesta[1] = "DATOS INGRESADOS CORRECTAMENTE";
        $respuesta[2] = $maximo;
        return $respuesta;
    }

    public function Edit_titular($email, $dni, $ruc, $telefono, $nombre, $apemat, $apepat, $Selector_zona, $zona, $Selector_via, $via, $Numero, $Interior, $Kilometro, $Departamento, $Manzana, $Lote, $bandera, $suministro, $oficina, $agencia){

        if ($bandera ==1){
            $datos[0] = $apepat;
            $datos[1] = $apemat;
            $datos[2] = $nombre;
            $datos[3] = $Selector_via;
            $datos[4] = $via;
            $datos[5] = $Selector_zona;
            $datos[6] = $zona;
            $datos[7] = $Numero;
            $datos[8] = $Interior;
            $datos[9] = $Lote;
            $datos[10] = $Departamento;
            $datos[11] = $Manzana;
            $datos[12] = $Kilometro;
            $datos[13] = $email;
            $datos[14] = $telefono;
            $datos[15] = $_SESSION['user_comercial']; 
            $datos[16] = $dni;
            $this->oracle->trans_begin();
            $this->oracle->query("UPDATE PRDDBFCOMERCIAL.DOCIDENT SET APEPAT= ? , APEMAT = ? , NOMBRE = ?, TIPO_DE_VIA = ?, NOMBRE_DE_VIA = ?, CODIGO_DE_ZONA = ?, TIPO_DE_ZONA = ?, NUMERO = ?, INTERIOR = ?, LOTE = ?, DEPARTAMENTO = ?, MANZANA  = ?, KILOMETRO = ?, EMAIL = ?, TELCEL = ?, NUSRCOD= ? WHERE NRODOC = ? ", $datos);
            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                return false;
            }

            // consulta para verificar si esta guardado en el temporal 

            $query = $this->oracle->query("SELECT CLICODFAC, DNI, NOMBRE FROM PRDDBFCOMERCIAL.TEMP_CLIENT_CATAST WHERE DNI='".$dni."'");

            $Respuesta = $query->result_array();
            
            if(count($Respuesta)>0){
                    $this->oracle->query("UPDATE PRDDBFCOMERCIAL.TEMP_CLIENT_CATAST SET CLICODFAC = '".$suministro."', EMAIL = '".$email."', DNI = '".$dni."', RUC = '".$ruc."', TELEFONO = '".$telefono."', NOMBRE = '".$nombre."', APEPAT = '".$apepat."', APEMAT = '".$apemat."', CZONA = '".$Selector_zona."', MZONA = '".$zona."', CVIA = '".$Selector_via."', MVIA = '".$via."', NUMERO = '".$Numero."', INTERIOR = '".$Interior."', LOTE = '".$Lote."', DEPARTAMENTO = '".$Departamento."', MANZANA = '".$Manzana."', KILOMETRO = '".$Kilometro."', OFICOD = ".$oficina.", AGECOD = ".$agencia.", USUARIO = ".$_SESSION['user_comercial']." WHERE DNI ='".$dni."'");
                    if($this->oracle->trans_status() === FALSE){
                        $this->oracle->trans_rollback();
                        return false;
                    }
            }else{

                    $this->oracle->query("INSERT INTO  PRDDBFCOMERCIAL.TEMP_CLIENT_CATAST (
                    CLICODFAC, EMAIL, DNI, 
                    RUC, TELEFONO, NOMBRE, APEPAT, 
                    APEMAT, CZONA, MZONA, CVIA, 
                    MVIA, NUMERO, INTERIOR, LOTE, 
                    DEPARTAMENTO, MANZANA, KILOMETRO, OFICOD, 
                    AGECOD, USUARIO, ESTADO  
                    )VALUES('".$suministro."','"
                             .$email."','"
                             .$dni."','"
                             .$ruc."','"
                             .$telefono."','"
                             .$nombre."','"
                             .$apepat."','"
                             .$apemat."','"
                             .$Selector_zona."','"
                             .$zona."','"
                             .$Selector_via."','"
                             .$via."','"
                             .$Numero."','"
                             .$Interior."','"
                             .$Lote."','"
                             .$Departamento."','"
                             .$Manzana."','"
                             .$Kilometro."',"
                             .$oficina.","
                             .$agencia.",'"
                             .$_SESSION['user_comercial']."',
                               1 ) ");

                    if($this->oracle->trans_status() === FALSE){
                        $this->oracle->trans_rollback();
                        return false;
                    }
                }
            

            
            
            $this->oracle->trans_commit(); 
            return true; 

        }else{

            $datos[0] = (int)$dni;
            $datos[1] = "1";
            $datos[2] = $apepat;
            $datos[3] = $apemat;
            $datos[4] = $nombre;//
            $datos[5] = $Selector_via;
            $datos[6] = $via;
            $datos[7] = $Selector_zona;
            $datos[8] = $zona;
            $datos[9] = $Numero;
            $datos[10] = $Interior;
            $datos[11] = $Lote;
            $datos[12] = $Departamento;
            $datos[13] = $Manzana;
            $datos[14] = $Kilometro;
            $datos[15] = $_SESSION['user_comercial']; // usuariooo
            $datos[16] = $email;
            $datos[17] = $telefono;

            $this->oracle->trans_begin();
            $this->oracle->query("INSERT INTO PRDDBFCOMERCIAL.DOCIDENT (
                                    NRODOC, TIPDOC, APEPAT, APEMAT, 
                                    NOMBRE, TIPO_DE_VIA, NOMBRE_DE_VIA, CODIGO_DE_ZONA, 
                                    TIPO_DE_ZONA, NUMERO, INTERIOR, LOTE, 
                                    DEPARTAMENTO, MANZANA, KILOMETRO, NUSRCOD, 
                                    EMAIL, TELCEL   )
                                    VALUES (
                                    ?, ?, ?, ?,
                                    ?, ?, ?, ?,
                                    ?, ?, ?, ?,
                                    ?, ?, ?, ?,
                                    ?, ?
                                    )", $datos);
            if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                return false;
            }
            // consulta para verificar si esta guardado en el temporal 

            $query = $this->oracle->query("SELECT CLICODFAC, DNI, NOMBRE FROM PRDDBFCOMERCIAL.TEMP_CLIENT_CATAST WHERE DNI='".$dni."'");

            $Respuesta = $query->result_array();

            if(count($Respuesta) > 0){
                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.TEMP_CLIENT_CATAST SET CLICODFAC = '".$suministro."', EMAIL = '".$email."', DNI = '".$dni."', RUC = '".$ruc."', TELEFONO = '".$telefono."', NOMBRE = '".$nombre."', APEPAT = '".$apepat."', APEMAT = '".$apemat."', CZONA = '".$Selector_zona."', MZONA = '".$zona."', CVIA = '".$Selector_via."', MVIA = '".$via."', NUMERO = '".$Numero."', INTERIOR = '".$Interior."', LOTE = '".$Lote."', DEPARTAMENTO = '".$Departamento."', MANZANA = '".$Manzana."', KILOMETRO = '".$Kilometro."', OFICOD = ".$oficina.", AGECOD = ".$agencia.", USUARIO = ".$_SESSION['user_comercial']." WHERE DNI ='".$dni."'");
                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    return false;
                }
            }else{

                $this->oracle->query("INSERT INTO  PRDDBFCOMERCIAL.TEMP_CLIENT_CATAST (
                CLICODFAC, EMAIL, DNI, 
                RUC, TELEFONO, NOMBRE, APEPAT, 
                APEMAT, CZONA, MZONA, CVIA, 
                MVIA, NUMERO, INTERIOR, LOTE, 
                DEPARTAMENTO, MANZANA, KILOMETRO, OFICOD, 
                AGECOD, USUARIO, ESTADO  
                )VALUES('".$suministro."','"
                         .$email."','"
                         .$dni."','"
                         .$ruc."','"
                         .$telefono."','"
                         .$nombre."','"
                         .$apepat."','"
                         .$apemat."','"
                         .$Selector_zona."','"
                         .$zona."','"
                         .$Selector_via."','"
                         .$via."','"
                         .$Numero."','"
                         .$Interior."','"
                         .$Lote."','"
                         .$Departamento."','"
                         .$Manzana."','"
                         .$Kilometro."',"
                         .$oficina.","
                         .$agencia.",'"
                         .$_SESSION['user_comercial']."',
                           1 ) ");

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    return false;
                }

            }

            
            $this->oracle->trans_commit(); 
            return true;
        }
    }


    public function Busco_Suministro_reporte($inicio, $fin, $tipo, $suministro){
        $consulta = "SELECT * FROM PRDDBFCOMERCIAL.CREDIT WHERE  CLIUNICOD= '".$suministro."' AND  CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$inicio."', 'DD/MM/YYYY') AND to_date('".$fin."', 'DD/MM/YYYY')";
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }

    public function Dato_CONVLINK_colateral($oficina, $agencia, $nro_credito){
        $consulta = "SELECT * FROM  PRDDBFCOMERCIAL.CONVLINK WHERE CREDIT_AGENCI_OFICIN_OFICOD = ".$oficina." AND CREDIT_AGENCI_OFIAGECOD = ".$agencia." AND ICREDNRO = ". $nro_credito;
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }

    public function Dato_CONVLINK($oficina, $agencia, $nro_credito){
        $consulta = "SELECT * FROM  PRDDBFCOMERCIAL.CONVLINK WHERE CREDIT_AGENCI_OFICIN_OFICOD = ".$oficina." AND CREDIT_AGENCI_OFIAGECOD = ".$agencia." AND CREDIT_CREDNRO = ". $nro_credito;
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }

    public function Dato_titular($oficina, $agencia, $nro_credito){
        $consulta = " SELECT SOLICINOM, SOLICIDIRE, SOLICIDNI,CREDFECHA, REPSOLNOM, REPSOLDNI, ESTADOACTA  FROM PRDDBFCOMERCIAL.DEUDAREC WHERE OFICOD = ".$oficina." AND OFIAGECOD = ".$agencia." AND CREDNRO =".$nro_credito;
        $query = $this->oracle->query($consulta);
        return $query->result_array();   
    }

    public function Dato_Letras($oficina, $agencia, $nro_credito){
        $consulta = " SELECT * FROM PRDDBFCOMERCIAL.LETRAS WHERE CREDIT_AGENCI_OFICIN_OFICOD = ".$oficina." AND CREDIT_AGENCI_OFIAGECOD = ".$agencia." AND CREDIT_CREDNRO =".$nro_credito;
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }

    public function Dato_Amortiza ($oficina, $agencia, $nro_credito){
        $consulta = " SELECT AMONRO FROM PRDDBFCOMERCIAL.AMORTIZA WHERE  CREDIT_AGENCI_OFICIN_OFICOD = ".$oficina." AND CREDIT_AGENCI_OFIAGECOD = ".$agencia." AND CREDIT_CREDNRO =".$nro_credito;
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }

    public function Dato_Corri_convenio ($oficina, $agencia, $nro_credito){
        $consulta = "SELECT CLICODFAX, FACSERNRO, FACNRO FROM PRDDBFCOMERCIAL.TOTFCONV WHERE OFICOD = ".$oficina." AND OFIAGECOD = ".$agencia." AND CREDNRO =".$nro_credito;
        $query = $this->oracle->query($consulta);
        return $query->result_array();   
    }

    public function Obtengo_dato_recibo($CLICODFAX, $FACSERNRO, $FACNRO){
        $consulta = "SELECT FACEMIFEC, FACSERNRO, FACNRO, FACTOTAL FROM PRDDBFCOMERCIAL.TOTFAC WHERE  FACSERNRO = ".$FACSERNRO." AND FACNRO = ".$FACNRO." AND CLICODFAX = ".$CLICODFAX;
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }

    public function Obtener_Credito_extorno($codigo_suministro, $tipo_convenio, $fecha_inicio, $fecha_final ){
        $consulta = "SELECT CREDIT.*
                        FROM PRDDBFCOMERCIAL.CREDIT
                        INNER JOIN PRDDBFCOMERCIAL.AMORTIZA
                        ON CREDIT.CREDNRO = AMORTIZA.CREDIT_CREDNRO AND  CREDIT.CLIUNICOD = '".$codigo_suministro."' AND CREDIT.CREDSTATUS = 'I' AND CREDIT.CREDTIPO = '".$tipo_convenio."'   AND CREDIT.CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_final."', 'DD/MM/YYYY') AND  AMORTIZA.AMOEST='I' ";
        $query = $this->oracle->query($consulta);
        return $query->result_array();  
    }
    public function Obtener_credito($codigo_suministro, $tipo_convenio, $fecha_inicio, $fecha_final){

        $consulta = "SELECT * FROM PRDDBFCOMERCIAL.CREDIT WHERE ( CONCEP_FACCONCOD != 847 AND CONCEP_FACCONCOD != 846 ) AND  CLIUNICOD = '".$codigo_suministro."' AND CTAINICIAL = 0 AND CREDSTATUS = 'I' AND CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_final."', 'DD/MM/YYYY') AND CREDTIPO = '".$tipo_convenio."'";
        $query = $this->oracle->query($consulta);
        return $query->result_array();   
    }

    public function obtengo_Letras($Dato_tabla) {
       $consulta = "SELECT * FROM PRDDBFCOMERCIAL.LETRAS  WHERE CREDIT_AGENCI_OFICIN_OFICOD = ".$Dato_tabla[1]." AND CREDIT_AGENCI_OFIAGECOD = ".$Dato_tabla[2]." AND CREDIT_CREDNRO = ".$Dato_tabla[3];
        $query = $this->oracle->query($consulta);
        return $query->result_array(); 
    }

    public function max_creanul(){
        $consulta = "SELECT MAX(NROOPE) AS MAXIMO  FROM PRDDBFCOMERCIAL.CREANUL WHERE OFICOD = ".$_SESSION['OFICOD']."AND OFIAGECOD =".$_SESSION['OFIAGECOD'];
        $query = $this->oracle->query($consulta);
        return $query->result_array(); 
    }
    public function Anular_Colaterales($Dato_tabla, $suministro, $referencia){
        //Busco el credito 
        $consulta = "SELECT * FROM PRDDBFCOMERCIAL.CREDIT WHERE AGENCI_OFICIN_OFICOD = ".$Dato_tabla[1]." AND AGENCI_OFIAGECOD =".$Dato_tabla[2]." AND CREDNRO = ".$Dato_tabla[3] ;
        $query = $this->oracle->query($consulta);

        $Credito = $query->result_array(); 
        if (count($Credito) > 0 ) {

            $consulta = "SELECT * FROM PRDDBFCOMERCIAL.AMORTIZA WHERE CREDIT_AGENCI_OFICIN_OFICOD = ".$Credito[0]['AGENCI_OFICIN_OFICOD']." AND CREDIT_AGENCI_OFIAGECOD = ".$Credito[0]['AGENCI_OFIAGECOD']." AND  CREDIT_CREDNRO =". $Credito[0]['CREDNRO'] ." AND AMOEST = 'I' "; 
            $query = $this->oracle->query($consulta);
            $Datos_amortiza = $query->result_array(); 
            
            if(count($Datos_amortiza)>0){
                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.AMORTIZA
                                    SET 
                                        AMOESTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                        AMOEST= 'A'
                                    WHERE CREDIT_AGENCI_OFIAGECOD = ".$Datos_amortiza[0]['CREDIT_AGENCI_OFIAGECOD']." AND
                                          CREDIT_AGENCI_OFICIN_OFICOD = ".$Datos_amortiza[0]['CREDIT_AGENCI_OFICIN_OFICOD']." AND
                                          CREDIT_CREDNRO =".$Datos_amortiza[0]['CREDIT_CREDNRO']);

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    return false;
                }
                // INSERTO EN EL CREANUL
                $numero_credit = $this->max_creanul();
                if(count($numero_credit)>0){
                    $maximo_operacion = (int)$numero_credit[0]["MAXIMO"]+ 1;
                }else{
                    $maximo_operacion = 1;
                }
                $creanul[0] = $Credito[0]['AGENCI_OFICIN_OFICOD']; // oficina 
                $creanul[1] = $Credito[0]['AGENCI_OFIAGECOD'];
                $creanul[2] = $Credito[0]['CREDNRO'];
                $creanul[3] = $Credito[0]['CLIUNICOD'];
                $creanul[4] = $Credito[0]['CREDFECHA'];
                $creanul[5] = $Credito[0]['DEUDATOTAL'];
                $creanul[6] = $Credito[0]['CTAINICIAL'];
                $creanul[7] = $Credito[0]['NROLTS'];
                $creanul[8] = $Credito[0]['CREDTIPO'];
                $creanul[9] = $Credito[0]['CONCEP_FACCONCOD'];
                $creanul[10] = $_SESSION['user_comercial'];
                $creanul[11] = $_SESSION['user_comercial'];
                $creanul[12] = $_SESSION['user_nom'];
                $creanul[13] = 1;
                $creanul[14] = $_SESSION['OFICOD'];
                $creanul[15] = $_SESSION['OFIAGECOD'];
                $creanul[16] = $referencia;// SOLO ES TEXTO DE EJEMPLO 
                $creanul[17] = $Credito[0]['SERVIDOR'];
                $creanul[18] = $maximo_operacion;
                $consulta = "INSERT INTO PRDDBFCOMERCIAL.CREANUL (
                                        OFICOD, OFIAGECOD, CREDNRO, CLIUNICOD, 
                                        CREDFECHA, DEUDATOTAL, CTAINICIAL, NROLTS,
                                        CREDTIPO, CRECONCOD, DIGCOD, USUARIO, 
                                        NEMOUSU, MOTIVOANUL, FECHANUL, OFIANUL, 
                                        OFIAGEANUL, REFEREANUL, SERVIDOR,
                                        CREDHRA, NROOPE
                                        )
                                    VALUES ( 
                                             ?, ?, ?, ?,
                                             ?, ?, ?, ?,
                                             ?, ?, ?, ?,
                                             ?, ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'), ?,
                                             ?, ?, ?,
                                             TO_CHAR(SYSDATE,'HH:MI:SS'), ?
                                            )";
 
                $this->oracle->query($consulta , $creanul );

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    return false;
                }

                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT 
                                        SET 
                                            CREDSTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                            CREDSTATUS= 'A'
                                        WHERE 
                                              CREDSTATUS= 'I' AND
                                              AGENCI_OFIAGECOD = ".$Dato_tabla[2]." AND
                                              AGENCI_OFICIN_OFICOD = ".$Dato_tabla[1]." AND
                                              CREDNRO =".$Dato_tabla[3]);

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    return false;
                }

                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.LETRAS  SET 
                                            LTSTATUS = 'A'
                                            WHERE  
                                                    LTSTATUS = 'I' AND
                                                    CREDIT_AGENCI_OFICIN_OFICOD = ".$Dato_tabla[1]."  AND
                                                    CREDIT_AGENCI_OFIAGECOD = ".$Dato_tabla[2]."  AND
                                                    CREDIT_CREDNRO = ".$Dato_tabla[3]);

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    return false;
                }
                /* PARA EL INTERES DEL CREDITO */
                $resultado = $this->oracle->query("SELECT  CREDSTATUS,  IOFICOD, IOFIAGECOD, ICREDNRO FROM  PRDDBFCOMERCIAL.CONVLINK  WHERE
                CREDIT_AGENCI_OFICIN_OFICOD = ".$Dato_tabla[1]." AND 
                CREDIT_AGENCI_OFIAGECOD = ".$Dato_tabla[2]." AND 
                CREDIT_CREDNRO =".$Dato_tabla[3]);
                $Modi_interes_credito = $resultado->result_array(); 
                if(count($Modi_interes_credito)>0){
                    $cred_ofi_inte = (int)$Modi_interes_credito[0]['IOFICOD'];
                    $cred_agen_inte = (int)$Modi_interes_credito[0]['IOFIAGECOD'];
                    $cred_numero_inte = (int)$Modi_interes_credito[0]['ICREDNRO'];
                    if($cred_ofi_inte != 0 && $cred_agen_inte != 0 && $cred_numero_inte != 0){
                        //CAMBIO DE ESTADO AL CREDIT
                        $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT 
                        SET 
                            CREDSTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                            CREDSTATUS= 'A'
                        WHERE AGENCI_OFIAGECOD = ".$Modi_interes_credito[0]['IOFIAGECOD']." AND
                            AGENCI_OFICIN_OFICOD = ".$Modi_interes_credito[0]['IOFICOD']." AND
                            CREDNRO =".$Modi_interes_credito[0]['ICREDNRO']);

                        if($this->oracle->trans_status() === FALSE){
                            $this->oracle->trans_rollback();
                            return false;
                        }
                        /* Modifico Letras */
                        $this->oracle->query("UPDATE PRDDBFCOMERCIAL.LETRAS  SET 
                                            LTSTATUS = 'A'
                                            WHERE   CREDIT_AGENCI_OFICIN_OFICOD = ".$Modi_interes_credito[0]['IOFICOD']."  AND
                                                    CREDIT_AGENCI_OFIAGECOD = ".$Modi_interes_credito[0]['IOFIAGECOD']."  AND
                                                    LTSTATUS = 'A' AND 
                                                    CREDIT_CREDNRO = ".$Modi_interes_credito[0]['ICREDNRO']);

                        if($this->oracle->trans_status() === FALSE){
                            $this->oracle->trans_rollback();
                            return false;
                        }
                    }
                    
                }
                $this->oracle->trans_commit();
                return true; 
                
            }else{
                $numero_credit = $this->max_creanul();
                if(count($numero_credit)>0){
                    $maximo_operacion = (int)$numero_credit[0]["MAXIMO"]+ 1;
                }else{
                    $maximo_operacion = 1;
                }
                // INSERTO EN EL CREANUL
                $creanul[0] = $Credito[0]['AGENCI_OFICIN_OFICOD']; // oficina 
                $creanul[1] = $Credito[0]['AGENCI_OFIAGECOD'];
                $creanul[2] = $Credito[0]['CREDNRO'];
                $creanul[3] = $Credito[0]['CLIUNICOD'];
                $creanul[4] = $Credito[0]['CREDFECHA'];
                $creanul[5] = $Credito[0]['DEUDATOTAL'];
                $creanul[6] = $Credito[0]['CTAINICIAL'];
                $creanul[7] = $Credito[0]['NROLTS'];
                $creanul[8] = $Credito[0]['CREDTIPO'];
                $creanul[9] = $Credito[0]['CONCEP_FACCONCOD'];
                $creanul[10] = $_SESSION['user_comercial'];
                $creanul[11] = $_SESSION['user_comercial'];
                $creanul[12] = $_SESSION['user_nom'];
                $creanul[13] = 1;
                $creanul[14] = $_SESSION['OFICOD'];
                $creanul[15] = $_SESSION['OFIAGECOD'];
                $creanul[16] = $referencia;// SOLO ES TEXTO DE EJEMPLO 
                $creanul[17] = $Credito[0]['SERVIDOR'];
                $creanul[18] = $maximo_operacion;
                $consulta = "INSERT INTO PRDDBFCOMERCIAL.CREANUL (
                                        OFICOD, OFIAGECOD, CREDNRO, CLIUNICOD, 
                                        CREDFECHA, DEUDATOTAL, CTAINICIAL, NROLTS,
                                        CREDTIPO, CRECONCOD, DIGCOD, USUARIO, 
                                        NEMOUSU, MOTIVOANUL, FECHANUL, OFIANUL, 
                                        OFIAGEANUL, REFEREANUL, SERVIDOR,
                                        CREDHRA, NROOPE
                                        )
                                    VALUES ( 
                                             ?, ?, ?, ?,
                                             ?, ?, ?, ?,
                                             ?, ?, ?, ?,
                                             ?, ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'), ?,
                                             ?, ?, ?,
                                             TO_CHAR(SYSDATE,'HH:MI:SS'), ?
                                            )";
 
                $this->oracle->query($consulta , $creanul );

                if($this->oracle->trans_status() === FALSE){
                        $this->oracle->trans_rollback();
                        return false;
                }

                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT 
                                        SET 
                                            CREDSTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                            CREDSTATUS= 'A'
                                        WHERE AGENCI_OFIAGECOD = ".$Dato_tabla[2]." AND
                                              AGENCI_OFICIN_OFICOD = ".$Dato_tabla[1]." AND
                                              CREDNRO =".$Dato_tabla[3]);

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    return false;
                }

                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.LETRAS  SET 
                                            LTSTATUS = 'A'
                                            WHERE   CREDIT_AGENCI_OFICIN_OFICOD = ".$Dato_tabla[1]."  AND
                                                    CREDIT_AGENCI_OFIAGECOD = ".$Dato_tabla[2]."  AND
                                                    CREDIT_CREDNRO = ".$Dato_tabla[3]);

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    return false;
                }
                /* PARA EL INTERES DEL CREDITO */
                $resultado = $this->oracle->query("SELECT  CREDSTATUS,  IOFICOD, IOFIAGECOD, ICREDNRO FROM  PRDDBFCOMERCIAL.CONVLINK  WHERE
                CREDIT_AGENCI_OFICIN_OFICOD = ".$Dato_tabla[1]." AND 
                CREDIT_AGENCI_OFIAGECOD = ".$Dato_tabla[2]." AND 
                CREDIT_CREDNRO =".$Dato_tabla[3]);
                $Modi_interes_credito = $resultado->result_array(); 
                if(count($Modi_interes_credito)>0){
                    $cred_ofi_inte = (int)$Modi_interes_credito[0]['IOFICOD'];
                    $cred_agen_inte = (int)$Modi_interes_credito[0]['IOFIAGECOD'];
                    $cred_numero_inte = (int)$Modi_interes_credito[0]['ICREDNRO'];
                    if($cred_ofi_inte != 0 && $cred_agen_inte != 0 && $cred_numero_inte != 0){
                        //CAMBIO DE ESTADO AL CREDIT
                        $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT 
                        SET 
                            CREDSTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                            CREDSTATUS= 'A'
                        WHERE AGENCI_OFIAGECOD = ".$Modi_interes_credito[0]['IOFIAGECOD']." AND
                            AGENCI_OFICIN_OFICOD = ".$Modi_interes_credito[0]['IOFICOD']." AND
                            CREDNRO =".$Modi_interes_credito[0]['ICREDNRO']);

                        if($this->oracle->trans_status() === FALSE){
                            $this->oracle->trans_rollback();
                            return false;
                        }
                        /* Modifico Letras */
                        $this->oracle->query("UPDATE PRDDBFCOMERCIAL.LETRAS  SET 
                                            LTSTATUS = 'A'
                                            WHERE   CREDIT_AGENCI_OFICIN_OFICOD = ".$Modi_interes_credito[0]['IOFICOD']."  AND
                                                    CREDIT_AGENCI_OFIAGECOD = ".$Modi_interes_credito[0]['IOFIAGECOD']."  AND
                                                    LTSTATUS = 'A' AND 
                                                    CREDIT_CREDNRO = ".$Modi_interes_credito[0]['ICREDNRO']);

                        if($this->oracle->trans_status() === FALSE){
                            $this->oracle->trans_rollback();
                            return false;
                        }
                    }
                    
                }
                $this->oracle->trans_commit();
                return true; 
            }

             
        }else{
            return false ;
        }
    }

    public function Extorno_deuda($Dato_tabla, $suministro, $referencia){
        $consulta = "SELECT * FROM PRDDBFCOMERCIAL.CREDIT WHERE AGENCI_OFICIN_OFICOD = ".$Dato_tabla[1]." AND AGENCI_OFIAGECOD =".$Dato_tabla[2]." AND CREDNRO = ".$Dato_tabla[3] ;
        $query = $this->oracle->query($consulta);
        $Credito = $query->result_array(); 
        if ( count($Credito) > 0 ) {
            $consulta = "SELECT * FROM PRDDBFCOMERCIAL.AMORTIZA WHERE CREDIT_AGENCI_OFICIN_OFICOD = ".$Credito[0]['AGENCI_OFICIN_OFICOD']." AND CREDIT_AGENCI_OFIAGECOD = ".$Credito[0]['AGENCI_OFIAGECOD']." AND  CREDIT_CREDNRO =". $Credito[0]['CREDNRO'] ." AND AMOEST = 'I' "; 
            $query = $this->oracle->query($consulta);
            $Datos_amortiza = $query->result_array();
            $this->oracle->trans_begin();
            if(count($Datos_amortiza) > 0){
                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.AMORTIZA
                                    SET 
                                        AMOESTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                        AMOEST = 'A'
                                    WHERE 
                                        CREDIT_AGENCI_OFIAGECOD = ".$Datos_amortiza[0]['CREDIT_AGENCI_OFIAGECOD']." AND
                                        CREDIT_AGENCI_OFICIN_OFICOD = ".$Datos_amortiza[0]['CREDIT_AGENCI_OFICIN_OFICOD']." AND
                                        CREDIT_CREDNRO = ".$Datos_amortiza[0]['CREDIT_CREDNRO']);

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    return false;
                }

                // INSERTO EN EL CREANUL
                $creanul[0] = $Credito[0]['AGENCI_OFICIN_OFICOD']; // oficina 
                $creanul[1] = $Credito[0]['AGENCI_OFIAGECOD'];
                $creanul[2] = $Credito[0]['CREDNRO'];
                $creanul[3] = $Credito[0]['CLIUNICOD'];
                $creanul[4] = $Credito[0]['CREDFECHA'];
                $creanul[5] = $Credito[0]['DEUDATOTAL'];
                $creanul[6] = $Credito[0]['CTAINICIAL'];
                $creanul[7] = $Credito[0]['NROLTS'];
                $creanul[8] = $Credito[0]['CREDTIPO'];
                $creanul[9] = $Credito[0]['CONCEP_FACCONCOD'];
                $creanul[10] = $_SESSION['user_comercial'];
                $creanul[11] = $_SESSION['user_comercial'];
                $creanul[12] = $_SESSION['user_nom'];
                $creanul[13] = 1;
                $creanul[14] = $_SESSION['OFICOD'];
                $creanul[15] = $_SESSION['OFIAGECOD'];
                $creanul[16] = $referencia;// SOLO ES TEXTO DE EJEMPLO 
                $creanul[17] = $Credito[0]['SERVIDOR'];

                $consulta = "INSERT INTO PRDDBFCOMERCIAL.CREANUL (
                                    OFICOD, OFIAGECOD, CREDNRO, CLIUNICOD, 
                                    CREDFECHA, DEUDATOTAL, CTAINICIAL, NROLTS,
                                    CREDTIPO, CRECONCOD, DIGCOD, USUARIO, 
                                    NEMOUSU, MOTIVOANUL, FECHANUL, OFIANUL, 
                                    OFIAGEANUL, REFEREANUL, SERVIDOR,
                                    CREDHRA
                                    )
                                VALUES ( 
                                         ?, ?, ?, ?,
                                         ?, ?, ?, ?,
                                         ?, ?, ?, ?,
                                         ?, ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'), ?,
                                         ?, ?, ?,
                                         TO_CHAR(SYSDATE,'HH:MI:SS')
                                        )";

                $this->oracle->query($consulta , $creanul );
                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    return false;
                }
                /* Modifico Credito */

                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT 
                                    SET 
                                        CREDSTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                        CREDSTATUS= 'A'
                                    WHERE AGENCI_OFIAGECOD = ".$Dato_tabla[2]." AND
                                          AGENCI_OFICIN_OFICOD = ".$Dato_tabla[1]." AND
                                          CREDNRO =".$Dato_tabla[3]." AND
                                          CREDSTATUS != 'A'");

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    return false;
                }
                /* Modifico Letras */

                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.LETRAS  SET 
                                        LTSTATUS = 'A'
                                        WHERE   CREDIT_AGENCI_OFICIN_OFICOD = ".$Dato_tabla[1]."  AND
                                                CREDIT_AGENCI_OFIAGECOD = ".$Dato_tabla[2]."  AND
                                                CREDIT_CREDNRO = ".$Dato_tabla[3]." AND
                                                (LTSTATUS != 'F' OR LTSTATUS != 'P')");

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    return false;
                }

                // MODIFICO EL DEUDAREC
                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.DEUDAREC 
                                SET 
                                    FECESTACTA = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                    ESTADOACTA= 'R'
                                WHERE OFIAGECOD = ".$Dato_tabla[2]." AND
                                    OFICOD = ".$Dato_tabla[1]." AND
                                    CREDNRO =".$Dato_tabla[3]);

                if($this->oracle->trans_status() === FALSE){
                $this->oracle->trans_rollback();
                return false;
                }
                /* PARA EL INTERES DEL CREDITO */
                $resultado = $this->oracle->query("SELECT  CREDSTATUS,  IOFICOD, IOFIAGECOD, ICREDNRO FROM  PRDDBFCOMERCIAL.CONVLINK  WHERE
                                      CREDIT_AGENCI_OFICIN_OFICOD = ".$Dato_tabla[1]." AND 
                                      CREDIT_AGENCI_OFIAGECOD = ".$Dato_tabla[2]." AND 
                                      CREDIT_CREDNRO =".$Dato_tabla[3]);
                $Modi_interes_credito = $resultado->result_array(); 
                if(count($Modi_interes_credito)>0){
                    //CAMBIO DE ESTADO AL CREDIT
                    $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT 
                                    SET 
                                        CREDSTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                        CREDSTATUS= 'A'
                                    WHERE AGENCI_OFIAGECOD = ".$Modi_interes_credito[0]['IOFIAGECOD']." AND
                                        AGENCI_OFICIN_OFICOD = ".$Modi_interes_credito[0]['IOFICOD']." AND
                                        CREDNRO =".$Modi_interes_credito[0]['ICREDNRO']);

                    if($this->oracle->trans_status() === FALSE){
                        $this->oracle->trans_rollback();
                        return false;
                    }
                    /* Modifico Letras */
                    $this->oracle->query("UPDATE PRDDBFCOMERCIAL.LETRAS  SET 
                                            LTSTATUS = 'A'
                                            WHERE   CREDIT_AGENCI_OFICIN_OFICOD = ".$Modi_interes_credito[0]['IOFICOD']."  AND
                                                    CREDIT_AGENCI_OFIAGECOD = ".$Modi_interes_credito[0]['IOFIAGECOD']."  AND
                                                    LTSTATUS = 'A' AND 
                                                    CREDIT_CREDNRO = ".$Modi_interes_credito[0]['ICREDNRO']);

                    if($this->oracle->trans_status() === FALSE){
                        $this->oracle->trans_rollback();
                        return false;
                    }
                }
                /*modifico si es que tiene recibos  */

                $reci = $this->oracle->query("SELECT CLICODFAX, FACSERNRO, FACNRO FROM PRDDBFCOMERCIAL.TOTFCONV WHERE   
                                        OFICOD = ".$Dato_tabla[1]."  AND
                                        OFIAGECOD = ".$Dato_tabla[2]."  AND
                                        CREDNRO = ".$Dato_tabla[3]);
                $recibos = $reci->result_array(); 
                if(count($recibos) > 0 ){
                    $i = 0;
                    while($i < count($recibos)){
                        $consulta = "UPDATE PRDDBFCOMERCIAL.TOTFAC SET FACESTADO='I' , FACESTFECH = TO_CHAR(SYSDATE,'DD-MON-YYYY')  
                             WHERE FACSERNRO = ".$recibos[$i]['FACSERNRO']." AND FACNRO = ".$recibos[$i]['FACNRO'];
                        $this->oracle->query($consulta);
                        if($this->oracle->trans_status() === FALSE){
                            $this->oracle->trans_rollback();
                            return false;
                        }
                        // PARA LA NOTA DE CREDITO
                        if( ($i+1) == count($recibos) ){
                            $consulta = "UPDATE PRDDBFCOMERCIAL.NCA SET NCAFACESTA='A'   
                             WHERE TOTFAC_FACSERNRO = ".$recibos[$i]['FACSERNRO']." AND TOTFAC_FACNRO = ".$recibos[$i]['FACNRO']." AND NCAFACESTA = 'C'";
                            $this->oracle->query($consulta);
                            if($this->oracle->trans_status() === FALSE){
                                $this->oracle->trans_rollback();
                                return false;
                            }
                        }
                        $i++;
                    } 
                }
                /* PARA MODIFICAR LAS NOTAS DE CREDITO */
                $nca_credito = $this->oracle->query("SELECT NCASERNRO, NCANRO, NCAFACSERN, NCAFACNRO FROM PRDDBFCOMERCIAL.NCACONV WHERE   
                                        NOFICOD = ".$Dato_tabla[1]."  AND
                                        NOFIAGECO = ".$Dato_tabla[2]."  AND
                                        NCREDNRO = ".$Dato_tabla[3]);
                $nca_credito_debito = $nca_credito->result_array(); 
                $i = 0 ;
                while($i < count($nca_credito_debito)){
                    $this->oracle->query("UPDATE PRDDBFCOMERCIAL.NCA
                                        SET 
                                            NCAFACESTF = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                            NCAFACESTA= 'I'
                                        WHERE NCASERNRO = ". $nca_credito_debito[$i]['NCASERNRO']." AND
                                            NCANRO = ". $nca_credito_debito[$i]['NCANRO']." AND
                                            TOTFAC_FACSERNRO =". $nca_credito_debito[$i]['NCAFACSERN']." AND
                                            TOTFAC_FACNRO =". $nca_credito_debito[$i]['NCAFACNRO']);

                    if($this->oracle->trans_status() === FALSE){
                        $this->oracle->trans_rollback();
                        return false;
                    }
                    $i++;
                }
                /* PARA LOS  CREDITOS PENDIENTES  */
                $conv_ant = $this->oracle->query("SELECT OFICOD, OFIAGECOD, CREDNRO, CLIUNICOD FROM PRDDBFCOMERCIAL.CREDCONV WHERE   
                                                NOFICOD = ".$Dato_tabla[1]."  AND
                                                NOFIAGECO = ".$Dato_tabla[2]."  AND
                                                NCREDNRO = ".$Dato_tabla[3]);
                $conv_ante = $conv_ant->result_array(); 
                if(count($conv_ante) > 0 ){
                    $i = 0 ;
                    while($i < count($conv_ante) ){
                        //CAMBIO DE ESTADO AL CREDIT
                        $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT 
                                        SET 
                                            CREDSTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                            CREDSTATUS= 'I'
                                        WHERE AGENCI_OFIAGECOD = ".$conv_ante[$i]['OFIAGECOD']." AND
                                            AGENCI_OFICIN_OFICOD = ".$conv_ante[$i]['OFICOD']." AND
                                            CREDNRO =".$conv_ante[$i]['CREDNRO']." AND 
                                            CREDSTATUS = 'Z'");

                        if($this->oracle->trans_status() === FALSE){
                            $this->oracle->trans_rollback();
                            return false;
                        }
                        /* Modifico Letras */
                        $this->oracle->query("UPDATE PRDDBFCOMERCIAL.LETRAS  SET 
                                                LTSTAFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                                LTSTATUS = 'I'
                                                WHERE   CREDIT_AGENCI_OFICIN_OFICOD = ".$conv_ante[$i]['OFICOD']."  AND
                                                        CREDIT_AGENCI_OFIAGECOD = ".$conv_ante[$i]['OFIAGECOD']."  AND
                                                        CREDIT_CREDNRO = ".$conv_ante[$i]['CREDNRO']." AND
                                                        LTSTATUS = 'Z'");

                        if($this->oracle->trans_status() === FALSE){
                            $this->oracle->trans_rollback();
                            return false;
                        }
                        $resultado = $this->oracle->query("SELECT  CREDSTATUS,  IOFICOD, IOFIAGECOD, ICREDNRO FROM  PRDDBFCOMERCIAL.CONVLINK  WHERE
                                      CREDIT_AGENCI_OFICIN_OFICOD = ".$conv_ante[$i]['OFICOD']." AND 
                                      CREDIT_AGENCI_OFIAGECOD = ".$conv_ante[$i]['OFIAGECOD']." AND 
                                      CREDIT_CREDNRO =".$conv_ante[$i]['CREDNRO']);
                        $Modi_interes = $resultado->result_array(); 
                        if(count($Modi_interes) > 0) { 
                            $cred_ofi_inte = (int)$Modi_interes[0]['IOFICOD'];
                            $cred_agen_inte = (int)$Modi_interes[0]['IOFIAGECOD'];
                            $cred_numero_inte = (int)$Modi_interes[0]['ICREDNRO'];
                            if($cred_ofi_inte != 0 && $cred_agen_inte != 0 && $cred_numero_inte != 0){
                                //CAMBIO DE ESTADO AL CREDIT
                                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT 
                                                SET 
                                                    CREDSTFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                                    CREDSTATUS= 'I'
                                                WHERE AGENCI_OFIAGECOD = ".$Modi_interes[0]['IOFIAGECOD']." AND
                                                    AGENCI_OFICIN_OFICOD = ".$Modi_interes[0]['IOFICOD']." AND
                                                    CREDNRO =".$Modi_interes[0]['ICREDNRO']." AND 
                                                    CREDSTATUS = 'A'");

                                if($this->oracle->trans_status() === FALSE){
                                    $this->oracle->trans_rollback();
                                    return false;
                                }

                                /* Modifico Letras */
                                $this->oracle->query("UPDATE PRDDBFCOMERCIAL.LETRAS  SET 
                                                        LTSTAFEC = TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                                                        LTSTATUS = 'I'
                                                        WHERE   CREDIT_AGENCI_OFICIN_OFICOD = ".$Modi_interes[0]['IOFICOD']."  AND
                                                                CREDIT_AGENCI_OFIAGECOD = ".$Modi_interes[0]['IOFIAGECOD']."  AND
                                                                LTSTATUS = 'A' AND 
                                                                CREDIT_CREDNRO = ".$Modi_interes[0]['ICREDNRO']);

                                if($this->oracle->trans_status() === FALSE){
                                    $this->oracle->trans_rollback();
                                    return false;
                                }
                            }
                                
                        }
                        //---------------------------
                        $i++;
                    }
                }
                // PARA ANULAR EL PAGO 
                //PRDRECAUDACIONORA12C.MDOCGLB
                $this->oracle->query("UPDATE PRDRECAUDACIONORA12C.MDOCGLB  SET 
                                        SDGCOD = 4
                                        WHERE ESECOD = 1 AND
                                              MDCCOD = 6 AND 
                                              MDGSERDOC = ".$Dato_tabla[1].$Dato_tabla[2]." AND MDGNRODOC = ".$Datos_amortiza[0]['AMONRO'] );

                if($this->oracle->trans_status() === FALSE){
                    $this->oracle->trans_rollback();
                    return false;
                }
                $this->oracle->trans_commit();
                return true;
            }
            else{
                //echo "no cumplo con el amortiza";
                return false;
            }
        }else{
            return false;
        }
    }

    public function obtengo_conceptos(){
        $consulta = "SELECT FACCONCOD, FACCONDES FROM PRDDBFCOMERCIAL.CONCEP WHERE ESTADO= 1 AND GRATUITO != 1 AND FACCONDES NOT LIKE '%INTE%' ORDER BY FACCONCOD DESC";
        $query = $this->oracle->query($consulta);
        return $query->result_array(); 
    }

    public function obtengo_interes(){
        $consulta = "SELECT FACCONCOD, FACCONDES FROM PRDDBFCOMERCIAL.CONCEP WHERE FACCONCOD = 847";
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }


    public function veri_reclamo( $serie, $numero ){
        /*$consulta = "SELECT SRECCOD, SSITCOD FROM PRDGESTIONCOMERCIAL.ORECLAMO NEXORECLAMO ,PRDGESTIONCOMERCIAL.ORECLAFAC ESTADORECLAMO 
                    WHERE
                    NEXORECLAMO.EMPCOD = ESTADORECLAMO.EMPCOD AND NEXORECLAMO.OFICOD = ESTADORECLAMO.OFICOD AND NEXORECLAMO.ARECOD = ESTADORECLAMO.ARECOD AND 
                    NEXORECLAMO.CTDCOD = ESTADORECLAMO.CTDCOD AND NEXORECLAMO.DOCCOD = ESTADORECLAMO.DOCCOD AND NEXORECLAMO.SERNRO = ESTADORECLAMO.SERNRO AND 
                    NEXORECLAMO.RECID = ESTADORECLAMO.RECID AND   NEXORECLAMO.SRECCOD = 2  AND ESTADORECLAMO.OFACSERNRO= ".$serie." AND ESTADORECLAMO.OFACNRO =". $numero  ; */
        $consulta = "SELECT SRECCOD, SSITCOD FROM PRDGESTIONCOMERCIAL.ORECLAMO NEXORECLAMO ,PRDGESTIONCOMERCIAL.ORECLAFAC ESTADORECLAMO 
                    WHERE
                    NEXORECLAMO.EMPCOD = ESTADORECLAMO.EMPCOD AND NEXORECLAMO.OFICOD = ESTADORECLAMO.OFICOD AND NEXORECLAMO.ARECOD = ESTADORECLAMO.ARECOD AND 
                    NEXORECLAMO.CTDCOD = ESTADORECLAMO.CTDCOD AND NEXORECLAMO.DOCCOD = ESTADORECLAMO.DOCCOD AND NEXORECLAMO.SERNRO = ESTADORECLAMO.SERNRO AND 
                    NEXORECLAMO.RECID = ESTADORECLAMO.RECID AND  ESTADORECLAMO.OFACSERNRO= ".$serie." AND ESTADORECLAMO.OFACNRO =". $numero  ;
        $query = $this->oracle->query($consulta);
        return $query->result_array(); 
    }


    public function get_all_proforma(){
        $query = $this->oracle->query("SELECT *  FROM
                                    (SELECT /*+ INDEX (INDEX_DRCFECH) */
                                    CREDNRO, CLICODFAC, to_char(CREDFECHA, 'DD-MM-YYYY') AS FECHA,
                                    OFICOD, OFIAGECOD, SOLICINOM, SOLICIDNI , REPSOLNOM,REPSOLDNI,
                                    INICIAL,EST_PAGO
                                        FROM PRDDBFCOMERCIAL.DEUDAREC
                                        WHERE 
                                        TO_CHAR(CREDFECHA,'YYYYMMDD') = TO_CHAR(SYSDATE,'YYYYMMDD')
                                        ORDER BY CREDFECHA DESC )
                                        WHERE ROWNUM <=500"); 
        $lista = $query->result_array();
        return $lista;
    }

    public function get_all_pagados(){
        $query = $this->oracle->query("SELECT *  FROM
                                    (SELECT /*+ INDEX (INDEX_DRCFECH) */
                                    CREDNRO, CLICODFAC, to_char(CREDFECHA, 'DD-MM-YYYY') AS FECHA,
                                    OFICOD, OFIAGECOD, SOLICINOM, SOLICIDNI , REPSOLNOM,REPSOLDNI,
                                    INICIAL,EST_PAGO
                                        FROM PRDDBFCOMERCIAL.DEUDAREC
                                        WHERE 
                                        TO_CHAR(CREDFECHA,'YYYYMMDD') = TO_CHAR(SYSDATE,'YYYYMMDD') AND EST_PAGO = 1
                                        ORDER BY CREDFECHA DESC )
                                        WHERE ROWNUM <=500"); 
        $lista = $query->result_array();
        return $lista;
    }

    

    public function get_pago_inicial($oficina, $agencia, $num_credito){
        $query = $this->oracle->query("SELECT /*+ INDEX (INDEX_DRCFECH) */
                                    CREDNRO, CLICODFAC, to_char(CREDFECHA, 'DD-MM-YYYY') AS FECHA,
                                    OFICOD, OFIAGECOD, SOLICINOM, SOLICIDNI , REPSOLNOM,REPSOLDNI,DIGCOD,
                                    INICIAL,EST_PAGO, RECONRO,SOLICIDIRE,REPSOLDIRE
                                        FROM PRDDBFCOMERCIAL.DEUDAREC
                                        WHERE OFICOD=".$oficina." AND OFIAGECOD =".$agencia." AND CREDNRO = ".$num_credito); 
        $lista = $query->result_array();
        return $lista;
    }

    public function get_permiso_fina($oficina, $agencia, $num_credito){
        $query = $this->oracle->query("SELECT OFICOD, OFIAGECOD, AUT_NCANRO
                                        FROM PRDDBFCOMERCIAL.FINANGX_LETS
                                        WHERE OFICOD=".$oficina." AND OFIAGECOD =".$agencia." AND AUT_NCANRO = ".$num_credito); 
        $lista = $query->result_array();
        return $lista;
    }

    public function Lista_a_extornar(){

        $query = $this->oracle->query("SELECT DEUDA.CLICODFAC, DEUDA.OFICOD, DEUDA.OFIAGECOD, DEUDA.CREDNRO , DEUDA.CREDFECHA AS FECHA, DEUDA.SOLICINOM, DEUDA.SOLICIDNI, DEUDA.SOLICIDNI,
                                        DEUDA.REPSOLNOM, DEUDA.REPSOLDIRE, DEUDA.REPSOLDNI, DEUDA.INICIAL, PERMISO.AUT_EST FROM PRDDBFCOMERCIAL.FINANGX_LETS PERMISO ,PRDDBFCOMERCIAL.DEUDAREC DEUDA 
                                        WHERE PERMISO.OFICOD= DEUDA.OFICOD AND PERMISO.OFIAGECOD = DEUDA.OFIAGECOD AND PERMISO.AUT_NCANRO = DEUDA.CREDNRO AND 
                                        TO_CHAR(DEUDA.CREDFECHA,'YYYYMMDD') = TO_CHAR(SYSDATE,'YYYYMMDD')  AND PERMISO.AUT_OPE =".$_SESSION['user_id']); 

        /*$query = $this->oracle->query("SELECT *
                                        FROM TESTPRDDBF COMERCIAL.FINANGX_LETS
                                        WHERE OFICOD=".$_SESSION['OFICOD']." AND OFIAGECOD =".$_SESSION['OFIAGECOD']." AND TO_CHAR(AUT_FEC,'YYYYMMDD') = TO_CHAR(SYSDATE,'YYYYMMDD')  AND AUT_OPE =".$_SESSION['user_id']); 
        */
        $lista = $query->result_array();
        return $lista;
    }

    public function suministro_en_tramite($fecha_inicio, $fecha_fin){
        $consulta = "SELECT * FROM PRDDBFCOMERCIAL.TRAMITE_JUDICIAL WHERE TRUNC (FECHREG) BETWEEN TO_DATE(?, 'DD-MM-YYYY') AND TO_DATE(?, 'DD-MM-YYYY')";
        $query = $this->oracle->query($consulta, array( $fecha_inicio, $fecha_fin));
        return $query->result_array();
    }

    public function suministro_judicial_editar($suministro){
        $consulta = "SELECT * FROM PRDDBFCOMERCIAL.TRAMITE_JUDICIAL WHERE CLICODFAC = '".$suministro."'";
        $query = $this->oracle->query($consulta);
        return $query->result_array();  
    }

    public function suministro_en_proceso_judicial($codigo_suministro){
        $consulta = "SELECT * FROM PRDDBFCOMERCIAL.TRAMITE_JUDICIAL WHERE CLICODFAC ='".$codigo_suministro."' AND ESTJUDICIAL = 1";
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }

    public function suministro_judicial_nuevo($datos){
        $this->oracle->trans_begin();
        $consulta = "INSERT INTO PRDDBFCOMERCIAL.TRAMITE_JUDICIAL (
                CLICODFAC, CLINOMBRE, CLIDIR, CLILOCALI,
                COAGUA, CODESA, CLIESTA, FECHREG, 
                HRAREG, FECHUPD, HRAUPD, USRCODREG,
                USRCODUPD, ESTJUDICIAL
                    )
        VALUES ( ?, ?, ?, ?,
                 ?, ?, ?, TO_CHAR(SYSDATE,'DD-MON-YYYY'),
                 TO_CHAR(SYSDATE,'HH:MI:SS'), TO_CHAR(SYSDATE,'DD-MON-YYYY'), TO_CHAR(SYSDATE,'HH:MI:SS'), ".$_SESSION['user_id'].",
                 ".$_SESSION['user_id'].", 1   
        )";
        $this->oracle->query($consulta, $datos);
        if($this->oracle->trans_status() === FALSE){
            $this->oracle->trans_rollback();
            return $respuesta;
        }
        $this->oracle->trans_commit();
        return true;

    }

    public function guardar_judicial_edicion($suministro, $estado ){
        $this->oracle->trans_begin();
        $this->oracle->query("UPDATE PRDDBFCOMERCIAL.TRAMITE_JUDICIAL
        SET ESTJUDICIAL= ".$estado." , FECHUPD = TO_CHAR(SYSDATE,'DD-MON-YYYY') , HRAUPD = TO_CHAR(SYSDATE,'HH:MI:SS'), USRCODUPD =".$_SESSION['user_id']."
        WHERE CLICODFAC =".$suministro);
        if($this->oracle->trans_status() === FALSE){
            $this->oracle->trans_rollback();
            return $respuesta;
        }
        $this->oracle->trans_commit();
        return true;
    }

    public function guardo_dire_titula($suministro,$nro_credito,$dire_tabla){
        $this->oracle->trans_begin();
        $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT
        SET DIRE_ARCH_TITULAR= '".$dire_tabla."' WHERE CREDNRO = ".$nro_credito." AND  CLIUNICOD ='".$suministro."'");
        if($this->oracle->trans_status() === FALSE){
            $this->oracle->trans_rollback();
            return $respuesta;
        }
        $this->oracle->trans_commit();
        return true;
    }

    public function guardo_dire_representante($suministro,$nro_credito,$dire_tabla){
        $this->oracle->trans_begin();
        $this->oracle->query("UPDATE PRDDBFCOMERCIAL.CREDIT
        SET DIRE_ARCH_REPRE= '".$dire_tabla."' WHERE CREDNRO = ".$nro_credito." AND  CLIUNICOD ='".$suministro."'");
        if($this->oracle->trans_status() === FALSE){
            $this->oracle->trans_rollback();
            return $respuesta;
        }
        $this->oracle->trans_commit();
        return true;
    }

    public function Busco_archi_reporte($numero_credito, $cod_suministro){
        $consulta = "SELECT DIRE_ARCH_TITULAR, DIRE_ARCH_REPRE FROM PRDDBFCOMERCIAL.CREDIT WHERE CREDNRO ='".$numero_credito."' AND CLIUNICOD = '".$cod_suministro."'";
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }

    public function get_financiamientos($fecha_inicio, $fecha_fin, $tipo, $concepto_redondeo , $fina_anulado, $concep_847, $estado_financiamiento, $valor_oficinas){
        if($valor_oficinas==0){
            if($tipo == 'Z'){
                if($estado_financiamiento =='T'){
                    $consulta = "SELECT CRED.CREDSTATUS,  CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , 
                                    (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS TITULAR ,(SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS ESTADO , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS ESTADO_EXTORNO , (SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR 
                                    FROM PRDDBFCOMERCIAL.CREDIT CRED 
                                    WHERE CRED.AGENCI_OFIAGECOD = ".$_SESSION['OFIAGECOD']." AND CRED.AGENCI_OFICIN_OFICOD =". $_SESSION['OFICOD'] ." AND  CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                }else{
                    if($estado_financiamiento =='ANU'){
                        $consulta = "SELECT CRED.CREDSTATUS,  CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , 
                        (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS TITULAR  , (SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD) AS ESTADO , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS ESTADO_EXTORNO ,(SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR 
                        FROM PRDDBFCOMERCIAL.CREDIT CRED 
                        WHERE CRED.CREDSTATUS ='A' AND CRED.AGENCI_OFIAGECOD = ".$_SESSION['OFIAGECOD']." AND CRED.AGENCI_OFICIN_OFICOD =". $_SESSION['OFICOD'] ." AND  CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                    }else{
                        if($estado_financiamiento =='IM'){
                            $consulta = "SELECT CRED.CREDSTATUS, CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, 
                            CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC 
                            WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD) AS TITULAR  , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS ESTADO_EXTORNO ,  (SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS ESTADO , (SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR 
                       FROM PRDDBFCOMERCIAL.CREDIT CRED , PRDDBFCOMERCIAL.AMORTIZA AMORTI , PRDRECAUDACIONORA12C.MDOCGLB COBRANZA
                       WHERE   CRED.AGENCI_OFIAGECOD = ".$_SESSION['OFIAGECOD']." AND CRED.AGENCI_OFICIN_OFICOD = ". $_SESSION['OFICOD'] ." AND  CREDTIPO = '".$tipo."' AND  
                              CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY') AND AMORTI.CREDIT_CREDNRO = CRED.CREDNRO 
                              AND AMORTI.AMONRO=COBRANZA.MDGNRODOC AND COBRANZA.SDGCOD=4 AND COBRANZA.MDGSERDOC=". $_SESSION['OFICOD'].$_SESSION['OFIAGECOD'];
                        }else{
                            if($estado_financiamiento =='PAG'){
                                $consulta = "SELECT CRED.CREDSTATUS, CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, 
                            CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC 
                            WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS TITULAR , (SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS ESTADO  , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS ESTADO_EXTORNO , (SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR 
                       FROM PRDDBFCOMERCIAL.CREDIT CRED , PRDDBFCOMERCIAL.AMORTIZA AMORTI , PRDRECAUDACIONORA12C.MDOCGLB COBRANZA
                       WHERE  CRED.CREDSTATUS != 'A' AND CRED.AGENCI_OFIAGECOD = ".$_SESSION['OFIAGECOD']." AND CRED.AGENCI_OFICIN_OFICOD = ". $_SESSION['OFICOD'] ." AND  CREDTIPO = '".$tipo."' AND  
                              CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY') AND AMORTI.CREDIT_CREDNRO = CRED.CREDNRO 
                              AND AMORTI.AMONRO=COBRANZA.MDGNRODOC AND COBRANZA.SDGCOD=2 AND COBRANZA.MDGSERDOC=". $_SESSION['OFICOD'].$_SESSION['OFIAGECOD'];
                            }
                        }
                    }
                }
            }else{
                if($concepto_redondeo == 1){
                    /*if($fina_anulado==1){
                        if($concep_847 == 1){
                            $consulta = "SELECT CRED.CREDSTATUS, CRED.CREREFDOC, CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS TITULAR  , (SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO ,(SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO_EXTORNO , (SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR FROM PRDDBFCOMERCIAL.CREDIT CRED WHERE CRED.AGENCI_OFIAGECOD = ".$_SESSION['OFIAGECOD']." AND CRED.AGENCI_OFICIN_OFICOD =". $_SESSION['OFICOD'] ." AND  CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                        }else{
                            $consulta = "SELECT CRED.CREDSTATUS, CRED.CREREFDOC, CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS TITULAR  , (SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO_EXTORNO , (SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR FROM PRDDBFCOMERCIAL.CREDIT CRED WHERE CRED.CONCEP_FACCONCOD != 847 AND CRED.AGENCI_OFIAGECOD = ".$_SESSION['OFIAGECOD']." AND CRED.AGENCI_OFICIN_OFICOD =". $_SESSION['OFICOD'] ." AND  CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                        }
                        
                    }else{
                        if($concep_847 == 1){
                            $consulta = "SELECT CRED.CREDSTATUS,  CRED.CREREFDOC,  CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS TITULAR  , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO_EXTORNO ,(SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO ,  (SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR FROM PRDDBFCOMERCIAL.CREDIT CRED WHERE  CRED.CREDSTATUS !='A' AND  CRED.AGENCI_OFIAGECOD = ".$_SESSION['OFIAGECOD']." AND CRED.AGENCI_OFICIN_OFICOD =". $_SESSION['OFICOD'] ." AND  CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                        }else{
                            $consulta = "SELECT CRED.CREDSTATUS, CRED.CREREFDOC,  CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS TITULAR  , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO_EXTORNO ,(SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO ,  (SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR FROM PRDDBFCOMERCIAL.CREDIT CRED WHERE CRED.CONCEP_FACCONCOD != 847 AND  CRED.CREDSTATUS !='A' AND  CRED.AGENCI_OFIAGECOD = ".$_SESSION['OFIAGECOD']." AND CRED.AGENCI_OFICIN_OFICOD =". $_SESSION['OFICOD'] ." AND  CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                        }
                        
                    }*/
                    
                }else{
                    if($fina_anulado==1){
                        if($concep_847 == 1){
                            $consulta = "SELECT CRED.CREDSTATUS, CRED.CREREFDOC,  CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS TITULAR  , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO_EXTORNO ,(SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO ,  (SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR FROM PRDDBFCOMERCIAL.CREDIT CRED WHERE  (CRED.CONCEP_FACCONCOD != 939 AND  CRED.CONCEP_FACCONCOD != 940 AND CRED.CONCEP_FACCONCOD != 837 )  AND  CRED.AGENCI_OFIAGECOD = ".$_SESSION['OFIAGECOD']." AND CRED.AGENCI_OFICIN_OFICOD =". $_SESSION['OFICOD'] ." AND  CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                        }else{
                            $consulta = "SELECT CRED.CREDSTATUS, CRED.CREREFDOC, CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS TITULAR   , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO_EXTORNO  ,(SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO ,   (SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR FROM PRDDBFCOMERCIAL.CREDIT CRED WHERE CRED.CONCEP_FACCONCOD != 847 AND  (CRED.CONCEP_FACCONCOD != 939 AND  CRED.CONCEP_FACCONCOD != 940 AND CRED.CONCEP_FACCONCOD != 837 )  AND  CRED.AGENCI_OFIAGECOD = ".$_SESSION['OFIAGECOD']." AND CRED.AGENCI_OFICIN_OFICOD =". $_SESSION['OFICOD'] ." AND  CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                        }
                        
                    }else{
                        if($concep_847 == 1){
                            $consulta = "SELECT CRED.CREDSTATUS, CRED.CREREFDOC, CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS TITULAR  ,(SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO  , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO_EXTORNO ,  (SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR FROM PRDDBFCOMERCIAL.CREDIT CRED WHERE CRED.CREDSTATUS !='A' AND  (CRED.CONCEP_FACCONCOD != 939 AND  CRED.CONCEP_FACCONCOD != 940 AND CRED.CONCEP_FACCONCOD != 837 )  AND  CRED.AGENCI_OFIAGECOD = ".$_SESSION['OFIAGECOD']." AND CRED.AGENCI_OFICIN_OFICOD =". $_SESSION['OFICOD'] ." AND  CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                        }else{
                            $consulta = "SELECT CRED.CREDSTATUS, CRED.CREREFDOC, CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS TITULAR  ,(SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO  , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO_EXTORNO , (SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR FROM PRDDBFCOMERCIAL.CREDIT CRED WHERE CRED.CONCEP_FACCONCOD != 847 AND  CRED.CREDSTATUS !='A' AND  (CRED.CONCEP_FACCONCOD != 939 AND  CRED.CONCEP_FACCONCOD != 940 AND CRED.CONCEP_FACCONCOD != 837 )  AND  CRED.AGENCI_OFIAGECOD = ".$_SESSION['OFIAGECOD']." AND CRED.AGENCI_OFICIN_OFICOD =". $_SESSION['OFICOD'] ." AND  CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                        }
                        
                    }
                    
                }
            }
        }else{
            if($tipo == 'Z'){
                if($estado_financiamiento =='T'){
                    $consulta = "SELECT CRED.CREDSTATUS,  CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , 
                                    (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS TITULAR , (SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS ESTADO , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS ESTADO_EXTORNO ,  (SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR 
                                    FROM PRDDBFCOMERCIAL.CREDIT CRED 
                                    WHERE   CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                }else{
                    if($estado_financiamiento =='ANU'){
                        $consulta = "SELECT CRED.CREDSTATUS,  CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , 
                        (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS TITULAR , (SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS ESTADO , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS ESTADO_EXTORNO ,(SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR 
                        FROM PRDDBFCOMERCIAL.CREDIT CRED 
                        WHERE CRED.CREDSTATUS ='A' AND  CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                    }else{
                        if($estado_financiamiento =='IM'){
                            $consulta = "SELECT CRED.CREDSTATUS, CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, 
                            CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC 
                            WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS TITULAR , (SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO  AND CLICODFAC= CRED.CLIUNICOD) AS ESTADO , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS ESTADO_EXTORNO , (SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR 
                       FROM PRDDBFCOMERCIAL.CREDIT CRED , PRDDBFCOMERCIAL.AMORTIZA AMORTI , PRDRECAUDACIONORA12C.MDOCGLB COBRANZA
                       WHERE   CRED.AGENCI_OFIAGECOD = ".$_SESSION['OFIAGECOD']." AND CRED.AGENCI_OFICIN_OFICOD = ". $_SESSION['OFICOD'] ." AND  CREDTIPO = '".$tipo."' AND  
                              CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY') AND AMORTI.CREDIT_CREDNRO = CRED.CREDNRO 
                              AND AMORTI.AMONRO=COBRANZA.MDGNRODOC AND COBRANZA.SDGCOD=4 ";
                        }else{
                            //var_dump("entre");
                            if($estado_financiamiento =='PAG'){
                                $consulta = "SELECT DISTINCT CRED.CREDSTATUS, CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, 
                            CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC 
                            WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS TITULAR , (SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS ESTADO , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO AND CLICODFAC= CRED.CLIUNICOD ) AS ESTADO_EXTORNO , (SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR 
                       FROM PRDDBFCOMERCIAL.CREDIT CRED , PRDDBFCOMERCIAL.AMORTIZA AMORTI , PRDRECAUDACIONORA12C.MDOCGLB COBRANZA
                       WHERE  CRED.CREDSTATUS != 'A'  AND  CRED.CREDTIPO = '".$tipo."' AND  
                              CRED.CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY') AND AMORTI.CREDIT_CREDNRO = CRED.CREDNRO 
                              AND AMORTI.AMONRO=COBRANZA.MDGNRODOC AND COBRANZA.SDGCOD=2 ORDER BY CRED.CREDFECHA";
                            }
                        }
                    }
                }
            }else{
                if($concepto_redondeo == 1){
                    /*if($fina_anulado==1){
                        if($concep_847 == 1){
                            $consulta = "SELECT CRED.CREDSTATUS, CRED.CREREFDOC, CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS TITULAR , (SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO_EXTORNO ,(SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR FROM PRDDBFCOMERCIAL.CREDIT CRED WHERE  CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                        }else{
                            $consulta = "SELECT CRED.CREDSTATUS, CRED.CREREFDOC,  CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS TITULAR  , (SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO_EXTORNO  ,(SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR FROM PRDDBFCOMERCIAL.CREDIT CRED WHERE CRED.CONCEP_FACCONCOD != 847 AND CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                        }
                        
                    }else{
                        if($concep_847 == 1){
                            $consulta = "SELECT CRED.CREDSTATUS, CRED.CREREFDOC,  CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS TITULAR , (SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO_EXTORNO  , (SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR FROM PRDDBFCOMERCIAL.CREDIT CRED WHERE  CRED.CREDSTATUS !='A' AND  CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                        }else{
                            $consulta = "SELECT CRED.CREDSTATUS, CRED.CREREFDOC,  CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS TITULAR , (SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO_EXTORNO  ,  (SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR FROM PRDDBFCOMERCIAL.CREDIT CRED WHERE CRED.CONCEP_FACCONCOD != 847 AND  CRED.CREDSTATUS !='A' AND CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                        }
                        
                    }*/
                    
                }else{
                    if($fina_anulado==1){
                        if($concep_847 == 1){
                            $consulta = "SELECT CRED.CREDSTATUS, CRED.CREREFDOC, CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS TITULAR , (SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO_EXTORNO , (SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR FROM PRDDBFCOMERCIAL.CREDIT CRED WHERE  (CRED.CONCEP_FACCONCOD != 939 AND  CRED.CONCEP_FACCONCOD != 940 AND CRED.CONCEP_FACCONCOD != 837 )  AND  CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                        }else{
                            $consulta = "SELECT CRED.CREDSTATUS, CRED.CREREFDOC, CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS TITULAR , (SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO_EXTORNO ,(SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR FROM PRDDBFCOMERCIAL.CREDIT CRED WHERE CRED.CONCEP_FACCONCOD != 847 AND  (CRED.CONCEP_FACCONCOD != 939 AND  CRED.CONCEP_FACCONCOD != 940 AND CRED.CONCEP_FACCONCOD != 837)  AND CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                        }
                        
                    }else{
                        if( $concep_847 == 1){
                            $consulta = "SELECT CRED.CREDSTATUS, CRED.CREREFDOC, CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS TITULAR , (SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO_EXTORNO  ,(SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR FROM PRDDBFCOMERCIAL.CREDIT CRED WHERE CRED.CREDSTATUS !='A' AND  (CRED.CONCEP_FACCONCOD != 939 AND  CRED.CONCEP_FACCONCOD != 940 AND CRED.CONCEP_FACCONCOD != 837 )  AND CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                        }else{
                            $consulta = "SELECT CRED.CREDSTATUS, CRED.CREREFDOC, CRED.AGENCI_OFICIN_OFICOD, CRED.AGENCI_OFIAGECOD , CRED.CREDTIPO ,CRED.CONCEP_FACCONCOD,   CRED.CLIUNICOD, CRED.CREDFECHA, CRED.CREDNRO, CRED.CTAINICIAL,(CRED.DEUDATOTAL - CRED.CTAINICIAL) AS SALDO  ,  CRED.DEUDATOTAL, CRED.NROLTS  , (SELECT SOLICINOM from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS TITULAR , (SELECT EST_PAGO from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO , (SELECT ESTADOACTA from PRDDBFCOMERCIAL.DEUDAREC WHERE CREDNRO = CRED.CREDNRO ) AS ESTADO_EXTORNO  ,(SELECT NNOMBRE FROM PRDDBFCOMERCIAL.NUSERS WHERE NCODIGO=CRED.DIGCOD ) AS OPERADOR FROM PRDDBFCOMERCIAL.CREDIT CRED WHERE CRED.CONCEP_FACCONCOD != 847 AND  CRED.CREDSTATUS !='A' AND  (CRED.CONCEP_FACCONCOD != 939 AND  CRED.CONCEP_FACCONCOD != 940  AND CRED.CONCEP_FACCONCOD != 837)  AND CREDTIPO = '".$tipo."' AND  CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')";
                        }
                    }
                }
            }
        }
        
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }

    public function get_ncaconv($oficina, $agencia, $credito, $serie, $numero ){
        $consulta = "SELECT NCATOTDIF FROM PRDDBFCOMERCIAL.NCACONV WHERE NOFICOD = ".$oficina." AND NOFIAGECO = ".$agencia." AND NCREDNRO = ".$credito." AND NCAFACSERN = ".$serie." AND NCAFACNRO = ". $numero ;
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }

    public function get_fecha_12meses($suministro){
        $consulta = "SELECT count(*) as numeros FROM PRDDBFCOMERCIAL.CREDIT WHERE  CLIUNICOD = '".$suministro."' AND CONCEP_FACCONCOD=700 AND NROLTS=3 AND CREDFECHA between to_char(add_months(sysdate,-12), 'DD/MM/YYYY') AND to_char(sysdate, 'DD/MM/YYYY')";
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }

    public function get_creditos_recibos($fecha_inicio, $fecha_fin){
        $consulta = "SELECT CREDNRO, CLIUNICOD, CREDFECHA, DEUDATOTAL, CTAINICIAL, NROLTS, AGENCI_OFICIN_OFICOD , AGENCI_OFIAGECOD FROM PRDDBFCOMERCIAL.CREDIT WHERE CONCEP_FACCONCOD=700 AND CREDSTATUS != 'A'   AND   CREDFECHA between to_date('".$fecha_inicio."', 'DD/MM/YYYY') AND to_date('".$fecha_fin."', 'DD/MM/YYYY')  ";
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }

    public function Get_nombre_catastral($suministro){
        if(strlen($suministro) ==7){
            $grupo = substr($suministro, 0,3);
            $subGrupo = substr($suministro, 3,strlen($suministro));
            $consulta = "SELECT CLINOMBRE FROM PRDCOMCATMEDLEC.PROPIE WHERE CLICODFAC = '".$grupo."0000".$subGrupo."'";
        }else{
            $consulta = "SELECT CLINOMBRE FROM PRDCOMCATMEDLEC.PROPIE WHERE CLICODFAC = '".$suministro."'";
        }
        
        
        $query = $this->oracle->query($consulta);
        return $query->result_array();
    }
}
?>